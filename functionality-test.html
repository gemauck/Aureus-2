<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Functionality Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Load all required utilities and components -->
    <script type="text/babel" src="./src/utils/api.js"></script>
    <script type="text/babel" src="./src/utils/authStorage.js"></script>
    <script type="text/babel" src="./src/utils/databaseAPI.js"></script>
    <script type="text/babel" src="./src/components/clients/ClientsDatabaseFirst.jsx"></script>
    <script type="text/babel" src="./src/components/projects/ProjectsDatabaseFirst.jsx"></script>
    <script type="text/babel" src="./src/components/invoicing/InvoicingDatabaseFirst.jsx"></script>
    <script type="text/babel" src="./src/components/time/TimeTrackingDatabaseFirst.jsx"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const FunctionalityTest = () => {
            const [testResults, setTestResults] = useState([]);
            const [isRunning, setIsRunning] = useState(false);

            const addTestResult = (test, status, message) => {
                setTestResults(prev => [...prev, { 
                    test, 
                    status, 
                    message, 
                    timestamp: new Date().toLocaleTimeString() 
                }]);
            };

            const runFunctionalityTest = async () => {
                setIsRunning(true);
                setTestResults([]);

                try {
                    // Test 1: Check if components are loaded
                    addTestResult('Component Loading', 'info', 'Checking if database-first components are loaded...');
                    
                    const components = {
                        'ClientsDatabaseFirst': window.ClientsDatabaseFirst,
                        'ProjectsDatabaseFirst': window.ProjectsDatabaseFirst,
                        'InvoicingDatabaseFirst': window.InvoicingDatabaseFirst,
                        'TimeTrackingDatabaseFirst': window.TimeTrackingDatabaseFirst,
                        'DatabaseAPI': window.DatabaseAPI,
                        'AuthStorage': window.storage
                    };

                    Object.entries(components).forEach(([name, component]) => {
                        if (component) {
                            addTestResult('Component Loading', 'success', `${name} component loaded successfully`);
                        } else {
                            addTestResult('Component Loading', 'error', `${name} component not found`);
                        }
                    });

                    // Test 2: Test authentication
                    addTestResult('Authentication', 'info', 'Testing authentication system...');
                    
                    try {
                        const loginResponse = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: 'admin@abcotronics.com', password: 'admin123' })
                        });
                        
                        if (loginResponse.ok) {
                            const loginData = await loginResponse.json();
                            addTestResult('Authentication', 'success', 'Login successful');
                            
                            // Test token storage
                            if (window.storage) {
                                window.storage.setToken(loginData.accessToken);
                                window.storage.setUser(loginData.user);
                                addTestResult('Authentication', 'success', 'Token storage working');
                            } else {
                                addTestResult('Authentication', 'error', 'Token storage not available');
                            }
                        } else {
                            addTestResult('Authentication', 'error', 'Login failed');
                        }
                    } catch (error) {
                        addTestResult('Authentication', 'error', `Authentication error: ${error.message}`);
                    }

                    // Test 3: Test DatabaseAPI functionality
                    addTestResult('Database API', 'info', 'Testing DatabaseAPI functionality...');
                    
                    if (window.DatabaseAPI) {
                        try {
                            // Test clients API
                            const clientsResponse = await window.DatabaseAPI.getClients();
                            addTestResult('Database API', 'success', 'Clients API working');
                            
                            // Test leads API
                            const leadsResponse = await window.DatabaseAPI.getLeads();
                            addTestResult('Database API', 'success', 'Leads API working');
                            
                            // Test projects API
                            const projectsResponse = await window.DatabaseAPI.getProjects();
                            addTestResult('Database API', 'success', 'Projects API working');
                            
                        } catch (error) {
                            addTestResult('Database API', 'error', `DatabaseAPI error: ${error.message}`);
                        }
                    } else {
                        addTestResult('Database API', 'error', 'DatabaseAPI not available');
                    }

                    // Test 4: Test component rendering
                    addTestResult('Component Rendering', 'info', 'Testing component rendering...');
                    
                    const testDiv = document.createElement('div');
                    testDiv.style.display = 'none';
                    document.body.appendChild(testDiv);

                    try {
                        if (window.ClientsDatabaseFirst) {
                            ReactDOM.render(React.createElement(window.ClientsDatabaseFirst), testDiv);
                            addTestResult('Component Rendering', 'success', 'ClientsDatabaseFirst renders successfully');
                            ReactDOM.unmountComponentAtNode(testDiv);
                        }
                        
                        if (window.ProjectsDatabaseFirst) {
                            ReactDOM.render(React.createElement(window.ProjectsDatabaseFirst), testDiv);
                            addTestResult('Component Rendering', 'success', 'ProjectsDatabaseFirst renders successfully');
                            ReactDOM.unmountComponentAtNode(testDiv);
                        }
                        
                        if (window.InvoicingDatabaseFirst) {
                            ReactDOM.render(React.createElement(window.InvoicingDatabaseFirst), testDiv);
                            addTestResult('Component Rendering', 'success', 'InvoicingDatabaseFirst renders successfully');
                            ReactDOM.unmountComponentAtNode(testDiv);
                        }
                        
                        if (window.TimeTrackingDatabaseFirst) {
                            ReactDOM.render(React.createElement(window.TimeTrackingDatabaseFirst), testDiv);
                            addTestResult('Component Rendering', 'success', 'TimeTrackingDatabaseFirst renders successfully');
                            ReactDOM.unmountComponentAtNode(testDiv);
                        }
                        
                    } catch (error) {
                        addTestResult('Component Rendering', 'error', `Component rendering error: ${error.message}`);
                    } finally {
                        document.body.removeChild(testDiv);
                    }

                    // Test 5: Test data operations
                    addTestResult('Data Operations', 'info', 'Testing data operations...');
                    
                    if (window.DatabaseAPI) {
                        try {
                            // Test creating a client
                            const testClient = {
                                name: 'Test Client',
                                industry: 'Technology',
                                status: 'Active'
                            };
                            
                            const createResponse = await window.DatabaseAPI.createClient(testClient);
                            addTestResult('Data Operations', 'success', 'Client creation working');
                            
                            // Test creating a lead
                            const testLead = {
                                name: 'Test Lead',
                                industry: 'Healthcare',
                                status: 'New'
                            };
                            
                            const createLeadResponse = await window.DatabaseAPI.createLead(testLead);
                            addTestResult('Data Operations', 'success', 'Lead creation working');
                            
                        } catch (error) {
                            addTestResult('Data Operations', 'error', `Data operations error: ${error.message}`);
                        }
                    }

                    addTestResult('Functionality Test', 'success', 'All functionality tests completed!');

                } catch (error) {
                    addTestResult('Functionality Test', 'error', `Test failed: ${error.message}`);
                } finally {
                    setIsRunning(false);
                }
            };

            const getStatusIcon = (status) => {
                switch (status) {
                    case 'success': return '✅';
                    case 'error': return '❌';
                    case 'info': return 'ℹ️';
                    default: return '⏳';
                }
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'success': return 'bg-green-100 text-green-800';
                    case 'error': return 'bg-red-100 text-red-800';
                    case 'info': return 'bg-blue-100 text-blue-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            const successCount = testResults.filter(r => r.status === 'success').length;
            const errorCount = testResults.filter(r => r.status === 'error').length;
            const totalCount = testResults.length;

            return (
                <div className="min-h-screen bg-gray-100 py-8">
                    <div className="max-w-4xl mx-auto px-4">
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h1 className="text-3xl font-bold text-gray-900 mb-6">
                                🔧 ERP System Functionality Test
                            </h1>
                            
                            <p className="text-gray-600 mb-6">
                                This test verifies that all database-first components and functionality are working correctly.
                            </p>

                            <div className="grid grid-cols-3 gap-4 mb-6">
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div className="text-2xl font-bold text-green-600">{successCount}</div>
                                    <div className="text-sm text-green-800">Passed</div>
                                </div>
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <div className="text-2xl font-bold text-red-600">{errorCount}</div>
                                    <div className="text-sm text-red-800">Failed</div>
                                </div>
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div className="text-2xl font-bold text-blue-600">{totalCount}</div>
                                    <div className="text-sm text-blue-800">Total</div>
                                </div>
                            </div>

                            <button
                                onClick={runFunctionalityTest}
                                disabled={isRunning}
                                className={`px-6 py-3 rounded-lg font-medium mb-6 ${
                                    isRunning
                                        ? 'bg-gray-400 text-gray-600 cursor-not-allowed'
                                        : 'bg-blue-600 text-white hover:bg-blue-700'
                                }`}
                            >
                                {isRunning ? (
                                    <>
                                        <i className="fas fa-spinner fa-spin mr-2"></i>
                                        Running Tests...
                                    </>
                                ) : (
                                    <>
                                        <i className="fas fa-play mr-2"></i>
                                        Run Functionality Test
                                    </>
                                )}
                            </button>

                            {testResults.length > 0 && (
                                <div className="space-y-2">
                                    {testResults.map((result, index) => (
                                        <div key={index} className={`p-3 rounded-lg ${getStatusColor(result.status)}`}>
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center space-x-2">
                                                    <span>{getStatusIcon(result.status)}</span>
                                                    <span className="font-medium">{result.test}</span>
                                                </div>
                                                <span className="text-sm opacity-75">{result.timestamp}</span>
                                            </div>
                                            <div className="text-sm mt-1">{result.message}</div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            <div className="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <h3 className="font-semibold text-yellow-800 mb-2">Test Information:</h3>
                                <ul className="text-yellow-700 text-sm space-y-1">
                                    <li>• Tests component loading and availability</li>
                                    <li>• Verifies authentication system functionality</li>
                                    <li>• Checks DatabaseAPI operations</li>
                                    <li>• Tests component rendering capabilities</li>
                                    <li>• Validates data operations (create, read, update)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<FunctionalityTest />, document.getElementById('root'));
    </script>
</body>
</html>
