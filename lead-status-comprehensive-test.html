<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Status Comprehensive Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Load required utilities -->
    <script src="src/utils/localStorage.js"></script>
    <script src="src/utils/databaseAPI.js"></script>
    
    <!-- Load the Clients component -->
    <script src="src/components/clients/Clients.jsx" type="text/babel"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const LeadStatusComprehensiveTest = () => {
            const [testResults, setTestResults] = useState([]);
            const [isRunning, setIsRunning] = useState(false);
            const [mockLeads, setMockLeads] = useState([]);
            const [debugLogs, setDebugLogs] = useState([]);

            const addDebugLog = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                setDebugLogs(prev => [...prev, { message, type, timestamp }]);
                console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            };

            const addTestResult = (test, status, message) => {
                setTestResults(prev => [...prev, { test, status, message, timestamp: new Date().toISOString() }]);
            };

            // Create mock leads for testing
            useEffect(() => {
                const mockLeadsData = [
                    {
                        id: 'test-lead-1',
                        name: 'Test Lead 1',
                        industry: 'Technology',
                        status: 'Potential',
                        stage: 'Awareness',
                        contacts: [{ name: 'John Doe', email: 'john@test.com' }],
                        firstContactDate: new Date().toISOString().split('T')[0]
                    },
                    {
                        id: 'test-lead-2',
                        name: 'Test Lead 2',
                        industry: 'Manufacturing',
                        status: 'Active',
                        stage: 'Interest',
                        contacts: [{ name: 'Jane Smith', email: 'jane@test.com' }],
                        firstContactDate: new Date().toISOString().split('T')[0]
                    }
                ];
                setMockLeads(mockLeadsData);
                addDebugLog('Mock leads created for testing');
            }, []);

            // Test the actual handleLeadStatusChange function behavior
            const testStatusChangeFunction = async () => {
                addDebugLog('Testing handleLeadStatusChange function behavior...');
                
                try {
                    // Simulate the function behavior from Clients.jsx
                    const mockHandleLeadStatusChange = async (leadId, newStatus) => {
                        console.log('ðŸ”„ handleLeadStatusChange called:', { leadId, newStatus, currentLeads: mockLeads.length });
                        
                        try {
                            const token = window.storage?.getToken?.();
                            const leadToUpdate = mockLeads.find(l => l.id === leadId);
                            
                            console.log('ðŸ” Lead lookup result:', { 
                                leadId, 
                                found: !!leadToUpdate, 
                                currentStatus: leadToUpdate?.status,
                                newStatus,
                                tokenPresent: !!token,
                                hasApi: !!window.api?.updateLead
                            });
                            
                            if (!leadToUpdate) {
                                throw new Error('Lead not found for status update: ' + leadId);
                            }

                            console.log('ðŸ”„ Updating local state...');
                            // Update local state immediately for responsive UI
                            const updatedLeads = mockLeads.map(l => l.id === leadId ? { ...l, status: newStatus } : l);
                            setMockLeads(updatedLeads);
                            console.log('âœ… Local state updated');

                            // Persist to database via API
                            if (token && window.api?.updateLead) {
                                try {
                                    console.log('ðŸŒ Calling API to update lead status:', leadId, newStatus);
                                    const updatedLead = { ...leadToUpdate, status: newStatus };
                                    console.log('ðŸ“¤ Sending to API:', { id: leadId, leadData: updatedLead });
                                    
                                    const apiResponse = await window.api.updateLead(leadId, updatedLead);
                                    console.log('ðŸ“¥ API Response:', apiResponse);
                                    
                                    const updatedLeadFromAPI = apiResponse?.data?.lead || apiResponse?.lead || apiResponse;
                                    
                                    if (updatedLeadFromAPI && updatedLeadFromAPI.id) {
                                        console.log('ðŸ”„ Updating with API response data...');
                                        // Update with the response from API to ensure consistency
                                        const finalUpdatedLeads = mockLeads.map(l => l.id === leadId ? updatedLeadFromAPI : l);
                                        setMockLeads(finalUpdatedLeads);
                                        console.log('âœ… Lead status updated in database and UI refreshed');
                                        return true;
                                    } else {
                                        console.warn('âš ï¸ API response did not contain expected lead data');
                                        return true; // Still successful from user perspective
                                    }
                                } catch (apiError) {
                                    console.error('âŒ API error updating lead status:', apiError);
                                    // Status change was already applied locally, so user experience is maintained
                                    return true;
                                }
                            } else {
                                console.log('âœ… Lead status updated locally (no authentication or API)');
                                return true;
                            }
                        } catch (error) {
                            console.error('âŒ Error updating lead status:', error);
                            return false;
                        }
                    };

                    // Test the function
                    const testLeadId = 'test-lead-1';
                    const originalStatus = mockLeads[0].status;
                    const newStatus = originalStatus === 'Potential' ? 'Active' : 'Potential';
                    
                    addDebugLog(`Testing status change from '${originalStatus}' to '${newStatus}'`);
                    
                    const result = await mockHandleLeadStatusChange(testLeadId, newStatus);
                    
                    if (result) {
                        addTestResult('Status Change Function', 'success', `Successfully changed status from '${originalStatus}' to '${newStatus}'`);
                    } else {
                        addTestResult('Status Change Function', 'error', 'Status change function failed');
                    }
                    
                } catch (error) {
                    addDebugLog(`Status change test failed: ${error.message}`, 'error');
                    addTestResult('Status Change Function', 'error', `Test failed: ${error.message}`);
                }
            };

            // Test API connectivity and response format
            const testApiConnectivity = async () => {
                addDebugLog('Testing API connectivity...');
                
                try {
                    // Test basic API endpoint
                    const response = await fetch('/api/leads');
                    addDebugLog(`API response status: ${response.status}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        addDebugLog(`API returned ${data.leads?.length || 0} leads`);
                        addTestResult('API Connectivity', 'success', `API is accessible and returned ${data.leads?.length || 0} leads`);
                    } else {
                        const text = await response.text();
                        addDebugLog(`API error response: ${text}`, 'error');
                        addTestResult('API Connectivity', 'error', `API returned status ${response.status}`);
                    }
                } catch (error) {
                    addDebugLog(`API connectivity test failed: ${error.message}`, 'error');
                    addTestResult('API Connectivity', 'error', `API connectivity failed: ${error.message}`);
                }
            };

            // Test authentication
            const testAuthentication = () => {
                addDebugLog('Testing authentication...');
                
                const token = window.storage?.getToken?.();
                if (token) {
                    addDebugLog(`Authentication token present: ${token.substring(0, 20)}...`);
                    addTestResult('Authentication', 'success', 'Authentication token is present');
                } else {
                    addDebugLog('No authentication token found', 'warning');
                    addTestResult('Authentication', 'warning', 'No authentication token found');
                }
            };

            // Test API methods availability
            const testApiMethods = () => {
                addDebugLog('Testing API methods availability...');
                
                const apiMethods = {
                    hasApi: !!window.api,
                    hasUpdateLead: !!window.api?.updateLead,
                    hasGetLeads: !!window.api?.getLeads,
                    hasCreateLead: !!window.api?.createLead,
                    hasDeleteLead: !!window.api?.deleteLead
                };
                
                addDebugLog(`API methods: ${JSON.stringify(apiMethods)}`);
                
                if (apiMethods.hasApi && apiMethods.hasUpdateLead) {
                    addTestResult('API Methods', 'success', 'All required API methods are available');
                } else {
                    addTestResult('API Methods', 'error', `Missing API methods: ${JSON.stringify(apiMethods)}`);
                }
            };

            // Test data mapping
            const testDataMapping = () => {
                addDebugLog('Testing data mapping...');
                
                // Simulate database response format
                const mockDbLead = {
                    id: 'db-lead-1',
                    name: 'Database Lead',
                    industry: 'Technology',
                    status: 'Potential',
                    stage: 'Awareness',
                    source: 'Website',
                    value: 10000,
                    probability: 25,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    contacts: '[]',
                    followUps: '[]',
                    comments: '[]',
                    activityLog: '[]',
                    billingTerms: '{}'
                };
                
                // Test the mapping logic from loadLeads
                const mappedLead = {
                    id: mockDbLead.id,
                    name: mockDbLead.name || '',
                    industry: mockDbLead.industry || 'Other',
                    status: mockDbLead.status || 'Potential',
                    stage: mockDbLead.stage || 'Awareness',
                    source: mockDbLead.source || 'Website',
                    value: mockDbLead.value || mockDbLead.revenue || 0,
                    probability: mockDbLead.probability || 0,
                    firstContactDate: mockDbLead.firstContactDate || mockDbLead.createdAt ? new Date(mockDbLead.createdAt).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                    lastContact: mockDbLead.lastContact || mockDbLead.updatedAt ? new Date(mockDbLead.updatedAt).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                    address: mockDbLead.address || '',
                    website: mockDbLead.website || '',
                    notes: mockDbLead.notes || '',
                    contacts: typeof mockDbLead.contacts === 'string' ? JSON.parse(mockDbLead.contacts || '[]') : (mockDbLead.contacts || []),
                    followUps: typeof mockDbLead.followUps === 'string' ? JSON.parse(mockDbLead.followUps || '[]') : (mockDbLead.followUps || []),
                    projectIds: typeof mockDbLead.projectIds === 'string' ? JSON.parse(mockDbLead.projectIds || '[]') : (mockDbLead.projectIds || []),
                    comments: typeof mockDbLead.comments === 'string' ? JSON.parse(mockDbLead.comments || '[]') : (mockDbLead.comments || []),
                    activityLog: typeof mockDbLead.activityLog === 'string' ? JSON.parse(mockDbLead.activityLog || '[]') : (mockDbLead.activityLog || []),
                    billingTerms: typeof mockDbLead.billingTerms === 'string' ? JSON.parse(mockDbLead.billingTerms || '{}') : (mockDbLead.billingTerms || {
                        paymentTerms: 'Net 30',
                        billingFrequency: 'Monthly',
                        currency: 'ZAR',
                        retainerAmount: 0,
                        taxExempt: false,
                        notes: ''
                    }),
                    type: mockDbLead.type || 'lead',
                    ownerId: mockDbLead.ownerId || null,
                    createdAt: mockDbLead.createdAt,
                    updatedAt: mockDbLead.updatedAt
                };
                
                addDebugLog(`Mapped lead: ${JSON.stringify(mappedLead, null, 2)}`);
                
                if (mappedLead.id && mappedLead.name && mappedLead.status) {
                    addTestResult('Data Mapping', 'success', 'Data mapping is working correctly');
                } else {
                    addTestResult('Data Mapping', 'error', 'Data mapping failed');
                }
            };

            // Test UI responsiveness
            const testUIResponsiveness = () => {
                addDebugLog('Testing UI responsiveness...');
                
                const startTime = Date.now();
                
                // Simulate immediate UI update
                const updatedLeads = mockLeads.map(l => 
                    l.id === 'test-lead-1' ? { ...l, status: 'Active' } : l
                );
                setMockLeads(updatedLeads);
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                addDebugLog(`UI update completed in ${responseTime}ms`);
                
                if (responseTime < 50) {
                    addTestResult('UI Responsiveness', 'success', `UI update completed in ${responseTime}ms - very responsive`);
                } else {
                    addTestResult('UI Responsiveness', 'warning', `UI update took ${responseTime}ms - may be slow`);
                }
            };

            const runAllTests = async () => {
                setIsRunning(true);
                setTestResults([]);
                setDebugLogs([]);
                
                addDebugLog('Starting comprehensive lead status testing...');
                
                // Run all tests
                testAuthentication();
                testApiMethods();
                await testApiConnectivity();
                testDataMapping();
                testUIResponsiveness();
                await testStatusChangeFunction();
                
                setIsRunning(false);
                addDebugLog('All tests completed');
            };

            const clearResults = () => {
                setTestResults([]);
                setDebugLogs([]);
            };

            const getLogColor = (type) => {
                switch (type) {
                    case 'error': return 'text-red-600 bg-red-100 border-red-200';
                    case 'warning': return 'text-yellow-600 bg-yellow-100 border-yellow-200';
                    case 'success': return 'text-green-600 bg-green-100 border-green-200';
                    default: return 'text-blue-600 bg-blue-100 border-blue-200';
                }
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'success': return 'text-green-600 bg-green-100';
                    case 'error': return 'text-red-600 bg-red-100';
                    case 'warning': return 'text-yellow-600 bg-yellow-100';
                    default: return 'text-blue-600 bg-blue-100';
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 py-8">
                    <div className="max-w-6xl mx-auto px-4">
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <div className="flex items-center justify-between mb-6">
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">Lead Status Comprehensive Test</h1>
                                    <p className="text-gray-600 mt-1">Testing the complete lead status functionality fix</p>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={clearResults}
                                        className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center"
                                    >
                                        <i className="fas fa-trash mr-2"></i>
                                        Clear Results
                                    </button>
                                    <button
                                        onClick={runAllTests}
                                        disabled={isRunning}
                                        className={`px-6 py-3 rounded-lg font-medium flex items-center ${
                                            isRunning 
                                                ? 'bg-gray-400 text-gray-700 cursor-not-allowed' 
                                                : 'bg-blue-600 text-white hover:bg-blue-700'
                                        }`}
                                    >
                                        {isRunning ? (
                                            <>
                                                <i className="fas fa-spinner fa-spin mr-2"></i>
                                                Running Tests...
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-play mr-2"></i>
                                                Run All Tests
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                {/* Test Results */}
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-900 mb-3">Test Results</h3>
                                    {testResults.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <i className="fas fa-clipboard-check text-3xl mb-2"></i>
                                            <p>No test results yet. Click "Run All Tests" to start.</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3 max-h-96 overflow-y-auto">
                                            {testResults.map((result, index) => (
                                                <div key={index} className={`p-4 rounded-lg border-l-4 ${
                                                    result.status === 'success' ? 'border-green-500 bg-green-50' :
                                                    result.status === 'error' ? 'border-red-500 bg-red-50' :
                                                    result.status === 'warning' ? 'border-yellow-500 bg-yellow-50' :
                                                    'border-blue-500 bg-blue-50'
                                                }`}>
                                                    <div className="flex items-start justify-between">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                <span className={`px-2 py-1 text-xs font-medium rounded ${getStatusColor(result.status)}`}>
                                                                    {result.status.toUpperCase()}
                                                                </span>
                                                                <span className="font-medium text-gray-900">{result.test}</span>
                                                            </div>
                                                            <p className="text-sm text-gray-700">{result.message}</p>
                                                        </div>
                                                        <span className="text-xs text-gray-500">
                                                            {new Date(result.timestamp).toLocaleTimeString()}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Debug Logs */}
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-900 mb-3">Debug Logs</h3>
                                    <div className="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto">
                                        {debugLogs.length === 0 ? (
                                            <div className="text-gray-500">No debug logs yet. Click "Run All Tests" to start.</div>
                                        ) : (
                                            debugLogs.map((log, index) => (
                                                <div key={index} className="mb-1">
                                                    <span className="text-gray-400">[{log.timestamp}]</span>{' '}
                                                    <span className={`${
                                                        log.type === 'error' ? 'text-red-400' :
                                                        log.type === 'warning' ? 'text-yellow-400' :
                                                        log.type === 'success' ? 'text-green-400' :
                                                        'text-blue-400'
                                                    }`}>
                                                        {log.type.toUpperCase()}:
                                                    </span>{' '}
                                                    <span className="text-white">{log.message}</span>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Mock Leads Display */}
                            <div className="mt-6">
                                <h3 className="text-lg font-semibold text-gray-900 mb-3">Mock Leads (for testing)</h3>
                                <div className="grid gap-4">
                                    {mockLeads.map(lead => (
                                        <div key={lead.id} className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <h4 className="font-medium text-gray-900">{lead.name}</h4>
                                                    <p className="text-sm text-gray-600">{lead.industry} â€¢ {lead.stage}</p>
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    <span className={`px-3 py-1 text-xs font-medium rounded-full ${
                                                        lead.status === 'Potential' ? 'bg-blue-100 text-blue-800' :
                                                        lead.status === 'Active' ? 'bg-green-100 text-green-800' :
                                                        'bg-gray-100 text-gray-800'
                                                    }`}>
                                                        Current: {lead.status}
                                                    </span>
                                                    <select
                                                        value={lead.status}
                                                        onChange={(e) => {
                                                            addDebugLog(`Manual status change to: ${e.target.value}`);
                                                            const updatedLeads = mockLeads.map(l => 
                                                                l.id === lead.id ? { ...l, status: e.target.value } : l
                                                            );
                                                            setMockLeads(updatedLeads);
                                                        }}
                                                        className="px-3 py-1 text-sm font-medium rounded border border-gray-300 bg-white text-gray-900"
                                                    >
                                                        <option>Potential</option>
                                                        <option>Active</option>
                                                        <option>Disinterested</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Summary */}
                            {testResults.length > 0 && (
                                <div className="mt-6 bg-gray-50 rounded-lg p-4">
                                    <h4 className="font-medium text-gray-900 mb-2">Test Summary</h4>
                                    <div className="grid grid-cols-4 gap-4 text-sm">
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-blue-600">
                                                {testResults.filter(r => r.status === 'success').length}
                                            </div>
                                            <div className="text-gray-600">Success</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-yellow-600">
                                                {testResults.filter(r => r.status === 'warning').length}
                                            </div>
                                            <div className="text-gray-600">Warning</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-red-600">
                                                {testResults.filter(r => r.status === 'error').length}
                                            </div>
                                            <div className="text-gray-600">Error</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-gray-600">
                                                {testResults.length}
                                            </div>
                                            <div className="text-gray-600">Total</div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<LeadStatusComprehensiveTest />, document.getElementById('root'));
    </script>
</body>
</html>
