<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opportunity Save Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input, select { padding: 8px; margin: 5px; width: 200px; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>ðŸ”§ Opportunity Save Debug Tool</h1>
    
    <div class="test-section info">
        <h3>Step 1: Check Environment</h3>
        <button onclick="checkEnvironment()">Check Environment</button>
        <div id="envResults" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Step 2: Authentication Test</h3>
        <div>
            <label>Email: <input type="email" id="email" value="admin@abcotronics.co.za"></label><br>
            <label>Password: <input type="password" id="password" value="admin123"></label><br>
            <button onclick="testAuthentication()">Test Login</button>
            <button onclick="checkToken()">Check Current Token</button>
        </div>
        <div id="authResults" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Step 3: API Availability Test</h3>
        <button onclick="testAPIAvailability()">Test API Methods</button>
        <div id="apiResults" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Step 4: Client Data Test</h3>
        <button onclick="testClientData()">Load Client Data</button>
        <div id="clientResults" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Step 5: Opportunity Creation Test</h3>
        <button onclick="testOpportunityCreation()">Test Opportunity Creation</button>
        <div id="opportunityResults" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Step 6: Full Debug Test</h3>
        <button onclick="runFullDebugTest()">Run Complete Debug Test</button>
        <div id="debugResults" class="log"></div>
    </div>

    <script>
        // Load required scripts
        const scripts = [
            '/src/utils/api.js',
            '/src/utils/authStorage.js'
        ];

        let loadedScripts = 0;
        scripts.forEach(src => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = () => {
                loadedScripts++;
                if (loadedScripts === scripts.length) {
                    logEnv('âœ… All required scripts loaded');
                }
            };
            script.onerror = () => {
                logEnv(`âŒ Failed to load script: ${src}`);
            };
            document.head.appendChild(script);
        });

        function logEnv(message) {
            const results = document.getElementById('envResults');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function logAuth(message) {
            const results = document.getElementById('authResults');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function logApi(message) {
            const results = document.getElementById('apiResults');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function logClient(message) {
            const results = document.getElementById('clientResults');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function logOpportunity(message) {
            const results = document.getElementById('opportunityResults');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        function logDebug(message) {
            const results = document.getElementById('debugResults');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }

        async function checkEnvironment() {
            logEnv('ðŸ” Checking environment...');
            
            // Check if scripts are loaded
            logEnv(`ðŸ“œ Scripts loaded: ${loadedScripts}/${scripts.length}`);
            
            // Check window objects
            logEnv(`ðŸŒ window.api available: ${!!window.api}`);
            logEnv(`ðŸŒ window.storage available: ${!!window.storage}`);
            
            if (window.api) {
                const apiMethods = Object.keys(window.api);
                logEnv(`ðŸ“¡ API methods available: ${apiMethods.length}`);
                logEnv(`ðŸ“¡ API methods: ${apiMethods.join(', ')}`);
            }
            
            if (window.storage) {
                const token = window.storage.getToken();
                logEnv(`ðŸ”‘ Current token: ${token ? token.substring(0, 20) + '...' : 'none'}`);
                
                const user = window.storage.getUser();
                logEnv(`ðŸ‘¤ Current user: ${user ? JSON.stringify(user) : 'none'}`);
            }
            
            // Check localStorage
            const localStorageKeys = Object.keys(localStorage);
            logEnv(`ðŸ’¾ localStorage keys: ${localStorageKeys.join(', ')}`);
        }

        async function testAuthentication() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            logAuth('ðŸ” Testing authentication...');
            
            if (!window.api) {
                logAuth('âŒ window.api not available');
                return;
            }

            try {
                logAuth(`ðŸ“¤ Attempting login for: ${email}`);
                const loginResult = await window.api.login(email, password);
                logAuth(`âœ… Login successful: ${JSON.stringify(loginResult)}`);
                
                // Test /me endpoint
                logAuth('ðŸ” Testing /me endpoint...');
                const meResult = await window.api.me();
                logAuth(`âœ… /me successful: ${JSON.stringify(meResult)}`);
                
            } catch (error) {
                logAuth(`âŒ Authentication failed: ${error.message}`);
                logAuth(`âŒ Error details: ${JSON.stringify(error)}`);
            }
        }

        async function checkToken() {
            logAuth('ðŸ” Checking current token...');
            
            if (!window.storage) {
                logAuth('âŒ window.storage not available');
                return;
            }

            const token = window.storage.getToken();
            if (token) {
                logAuth(`âœ… Token found: ${token.substring(0, 20)}...`);
                
                // Test token validity
                try {
                    const me = await window.api.me();
                    logAuth(`âœ… Token is valid: ${JSON.stringify(me)}`);
                } catch (error) {
                    logAuth(`âŒ Token is invalid: ${error.message}`);
                }
            } else {
                logAuth('âŒ No token found');
            }
        }

        async function testAPIAvailability() {
            logApi('ðŸ” Testing API availability...');
            
            if (!window.api) {
                logApi('âŒ window.api not available');
                return;
            }

            const opportunityMethods = [
                'createOpportunity',
                'updateOpportunity',
                'deleteOpportunity',
                'listOpportunities',
                'getOpportunity'
            ];

            opportunityMethods.forEach(method => {
                if (typeof window.api[method] === 'function') {
                    logApi(`âœ… ${method} available`);
                } else {
                    logApi(`âŒ ${method} not available`);
                }
            });
        }

        async function testClientData() {
            logClient('ðŸ” Testing client data...');
            
            if (!window.api) {
                logClient('âŒ window.api not available');
                return;
            }

            try {
                const clients = await window.api.listClients();
                logClient(`âœ… Clients loaded: ${clients.clients?.length || 0} clients`);
                
                if (clients.clients && clients.clients.length > 0) {
                    const firstClient = clients.clients[0];
                    logClient(`âœ… First client: ${firstClient.name} (ID: ${firstClient.id})`);
                } else {
                    logClient('âš ï¸ No clients available');
                }
            } catch (error) {
                logClient(`âŒ Failed to load clients: ${error.message}`);
            }
        }

        async function testOpportunityCreation() {
            logOpportunity('ðŸš€ Testing opportunity creation...');
            
            if (!window.api) {
                logOpportunity('âŒ window.api not available');
                return;
            }

            // Get a client first
            try {
                const clients = await window.api.listClients();
                if (!clients.clients || clients.clients.length === 0) {
                    logOpportunity('âŒ No clients available to create opportunity for');
                    return;
                }

                const clientId = clients.clients[0].id;
                logOpportunity(`âœ… Using client: ${clients.clients[0].name} (${clientId})`);

                const opportunityData = {
                    title: 'Debug Test Opportunity ' + Date.now(),
                    clientId: clientId,
                    stage: 'prospect',
                    value: 1000
                };

                logOpportunity(`ðŸ“¤ Creating opportunity: ${JSON.stringify(opportunityData)}`);

                const response = await window.api.createOpportunity(opportunityData);
                logOpportunity(`âœ… SUCCESS! Opportunity created: ${JSON.stringify(response)}`);

            } catch (error) {
                logOpportunity(`âŒ Opportunity creation failed: ${error.message}`);
                logOpportunity(`âŒ Error details: ${JSON.stringify(error)}`);
            }
        }

        async function runFullDebugTest() {
            logDebug('ðŸš€ Running full debug test...');
            
            // Step 1: Environment check
            logDebug('Step 1: Environment check');
            await checkEnvironment();
            
            // Step 2: Authentication
            logDebug('Step 2: Authentication test');
            await testAuthentication();
            
            // Step 3: API availability
            logDebug('Step 3: API availability test');
            await testAPIAvailability();
            
            // Step 4: Client data
            logDebug('Step 4: Client data test');
            await testClientData();
            
            // Step 5: Opportunity creation
            logDebug('Step 5: Opportunity creation test');
            await testOpportunityCreation();
            
            logDebug('âœ… Full debug test completed');
        }

        // Auto-run environment check on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkEnvironment();
            }, 1000);
        });
    </script>
</body>
</html>
