<!DOCTYPE html>
<html>
<head>
    <title>Spacebar Cursor Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #ccc;
            border-radius: 4px;
            min-height: 100px;
        }
        .instructions {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .failure {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>Spacebar Cursor Position Fix - Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Basic Spacebar Insertion</h2>
        <div class="instructions">
            <strong>Instructions:</strong>
            <ol>
                <li>Click in the middle of the text below</li>
                <li>Press spacebar</li>
                <li>Check if cursor stays in place (should insert space where cursor was)</li>
            </ol>
        </div>
        <textarea id="test1">This is a test sentence. Click here and press spacebar.</textarea>
        <div id="result1" class="result" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Multiple Spaces</h2>
        <div class="instructions">
            <strong>Instructions:</strong>
            <ol>
                <li>Type some text</li>
                <li>Press spacebar multiple times</li>
                <li>Verify cursor position is maintained each time</li>
            </ol>
        </div>
        <textarea id="test2" placeholder="Start typing here..."></textarea>
        <div id="result2" class="result" style="display:none;"></div>
    </div>

    <script>
        // Simulate the fix logic
        function setupSpacebarFix(textareaId) {
            const textarea = document.getElementById(textareaId);
            const cursorPosRef = { current: null };
            const isSpacebarPressedRef = { current: false };

            textarea.addEventListener('keydown', (e) => {
                if (e.key === ' ' || e.keyCode === 32) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();

                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const currentValue = textarea.value || '';
                    const newValue = currentValue.substring(0, start) + ' ' + currentValue.substring(end);
                    const newCursorPos = start + 1;

                    isSpacebarPressedRef.current = true;
                    cursorPosRef.current = newCursorPos;

                    // Immediate DOM update
                    textarea.value = newValue;
                    textarea.setSelectionRange(newCursorPos, newCursorPos);

                    // Double RAF backup
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            if (textarea && textarea.selectionStart === newCursorPos) {
                                textarea.setSelectionRange(newCursorPos, newCursorPos);
                                textarea.focus();
                            }
                        });
                    });

                    return false;
                }
            });

            textarea.addEventListener('change', (e) => {
                const skipCursorUpdate = isSpacebarPressedRef.current;
                if (skipCursorUpdate) {
                    isSpacebarPressedRef.current = false;
                    return;
                }
                cursorPosRef.current = textarea.selectionStart;
            });

            return textarea;
        }

        // Setup tests
        const test1 = setupSpacebarFix('test1');
        const test2 = setupSpacebarFix('test2');

        // Test logging
        let test1CursorPositions = [];
        test1.addEventListener('keydown', (e) => {
            if (e.key === ' ') {
                setTimeout(() => {
                    const pos = test1.selectionStart;
                    test1CursorPositions.push(pos);
                    const resultDiv = document.getElementById('result1');
                    resultDiv.style.display = 'block';
                    if (test1CursorPositions.length > 1) {
                        const prevPos = test1CursorPositions[test1CursorPositions.length - 2];
                        if (pos === prevPos + 1) {
                            resultDiv.className = 'result success';
                            resultDiv.textContent = `‚úÖ SUCCESS: Cursor moved correctly from ${prevPos} to ${pos} (expected: ${prevPos + 1})`;
                        } else {
                            resultDiv.className = 'result failure';
                            resultDiv.textContent = `‚ùå FAILURE: Cursor jumped from ${prevPos} to ${pos} (expected: ${prevPos + 1})`;
                        }
                    }
                }, 100);
            }
        });

        console.log('‚úÖ Spacebar fix test page loaded');
        console.log('üìù Test the textareas above to verify cursor position is maintained when pressing spacebar');
    </script>
</body>
</html>

