<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Data Persistence Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .test-data { background-color: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔍 Client Data Persistence Debug Tool</h1>
    
    <div class="test-section">
        <h2>🔧 Authentication</h2>
        <div class="test-data">
            <p><strong>API Base:</strong> <span id="apiBase">https://abco-erp-2-cnlz.vercel.app</span></p>
            <p><strong>Token:</strong> <span id="tokenStatus">Not logged in</span></p>
            <button onclick="login()">🔑 Login</button>
            <button onclick="logout()">🚪 Logout</button>
        </div>
    </div>

    <div class="test-section">
        <h2>📊 Test Results</h2>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>🚀 Run Complete Debug Test</h2>
        <button onclick="runCompleteTest()" style="background-color: #dc3545; color: white; font-size: 16px; padding: 15px 30px;">
            🔍 DEBUG DATA PERSISTENCE ISSUE
        </button>
        <button onclick="clearResults()" style="background-color: #6c757d; color: white;">
            🗑️ Clear Results
        </button>
    </div>

    <script>
        let authToken = null;
        let testClientId = null;
        let testResults = [];

        function addResult(testName, passed, message, details = null) {
            const result = {
                name: testName,
                passed: passed,
                message: message,
                details: details,
                timestamp: new Date().toISOString()
            };
            testResults.push(result);
            updateDisplay();
        }

        function updateDisplay() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = testResults.map(result => `
                <div class="test-result ${result.passed ? 'pass' : 'fail'}">
                    <strong>${result.passed ? '✅' : '❌'} ${result.name}</strong><br>
                    ${result.message}<br>
                    ${result.details ? `<pre>${JSON.stringify(result.details, null, 2)}</pre>` : ''}
                </div>
            `).join('');
        }

        async function login() {
            try {
                const response = await fetch(`${document.getElementById('apiBase').textContent}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'admin@abcotronics.com', password: 'admin123' })
                });
                
                const data = await response.json();
                if (data.data?.accessToken) {
                    authToken = data.data.accessToken;
                    document.getElementById('tokenStatus').textContent = authToken.substring(0, 20) + '...';
                    addResult('Authentication', true, 'Successfully logged in');
                } else {
                    addResult('Authentication', false, 'Login failed', data);
                }
            } catch (error) {
                addResult('Authentication', false, 'Login error', error.message);
            }
        }

        function logout() {
            authToken = null;
            document.getElementById('tokenStatus').textContent = 'Not logged in';
            addResult('Logout', true, 'Logged out');
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
            
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            
            const response = await fetch(`${document.getElementById('apiBase').textContent}${endpoint}`, options);
            const data = await response.json();
            
            return { response, data };
        }

        async function runCompleteTest() {
            clearResults();
            
            if (!authToken) {
                addResult('Test Setup', false, 'Please login first');
                return;
            }

            addResult('Test Start', true, 'Starting complete data persistence debug...');

            // Test 1: Create client with contacts and sites
            const testClientData = {
                name: 'DEBUG PERSISTENCE TEST',
                industry: 'Technology',
                status: 'active',
                revenue: 100000,
                address: '123 Debug Street',
                website: 'https://debug.com',
                notes: 'Testing data persistence',
                contacts: [
                    {
                        id: 'debug_contact_1',
                        name: 'Debug Manager',
                        email: 'debug@test.com',
                        phone: '+1234567890',
                        role: 'Manager',
                        siteId: 'debug_site_1'
                    },
                    {
                        id: 'debug_contact_2',
                        name: 'Debug Director',
                        email: 'director@test.com',
                        phone: '+1234567891',
                        role: 'Director',
                        siteId: 'debug_site_2'
                    }
                ],
                sites: [
                    {
                        id: 'debug_site_1',
                        name: 'Debug Main Office',
                        address: '123 Debug Street',
                        contactPerson: 'Debug Manager',
                        phone: '+1234567890',
                        email: 'debug@test.com',
                        notes: 'Main debug office',
                        latitude: '40.7128',
                        longitude: '-74.0060'
                    },
                    {
                        id: 'debug_site_2',
                        name: 'Debug Branch Office',
                        address: '456 Debug Avenue',
                        contactPerson: 'Debug Director',
                        phone: '+1234567891',
                        email: 'director@test.com',
                        notes: 'Branch debug office',
                        latitude: '40.7589',
                        longitude: '-73.9851'
                    }
                ],
                opportunities: [
                    {
                        id: 'debug_opp_1',
                        name: 'Debug Opportunity',
                        value: 50000,
                        stage: 'proposal',
                        probability: 80,
                        notes: 'Debug opportunity'
                    }
                ],
                contracts: [
                    {
                        id: 'debug_contract_1',
                        title: 'Debug Contract',
                        value: 100000,
                        startDate: '2024-01-01',
                        endDate: '2024-12-31',
                        status: 'Active',
                        notes: 'Debug contract'
                    }
                ],
                activityLog: [
                    {
                        id: 'debug_activity_1',
                        date: '2024-01-15',
                        action: 'Meeting',
                        description: 'Debug meeting',
                        user: 'Debug User'
                    }
                ],
                billingTerms: {
                    paymentTerms: 'Net 30',
                    billingFrequency: 'Monthly',
                    currency: 'USD',
                    retainerAmount: 10000,
                    taxExempt: false,
                    notes: 'Debug billing terms'
                }
            };

            try {
                // Step 1: Create client
                addResult('Step 1: Create Client', true, 'Creating client with comprehensive data...');
                const { response: createResponse, data: createData } = await apiCall('/api/clients', 'POST', testClientData);
                
                if (createResponse.ok && createData.data?.client?.id) {
                    testClientId = createData.data.client.id;
                    addResult('Step 1: Create Client', true, `Client created with ID: ${testClientId}`, createData.data.client);
                    
                    // Verify all data was saved
                    const savedClient = createData.data.client;
                    const dataChecks = [
                        { name: 'Contacts', expected: 2, actual: savedClient.contacts?.length || 0 },
                        { name: 'Sites', expected: 2, actual: savedClient.sites?.length || 0 },
                        { name: 'Opportunities', expected: 1, actual: savedClient.opportunities?.length || 0 },
                        { name: 'Contracts', expected: 1, actual: savedClient.contracts?.length || 0 },
                        { name: 'Activity Log', expected: 1, actual: savedClient.activityLog?.length || 0 }
                    ];
                    
                    dataChecks.forEach(check => {
                        if (check.actual === check.expected) {
                            addResult(`Data Check: ${check.name}`, true, `Correctly saved: ${check.actual} items`);
                        } else {
                            addResult(`Data Check: ${check.name}`, false, `Expected: ${check.expected}, Got: ${check.actual}`);
                        }
                    });
                    
                } else {
                    addResult('Step 1: Create Client', false, 'Failed to create client', createData);
                    return;
                }

                // Step 2: Wait a moment
                addResult('Step 2: Wait', true, 'Waiting 2 seconds for database to settle...');
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Step 3: Retrieve client by ID
                addResult('Step 3: Retrieve by ID', true, `Retrieving client ${testClientId}...`);
                const { response: getResponse, data: getData } = await apiCall(`/api/clients/${testClientId}`);
                
                if (getResponse.ok && getData.data?.client) {
                    const retrievedClient = getData.data.client;
                    addResult('Step 3: Retrieve by ID', true, 'Client retrieved successfully', retrievedClient);
                    
                    // Check data persistence
                    const persistenceChecks = [
                        { name: 'Contacts Persistence', data: retrievedClient.contacts, expected: 2 },
                        { name: 'Sites Persistence', data: retrievedClient.sites, expected: 2 },
                        { name: 'Opportunities Persistence', data: retrievedClient.opportunities, expected: 1 },
                        { name: 'Contracts Persistence', data: retrievedClient.contracts, expected: 1 },
                        { name: 'Activity Log Persistence', data: retrievedClient.activityLog, expected: 1 }
                    ];
                    
                    persistenceChecks.forEach(check => {
                        if (check.data && check.data.length === check.expected) {
                            addResult(`Persistence: ${check.name}`, true, `Data persisted: ${check.data.length} items`);
                        } else {
                            addResult(`Persistence: ${check.name}`, false, `Expected ${check.expected}, got ${check.data?.length || 0}`);
                        }
                    });
                    
                } else {
                    addResult('Step 3: Retrieve by ID', false, 'Failed to retrieve client', getData);
                }

                // Step 4: List all clients
                addResult('Step 4: List All Clients', true, 'Retrieving all clients...');
                const { response: listResponse, data: listData } = await apiCall('/api/clients');
                
                if (listResponse.ok && listData.data?.clients) {
                    const allClients = listData.data.clients;
                    addResult('Step 4: List All Clients', true, `Retrieved ${allClients.length} clients`);
                    
                    // Find our test client
                    const testClient = allClients.find(c => c.id === testClientId);
                    if (testClient) {
                        addResult('Step 4: Test Client Found', true, 'Test client found in list');
                        
                        // Check data in list
                        const listChecks = [
                            { name: 'Contacts in List', data: testClient.contacts, expected: 2 },
                            { name: 'Sites in List', data: testClient.sites, expected: 2 },
                            { name: 'Opportunities in List', data: testClient.opportunities, expected: 1 },
                            { name: 'Contracts in List', data: testClient.contracts, expected: 1 },
                            { name: 'Activity Log in List', data: testClient.activityLog, expected: 1 }
                        ];
                        
                        listChecks.forEach(check => {
                            if (check.data && check.data.length === check.expected) {
                                addResult(`List Check: ${check.name}`, true, `Data in list: ${check.data.length} items`);
                            } else {
                                addResult(`List Check: ${check.name}`, false, `Expected ${check.expected}, got ${check.data?.length || 0}`);
                            }
                        });
                        
                    } else {
                        addResult('Step 4: Test Client Found', false, 'Test client not found in list');
                    }
                    
                } else {
                    addResult('Step 4: List All Clients', false, 'Failed to retrieve client list', listData);
                }

                // Step 5: Update client
                addResult('Step 5: Update Client', true, 'Updating client with additional data...');
                const updateData = {
                    ...testClientData,
                    name: 'DEBUG PERSISTENCE TEST UPDATED',
                    revenue: 150000,
                    contacts: [
                        ...testClientData.contacts,
                        {
                            id: 'debug_contact_3',
                            name: 'Debug Engineer',
                            email: 'engineer@test.com',
                            phone: '+1234567892',
                            role: 'Engineer',
                            siteId: 'debug_site_1'
                        }
                    ]
                };
                
                const { response: updateResponse, data: updateData } = await apiCall(`/api/clients/${testClientId}`, 'PATCH', updateData);
                
                if (updateResponse.ok && updateData.data?.client) {
                    const updatedClient = updateData.data.client;
                    addResult('Step 5: Update Client', true, 'Client updated successfully', updatedClient);
                    
                    // Check update worked
                    if (updatedClient.name === updateData.name && updatedClient.revenue === updateData.revenue) {
                        addResult('Update Verification', true, 'Client data updated correctly');
                    } else {
                        addResult('Update Verification', false, 'Client data not updated correctly');
                    }
                    
                    // Check new contact was added
                    if (updatedClient.contacts && updatedClient.contacts.length === updateData.contacts.length) {
                        addResult('Contact Addition', true, `New contact added: ${updatedClient.contacts.length} total contacts`);
                    } else {
                        addResult('Contact Addition', false, `Expected ${updateData.contacts.length} contacts, got ${updatedClient.contacts?.length || 0}`);
                    }
                    
                } else {
                    addResult('Step 5: Update Client', false, 'Failed to update client', updateData);
                }

                // Step 6: Final verification
                addResult('Step 6: Final Verification', true, 'Performing final data verification...');
                const { response: finalResponse, data: finalData } = await apiCall(`/api/clients/${testClientId}`);
                
                if (finalResponse.ok && finalData.data?.client) {
                    const finalClient = finalData.data.client;
                    addResult('Step 6: Final Verification', true, 'Final verification completed', finalClient);
                    
                    // Final data check
                    const finalChecks = [
                        { name: 'Final Contacts', data: finalClient.contacts, expected: 3 },
                        { name: 'Final Sites', data: finalClient.sites, expected: 2 },
                        { name: 'Final Revenue', expected: 150000, actual: finalClient.revenue },
                        { name: 'Final Name', expected: 'DEBUG PERSISTENCE TEST UPDATED', actual: finalClient.name }
                    ];
                    
                    finalChecks.forEach(check => {
                        if (check.actual === check.expected) {
                            addResult(`Final Check: ${check.name}`, true, `Correct: ${check.actual}`);
                        } else {
                            addResult(`Final Check: ${check.name}`, false, `Expected: ${check.expected}, Got: ${check.actual}`);
                        }
                    });
                    
                } else {
                    addResult('Step 6: Final Verification', false, 'Failed final verification', finalData);
                }

                // Cleanup
                addResult('Cleanup', true, 'Cleaning up test data...');
                await apiCall(`/api/clients/${testClientId}`, 'DELETE');
                addResult('Cleanup', true, 'Test client deleted');

                addResult('Test Complete', true, 'Complete data persistence test finished!');

            } catch (error) {
                addResult('Test Error', false, 'Test failed with error', error.message);
            }
        }

        function clearResults() {
            testResults = [];
            testClientId = null;
            updateDisplay();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addResult('Debug Tool Initialized', true, 'Ready to debug data persistence issues');
        });
    </script>
</body>
</html>