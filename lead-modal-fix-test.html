<!DOCTYPE html>
<html>
<head>
    <title>Lead Modal Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; padding: 15px; margin: 10px 0; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin: 10px 0; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
    </style>
</head>
<body>
    <h1>🔧 Lead Modal Fix Test</h1>
    
    <div class="success">
        <h3>✅ Lead Modal Error Fixed</h3>
        <p>The "followUps.filter is not a function" error has been fixed by properly parsing JSON strings from the database.</p>
    </div>
    
    <div class="info">
        <h3>📋 What Was Fixed</h3>
        <p>The issue was that database fields like <code>followUps</code>, <code>contacts</code>, etc. are stored as JSON strings but the frontend was trying to use them as arrays directly.</p>
    </div>
    
    <button onclick="testLeadModal()" class="success">Test Lead Modal</button>
    <button onclick="testClientModal()">Test Client Modal</button>
    <button onclick="goToClients()">Go to Clients Page</button>
    
    <div id="results"></div>
    
    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        function testLeadModal() {
            addResult('🧪 Testing Lead Modal with JSON string data...', 'info');
            
            // Simulate lead data with JSON strings (like from database)
            const testLead = {
                id: 'test_lead_123',
                name: 'Test Lead',
                industry: 'Technology',
                status: 'Active',
                followUps: '[{"id":"1","date":"2025-10-22","description":"Follow up call","completed":false}]', // JSON string
                contacts: '[{"id":"1","name":"John Doe","email":"john@test.com"}]', // JSON string
                comments: '[]', // JSON string
                activityLog: '[]' // JSON string
            };
            
            addResult('📊 Test lead data created with JSON strings', 'info');
            addResult(`   • followUps: ${testLead.followUps}`, 'info');
            addResult(`   • contacts: ${testLead.contacts}`, 'info');
            
            // Test parsing logic
            try {
                const parsedFollowUps = typeof testLead.followUps === 'string' ? JSON.parse(testLead.followUps || '[]') : (testLead.followUps || []);
                const parsedContacts = typeof testLead.contacts === 'string' ? JSON.parse(testLead.contacts || '[]') : (testLead.contacts || []);
                
                addResult('✅ JSON parsing successful:', 'success');
                addResult(`   • Parsed followUps: ${parsedFollowUps.length} items`, 'success');
                addResult(`   • Parsed contacts: ${parsedContacts.length} items`, 'success');
                
                // Test filter operation
                const completedFollowUps = parsedFollowUps.filter(f => f.completed);
                addResult(`✅ Filter operation successful: ${completedFollowUps.length} completed follow-ups`, 'success');
                
            } catch (error) {
                addResult(`❌ Parsing failed: ${error.message}`, 'error');
            }
        }
        
        function testClientModal() {
            addResult('🧪 Testing Client Modal with JSON string data...', 'info');
            
            // Simulate client data with JSON strings
            const testClient = {
                id: 'test_client_123',
                name: 'Test Client',
                industry: 'Manufacturing',
                status: 'Active',
                followUps: '[{"id":"1","date":"2025-10-22","description":"Monthly review","completed":true}]',
                contacts: '[{"id":"1","name":"Jane Smith","email":"jane@client.com"}]',
                opportunities: '[{"id":"1","title":"New Project","stage":"proposal","value":50000}]',
                sites: '[]',
                contracts: '[]',
                activityLog: '[]'
            };
            
            addResult('📊 Test client data created with JSON strings', 'info');
            
            try {
                const parsedOpportunities = typeof testClient.opportunities === 'string' ? JSON.parse(testClient.opportunities || '[]') : (testClient.opportunities || []);
                const parsedFollowUps = typeof testClient.followUps === 'string' ? JSON.parse(testClient.followUps || '[]') : (testClient.followUps || []);
                
                addResult('✅ Client JSON parsing successful:', 'success');
                addResult(`   • Parsed opportunities: ${parsedOpportunities.length} items`, 'success');
                addResult(`   • Parsed followUps: ${parsedFollowUps.length} items`, 'success');
                
            } catch (error) {
                addResult(`❌ Client parsing failed: ${error.message}`, 'error');
            }
        }
        
        function goToClients() {
            addResult('🚀 Opening clients page to test the fix...', 'info');
            window.open('/clients', '_blank');
        }
        
        // Auto-run test on page load
        window.addEventListener('load', () => {
            addResult('🔧 Lead Modal Fix Test Tool Loaded', 'info');
            addResult('💡 The JSON parsing fix should resolve the "filter is not a function" error', 'info');
            
            // Auto-run test
            setTimeout(() => {
                testLeadModal();
            }, 1000);
        });
    </script>
</body>
</html>
