<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#0284c7">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Abcotronics">
    <title>Abcotronics - Fuel Management Services</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Leaflet CSS - Defer (only needed for maps) -->
    <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""></noscript>
    
    <!-- Tailwind CSS - Production Build (Critical - load immediately) -->
    <!-- CACHE BUST: 20260109-remove-triangle -->
    <link rel="preload" href="/dist/styles.css?v=20260112-3248496" as="style">
    <link rel="stylesheet" href="/dist/styles.css?v=20260112-3248496">
    
    <!-- Resource hints for faster loading -->
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <!-- Async CSS loader for better performance -->
    <script>
        /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
        (function(w){"use strict";var loadCSS=function(href,before,media){var doc=w.document;var ss=doc.createElement("link");var ref;if(before){ref=before}else{var refs=(doc.body||doc.getElementsByTagName("head")[0]).childNodes;ref=refs[refs.length-1]}var sheets=doc.styleSheets;ss.rel="stylesheet";ss.href=href;ss.media="only x";function ready(cb){if(doc.body){return cb()}setTimeout(function(){ready(cb)})}ready(function(){ref.parentNode.insertBefore(ss,before?ref:ref.nextSibling)});var onloadcssdefined=function(cb){var resolvedHref=ss.href;var i=sheets.length;while(i--){if(sheets[i].href===resolvedHref){return cb()}}setTimeout(function(){onloadcssdefined(cb)})};function onloadcss(){if(ss.addEventListener){ss.removeEventListener("load",onloadcss)}ss.media=media||"all"}if(ss.addEventListener){ss.addEventListener("load",onloadcss)}ss.onloadcssdefined=onloadcssdefined;onloadcssdefined(onloadcss);return ss};if(typeof exports!=="undefined"){exports.loadCSS=loadCSS}else{w.loadCSS=loadCSS}}(typeof global!=="undefined"?global:this));
    </script>
    
    <!-- Early theme boot: CRITICAL - Never apply dark mode when user wants light mode -->
    <script>
        (function() {
            try {
                var root = document.documentElement;
                var storedTheme = localStorage.getItem('abcotronics_theme');
                var useSystemTheme = localStorage.getItem('abcotronics_use_system_theme') === 'true';
                
                // CRITICAL: If user explicitly chose light mode and is NOT following system,
                // NEVER apply dark mode - force light mode always
                if (!useSystemTheme && storedTheme === 'light') {
                    root.classList.remove('light','dark');
                    root.classList.add('light');
                    localStorage.setItem('abcotronics_theme', 'light');
                    localStorage.setItem('abcotronics_use_system_theme', 'false');
                    return;
                }
                
                // If following system, check system preference
                if (useSystemTheme) {
                    var systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    var themeToApply = systemPrefersDark ? 'dark' : 'light';
                    root.classList.remove('light','dark');
                    root.classList.add(themeToApply);
                    localStorage.setItem('abcotronics_theme', themeToApply);
                    return;
                }
                
                // Default: light mode (first time user or no preference)
                var themeToApply = (storedTheme === 'dark') ? 'dark' : 'light';
                root.classList.remove('light','dark');
                root.classList.add(themeToApply);
                localStorage.setItem('abcotronics_theme', themeToApply);
                localStorage.setItem('abcotronics_use_system_theme', 'false');
            } catch (e) {}
        })();
    </script>
    
    <!-- Build Version - Set from build-version.json -->
    <script>
        // Set build version for cache-busting (updated during build)
        window.BUILD_VERSION = '1768197262796'; // Updated by build process
    </script>
    
    <!-- Cache Clearing Script - Runs early to clear stale cache -->
    <!-- VERSION: 20251215-remove-simple-v2 - Update this when deploying new changes -->
    <script>
        (function() {
            var APP_VERSION = '20260112-3248496';
            var VERSION_STORAGE_KEY = 'abcotronics_app_html_version';
            
            try {
                // Check stored version vs current version
                var storedVersion = localStorage.getItem(VERSION_STORAGE_KEY);
                var versionMismatch = storedVersion !== APP_VERSION;
                
                // Check if we need to force clear cache (via URL parameter or localStorage flag or version mismatch)
                var urlParams = new URLSearchParams(window.location.search);
                var hashParams = new URLSearchParams((window.location.hash || '').split('?')[1] || '');
                var shouldClearCache = urlParams.has('clearCache') || 
                                      urlParams.has('forceRefresh') || 
                                      hashParams.has('clearCache') || 
                                      hashParams.has('forceRefresh') ||
                                      localStorage.getItem('abcotronics_force_clear_cache') === 'true' ||
                                      versionMismatch;
                
                if (shouldClearCache || versionMismatch) {
                    console.log('üßπ Force clearing cache on page load...');
                    console.log('üì¶ Version check: stored=' + storedVersion + ', current=' + APP_VERSION);
                    
                    // Clear all localStorage cache related to clients/leads/groups
                    try {
                        var keysToRemove = [];
                        for (var i = 0; i < localStorage.length; i++) {
                            var key = localStorage.key(i);
                            if (key && (
                                key.includes('clients') || 
                                key.includes('leads') || 
                                key.includes('groups') ||
                                key.includes('cache') ||
                                key.includes('Client') ||
                                key.includes('Lead') ||
                                key.includes('Group') ||
                                key.startsWith('abcotronics_') ||
                                key.startsWith('app_')
                            )) {
                                keysToRemove.push(key);
                            }
                        }
                        keysToRemove.forEach(function(key) {
                            localStorage.removeItem(key);
                            console.log('üóëÔ∏è Cleared localStorage key:', key);
                        });
                    } catch (e) {
                        console.warn('Could not clear localStorage:', e);
                    }
                    
                    // Clear sessionStorage
                    try {
                        sessionStorage.clear();
                        console.log('üóëÔ∏è Cleared sessionStorage');
                    } catch (e) {
                        console.warn('Could not clear sessionStorage:', e);
                    }
                    
                    // Clear IndexedDB if available (for advanced caching)
                    if ('indexedDB' in window) {
                        try {
                            indexedDB.databases().then(function(databases) {
                                databases.forEach(function(db) {
                                    if (db.name && (db.name.includes('cache') || db.name.includes('abcotronics'))) {
                                        indexedDB.deleteDatabase(db.name);
                                        console.log('üóëÔ∏è Cleared IndexedDB:', db.name);
                                    }
                                });
                            }).catch(function(e) {
                                console.warn('Could not clear IndexedDB:', e);
                            });
                        } catch (e) {
                            console.warn('IndexedDB not available:', e);
                        }
                    }
                    
                    // Set a flag for when DatabaseAPI loads to clear its cache
                    window.__CLEAR_DATABASE_CACHE_ON_LOAD__ = true;
                    window.__FORCE_REFRESH_DATA__ = true;
                    
                    // Update stored version
                    localStorage.setItem(VERSION_STORAGE_KEY, APP_VERSION);
                    
                    // Remove refresh parameters from URL
                    if (urlParams.has('clearCache') || urlParams.has('forceRefresh')) {
                        urlParams.delete('clearCache');
                        urlParams.delete('forceRefresh');
                        var newSearch = urlParams.toString();
                        var newUrl = window.location.pathname + (newSearch ? '?' + newSearch : '') + window.location.hash;
                        window.history.replaceState({}, '', newUrl);
                    }
                    
                    console.log('‚úÖ Cache cleared and version updated to:', APP_VERSION);
                    
                    // If version mismatch, force a hard reload to get fresh HTML
                    if (versionMismatch && !urlParams.has('noReload')) {
                        console.log('üîÑ Version mismatch detected - forcing hard reload to get fresh HTML');
                        console.log('   Old version:', storedVersion);
                        console.log('   New version:', APP_VERSION);
                        // Force an immediate hard reload with cache bypass
                        // Use location.reload(true) for maximum cache bypass (deprecated but still works)
                        if (window.location.reload) {
                            // Force reload from server, bypassing cache
                            window.location.reload(true);
                        } else {
                            // Fallback: redirect with cache-busting timestamp
                            var reloadUrl = window.location.href.split('?')[0] + '?noReload=1&_t=' + Date.now();
                            window.location.replace(reloadUrl);
                        }
                        return; // Exit early to prevent further execution
                    }
                } else {
                    // No cache clear needed, but update version if not set
                    if (!storedVersion) {
                        localStorage.setItem(VERSION_STORAGE_KEY, APP_VERSION);
                    }
                }
            } catch (e) {
                console.warn('Error in cache clearing script:', e);
            }
        })();
    </script>
    
    <!-- Mobile Responsive CSS - Defer non-critical CSS -->
    <link rel="preload" href="/mobile-responsive.css?v=20260112-3248496" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/mobile-responsive.css?v=20260112-3248496"></noscript>
    
    <!-- Mobile Helper JavaScript - Dynamic mobile enhancements -->
    <script defer src="/mobile-helper.js?v=20260112-3248496"></script>
    
    <!-- Dark Mode Fixes CSS - Defer -->
    <link rel="preload" href="/dark-mode-fixes.css?v=20260112-3248496" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/dark-mode-fixes.css?v=20260112-3248496"></noscript>
    
    <!-- Public Job Card Mobile Overrides - Defer -->
    <link rel="preload" href="/job-card-public-mobile.css?v=20260112-3248496" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/job-card-public-mobile.css?v=20260112-3248496"></noscript>
    
    <!-- Font Awesome - Defer non-critical CSS -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
    
    
    <!-- Custom Primary Colors -->
    <style>
        :root {
            --primary-50: #e0f2fe;
            --primary-100: #bae6fd;
            --primary-200: #7dd3fc;
            --primary-300: #38bdf8;
            --primary-400: #0ea5e9;
            --primary-500: #0284c7;
            --primary-600: #0369a1;
            --primary-700: #075985;
            --primary-800: #0c4a6e;
            --primary-900: #082f49;
        }
        .bg-primary-500 { background-color: var(--primary-500); }
        .text-primary-500 { color: var(--primary-500); }
        .border-primary-500 { border-color: var(--primary-500); }
        .hover\:bg-primary-600:hover { background-color: var(--primary-600); }
        .hover\:bg-primary-700:hover { background-color: var(--primary-700); }
    </style>
    
    <!-- Simple in-app version checker & reload banner -->
    <style>
        .app-version-banner {
            position: fixed;
            inset-inline: 0;
            bottom: 0;
            z-index: 9999;
            display: none;
            background: #0f172a;
            color: #e5e7eb;
            padding: 0.75rem 1rem;
            box-shadow: 0 -4px 10px rgba(15, 23, 42, 0.6);
            font-size: 0.875rem;
        }
        .app-version-banner__content {
            max-width: 960px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }
        .app-version-banner__button {
            border-radius: 9999px;
            border: none;
            padding: 0.4rem 0.9rem;
            background: #22c55e;
            color: #022c22;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        .app-version-banner__button:hover {
            background: #16a34a;
        }
        .app-version-banner__button--secondary {
            background: transparent;
            color: #9ca3af;
            border: 1px solid rgba(148, 163, 184, 0.5);
        }
        .app-version-banner__button--secondary:hover {
            background: rgba(15, 23, 42, 0.9);
        }
        @media (max-width: 640px) {
            .app-version-banner__content {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
    <style>
        /* Force login brand white regardless of dark mode overrides */
        .login-brand { color: #ffffff !important; }
        html:not(.dark) h1.login-brand, html:not(.dark) #loginBrand {
            color: #ffffff !important;
            -webkit-text-fill-color: #ffffff !important;
        }
    </style>
    
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            body {
                font-size: 16px; /* Prevents zoom on iOS */
                line-height: 1.5;
            }
            
            /* Prevent horizontal scroll */
            html, body {
                overflow-x: hidden;
                width: 100%;
            }
            
            /* Touch-friendly buttons */
            button, .btn, [role="button"] {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            /* Better form inputs */
            input, textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 8px;
            }
            
            /* Improved scrolling */
            .overflow-y-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Mobile horizontal scrollable navigation tabs */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .overflow-x-auto::-webkit-scrollbar {
                display: none;
            }
            
            /* Ensure tab buttons maintain readable width on mobile */
            .overflow-x-auto button {
                min-width: max-content;
                flex-shrink: 0;
                white-space: nowrap;
            }
            
            /* Mobile table to card conversion */
            .table-responsive {
                display: none;
            }
            
            .table-mobile {
                display: block;
            }
            
            .mobile-card {
                background: white;
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                border: 1px solid #e5e7eb;
            }
            
            .dark .mobile-card {
                background: #1f2937;
                border-color: #374151;
            }
            
            /* Mobile modal optimizations */
            .modal {
                margin: 0;
                max-height: 100vh;
                border-radius: 0;
            }
            
            .modal-dialog {
                margin: 0;
                max-width: 100%;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            
            .modal-content {
                flex: 1;
                border-radius: 0;
                border: none;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media (min-width: 769px) {
            .table-mobile {
                display: none;
            }
            
            .table-responsive {
                display: block;
            }
        }
        
        .sidebar-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-scrollbar::-webkit-scrollbar-thumb {
            background: #0284c7;
            border-radius: 3px;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Mobile-friendly horizontal scrolling - show scrollbar on mobile */
        @media (max-width: 1024px) {
            .scrollbar-hide {
                -ms-overflow-style: auto;
                scrollbar-width: thin;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: block;
                height: 8px;
            }
            .scrollbar-hide::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.3);
                border-radius: 4px;
            }
            .scrollbar-hide::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.05);
            }
        }
        /* Mobile-friendly touch targets */
        @media (max-width: 640px) {
            button, input, select, textarea {
                min-height: 44px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 login-page">
    <div id="root"></div>

    <!-- Version checker: detects new deployments and prompts user to reload -->
    <div id="app-version-banner" class="app-version-banner" aria-live="polite" aria-atomic="true">
        <div class="app-version-banner__content">
            <span id="app-version-banner-text">
                A new version of Abcotronics ERP is available.
            </span>
            <div style="display: flex; gap: 0.5rem;">
                <button
                    type="button"
                    class="app-version-banner__button"
                    id="app-version-reload"
                >
                    Reload now
                </button>
                <button
                    type="button"
                    class="app-version-banner__button app-version-banner__button--secondary"
                    id="app-version-dismiss"
                >
                    Later
                </button>
            </div>
        </div>
    </div>

    <!-- React Production Builds - Much faster than development -->
    <!-- Preconnect to CDNs for faster loading -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdn.sheetjs.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://cdn.sheetjs.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- Preload critical React libraries for faster loading -->
    <link rel="preload" href="https://unpkg.com/react@18/umd/react.production.min.js" as="script" crossorigin>
    <link rel="preload" href="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" as="script" crossorigin>
    
    <!-- React - Must load before dependent scripts, but preload helps -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js" onload="if(typeof React !== 'undefined') { window.React = React; console.log('‚úÖ React loaded'); }" onerror="console.error('‚ùå Failed to load React from CDN');"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" onload="if(typeof React !== 'undefined') { window.React = React; } if(typeof ReactDOM !== 'undefined') { window.ReactDOM = ReactDOM; window.BabelReady = true; window.dispatchEvent(new Event('babelready')); console.log('‚úÖ ReactDOM loaded'); }" onerror="console.error('‚ùå Failed to load ReactDOM from CDN');"></script>
    <!-- XLSX library for Excel export - Load without defer to ensure proper initialization -->
    <script crossorigin src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js" 
            onload="(function() { 
                     if(typeof XLSX !== 'undefined' && XLSX && XLSX.utils) { 
                       window.XLSX = XLSX; 
                       console.log('‚úÖ XLSX library loaded from SheetJS CDN'); 
                     } else {
                       console.warn('‚ö†Ô∏è XLSX loaded but not properly initialized');
                       console.error('‚ùå XLSX failed to initialize - Excel export will be unavailable');
                     }
                   })();" 
            onerror="console.error('‚ùå XLSX CDN load failed from SheetJS - Excel export will be unavailable');"></script>
    
    <!-- ExcelJS library for Excel data validation support (dropdowns) - from unpkg (allowed by CSP) -->
    <script crossorigin src="https://unpkg.com/exceljs@4.4.0/dist/exceljs.min.js" 
            onload="(function() { 
                     if(typeof ExcelJS !== 'undefined') { 
                       window.ExcelJS = ExcelJS; 
                       console.log('‚úÖ ExcelJS library loaded for data validation support'); 
                     } else {
                       console.warn('‚ö†Ô∏è ExcelJS loaded but not properly initialized');
                     }
                   })();" 
            onerror="console.warn('‚ö†Ô∏è ExcelJS CDN load failed - data validation dropdowns may not work');"></script>
    
    <!-- Verify React loaded and expose globally (fallback) -->
    <script>
        // Fallback check after scripts load
        setTimeout(() => {
            if (typeof React !== 'undefined') {
                window.React = React;
                console.log('‚úÖ React verified');
            } else {
                console.error('‚ùå React not loaded - check CDN connection');
            }
            if (typeof ReactDOM !== 'undefined') {
                window.ReactDOM = ReactDOM;
                // Dispatch ready event
                if (!window.BabelReady) {
                    window.BabelReady = true;
                    window.dispatchEvent(new Event('babelready'));
                }
                console.log('‚úÖ ReactDOM verified');
            } else {
                console.error('‚ùå ReactDOM not loaded - check CDN connection');
            }
            // XLSX is deferred and not critical for initial load - check with longer timeout
            // Components that use XLSX have their own retry logic, so we don't need to error here
            if (typeof XLSX !== 'undefined') {
                window.XLSX = XLSX;
                console.log('‚úÖ XLSX verified');
            } else {
                // XLSX is lazy-loaded and not critical - retry check after longer delay since it's deferred
                setTimeout(() => {
                    if (typeof XLSX !== 'undefined') {
                        window.XLSX = XLSX;
                        console.log('‚úÖ XLSX loaded (delayed)');
                    } else {
                        // Log error if still not loaded after retry - helps diagnose CDN issues
                        console.error('‚ùå XLSX not loaded - check CDN connection');
                        console.warn('‚ö†Ô∏è Excel export features will be unavailable until XLSX library loads');
                    }
                }, 3000); // Additional 3 seconds for deferred scripts
            }
        }, 1000);
    </script>
    
    <!-- Leaflet JavaScript - Lazy load (only needed for maps) -->
    <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Fix for exports undefined errors -->
    <script>
        // Enhanced polyfill for CommonJS exports in browser environment
        if (typeof exports === 'undefined') {
            window.exports = {};
            window.exports = window.exports || {};
        }
        if (typeof module === 'undefined') {
            window.module = { exports: {} };
            window.module = window.module || { exports: {} };
        }
        if (typeof require === 'undefined') {
            window.require = function() { return {}; };
        }
        if (typeof global === 'undefined') {
            window.global = window;
        }
        if (typeof process === 'undefined') {
            window.process = { env: {} };
        }
        
        // Prevent CommonJS modules from breaking
        window.define = window.define || function() {};
        window.define.amd = false;
    </script>
    
    <!-- Global Error Handlers -->
    <script>
        // Global unhandled promise rejection handler (v3 - ultra-robust database error detection)
        // Updated: 2025-11-04 - Enhanced to detect and suppress database connection errors
        window.addEventListener('unhandledrejection', function(event) {
            try {
                const error = event.reason;
                
                // Extract ALL possible error text sources
                let allErrorText = '';
                
                if (error instanceof Error) {
                    allErrorText = [
                        error.message || '',
                        error.name || '',
                        error.toString(),
                        error.stack || ''
                    ].join(' ').toLowerCase();
                } else if (typeof error === 'string') {
                    allErrorText = error.toLowerCase();
                } else if (error && typeof error === 'object') {
                    allErrorText = [
                        error.message || '',
                        error.error?.message || '',
                        error.reason?.message || '',
                        String(error),
                        JSON.stringify(error).substring(0, 500) // Limit to avoid huge strings
                    ].join(' ').toLowerCase();
                } else {
                    allErrorText = String(error).toLowerCase();
                }
                
                // Check for database connection errors - very broad pattern matching
                // Match ANY indication of database/connection/server issues
                const isDatabaseError = 
                    allErrorText.includes('database connection failed') ||
                    allErrorText.includes('database server is unreachable') ||
                    allErrorText.includes('database server') && allErrorText.includes('unreachable') ||
                    (allErrorText.includes('unreachable') && (allErrorText.includes('database') || allErrorText.includes('server'))) ||
                    allErrorText.includes('contact support if this issue persists') ||
                    allErrorText.includes('please contact support') ||
                    allErrorText.includes('contact support') ||
                    allErrorText.includes('econnrefused') ||
                    allErrorText.includes('etimedout') ||
                    allErrorText.includes('can\'t reach database') ||
                    allErrorText.includes('cannot reach database') ||
                    (allErrorText.includes('connection') && allErrorText.includes('failed') && allErrorText.includes('database')) ||
                    (allErrorText.includes('server') && allErrorText.includes('unreachable'));
                
                // Check for opportunities API errors (500s) - these are server-side issues
                const isOpportunitiesApiError = 
                    allErrorText.includes('failed to list opportunities') ||
                    (allErrorText.includes('opportunities') && (allErrorText.includes('500') || allErrorText.includes('server error'))) ||
                    (allErrorText.includes('/opportunities') && (allErrorText.includes('500') || allErrorText.includes('internal server error')));
                
                // Check for server errors (5xx) - Bad Gateway, Service Unavailable, Gateway Timeout, etc.
                // These are server-side issues that the client can't fix, so suppress them
                const isServerError = 
                    allErrorText.includes('502') ||
                    allErrorText.includes('503') ||
                    allErrorText.includes('504') ||
                    allErrorText.includes('500') ||
                    allErrorText.includes('bad gateway') ||
                    allErrorText.includes('service unavailable') ||
                    allErrorText.includes('gateway timeout') ||
                    allErrorText.includes('internal server error') ||
                    (allErrorText.includes('server') && (allErrorText.includes('unavailable') || allErrorText.includes('error')));
                
                // Check for "already exists" errors - these are handled gracefully by the application
                const isAlreadyExistsError = 
                    allErrorText.includes('already exist') ||
                    allErrorText.includes('already exists') ||
                    (allErrorText.includes('duplicate') && (allErrorText.includes('weekly') || allErrorText.includes('notes')));
                
                // Only log non-database, non-opportunities-api, non-server, and non-already-exists errors
                if (!isDatabaseError && !isOpportunitiesApiError && !isServerError && !isAlreadyExistsError) {
                    console.error('üö® Unhandled Promise Rejection:', {
                        reason: error,
                        promise: event.promise,
                        error: error instanceof Error ? {
                            message: error.message,
                            stack: error.stack,
                            name: error.name
                        } : error,
                        timestamp: new Date().toISOString()
                    });
                }
                // Database errors and server errors are silently suppressed - they're expected when server/DB is down
                
                // Prevent default browser error handling
                event.preventDefault();
                
            } catch (handlerError) {
                // Error handler itself failed - just prevent default
                event.preventDefault();
            }
        });
        
        // Global error handler for JavaScript errors
        window.addEventListener('error', function(event) {
            console.error('üö® Global Error:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error,
                stack: event.error?.stack,
                timestamp: new Date().toISOString()
            });
        });
        
        console.log('‚úÖ Global error handlers registered');
    </script>
    
    <!-- Version polling logic: Best practice implementation for SPA version updates -->
    <!-- Checks /version endpoint periodically and on visibility changes (when user returns to tab) -->
    <script>
        (function() {
            const VERSION_STORAGE_KEY = 'abcotronics_app_version';
            const VERSION_DISMISSED_KEY = 'abcotronics_version_dismissed';
            const VERSION_CHECK_INTERVAL_MS = 60 * 1000; // 60 seconds - industry standard
            const VERSION_ENDPOINT = '/version';
            let versionCheckTimer = null;
            let lastCheckTime = 0;
            const MIN_CHECK_INTERVAL = 15 * 1000; // Throttle: max once per 15 seconds

            function getStoredVersion() {
                try {
                    return localStorage.getItem(VERSION_STORAGE_KEY) || null;
                } catch {
                    return null;
                }
            }

            function setStoredVersion(version) {
                try {
                    if (version) {
                        localStorage.setItem(VERSION_STORAGE_KEY, version);
                    }
                } catch {
                    // Ignore storage errors (private mode, etc.)
                }
            }

            function getDismissedVersion() {
                try {
                    return localStorage.getItem(VERSION_DISMISSED_KEY) || null;
                } catch {
                    return null;
                }
            }

            function setDismissedVersion(version) {
                try {
                    if (version) {
                        localStorage.setItem(VERSION_DISMISSED_KEY, version);
                    }
                } catch {
                    // Ignore storage errors
                }
            }

            async function fetchCurrentVersion() {
                try {
                    const res = await fetch(VERSION_ENDPOINT, {
                        cache: 'no-store',
                        headers: {
                            'Accept': 'application/json',
                        },
                    });
                    if (!res.ok) {
                        console.warn('‚ö†Ô∏è Version endpoint returned non-OK status:', res.status, res.statusText);
                        return null;
                    }
                    const contentType = res.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.warn('‚ö†Ô∏è Version endpoint returned non-JSON content:', contentType);
                        // Try to parse as JSON anyway (some servers don't set content-type correctly)
                    }
                    const data = await res.json().catch((err) => {
                        console.warn('‚ö†Ô∏è Failed to parse version endpoint response as JSON:', err);
                        return null;
                    });
                    if (!data || typeof data.version !== 'string') {
                        console.warn('‚ö†Ô∏è Version endpoint response missing or invalid version field:', data);
                        return null;
                    }
                    return data.version;
                } catch (err) {
                    console.warn('‚ö†Ô∏è Error fetching version from endpoint:', err);
                    return null;
                }
            }

            function showBanner() {
                const banner = document.getElementById('app-version-banner');
                if (!banner) return;
                banner.style.display = 'block';

                const reloadBtn = document.getElementById('app-version-reload');
                const dismissBtn = document.getElementById('app-version-dismiss');

                if (reloadBtn) {
                    reloadBtn.onclick = function() {
                        // Normal reload is enough because HTML is served with no-cache headers
                        window.location.reload();
                    };
                }

                if (dismissBtn) {
                    dismissBtn.onclick = function() {
                        banner.style.display = 'none';
                        // Store the dismissed version - banner won't reappear for this version
                        const latest = getStoredVersion();
                        if (latest) {
                            setDismissedVersion(latest);
                        }
                    };
                }
            }

            async function checkVersion(forceShow = false) {
                // Throttle checks to avoid excessive server requests
                const now = Date.now();
                if (!forceShow && (now - lastCheckTime) < MIN_CHECK_INTERVAL) {
                    return;
                }
                lastCheckTime = now;

                const latest = await fetchCurrentVersion();
                if (!latest) {
                    // Log errors to help debug
                    console.warn('‚ö†Ô∏è Version check: Could not fetch current version from server');
                    return;
                }

                const stored = getStoredVersion();
                const dismissed = getDismissedVersion();

                // Log version check for debugging
                console.log('üîç Version check:', { stored, latest, dismissed, forceShow });

                // If version changed
                if (stored && stored !== latest) {
                    console.log('‚úÖ New version detected!', { old: stored, new: latest });
                    // Show banner if user hasn't dismissed this specific new version
                    if (dismissed !== latest || forceShow) {
                        console.log('üì¢ Showing update notification banner');
                        showBanner();
                    } else {
                        console.log('‚ÑπÔ∏è New version available but user dismissed it');
                    }
                } else if (!stored) {
                    // First time - just store the version
                    console.log('üì¶ First version check - storing version:', latest);
                } else {
                    console.log('‚úÖ Version unchanged:', latest);
                }

                // Always update stored version
                setStoredVersion(latest);
            }

            function startPeriodicChecks() {
                if (versionCheckTimer) {
                    clearInterval(versionCheckTimer);
                }
                versionCheckTimer = setInterval(() => {
                    checkVersion();
                }, VERSION_CHECK_INTERVAL_MS);
            }

            async function initializeVersionWatcher() {
                // Prevent multiple initializations
                if (window._versionWatcherInitialized) {
                    return;
                }
                window._versionWatcherInitialized = true;
                
                // Initial check on page load
                await checkVersion(true);

                // Start periodic polling (industry standard: 60-300 seconds)
                startPeriodicChecks();

                // BEST PRACTICE: Check when tab becomes visible (user returns to app)
                // This is more reliable than 'focus' event and works better with mobile
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        // Tab became visible - check for updates
                        checkVersion();
                    }
                });

                // BEST PRACTICE: Also check on window focus as fallback
                window.addEventListener('focus', () => {
                    checkVersion();
                }, { passive: true });

                // Expose manual check function for debugging/admin use
                window.checkAppVersion = () => checkVersion(true);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeVersionWatcher);
            } else {
                initializeVersionWatcher();
            }
        })();
    </script>
    
    <!-- Lazy load heavy libraries when needed -->
    <script>
        // Lazy load PDF.js when PDF to Word converter is used
        window.loadPDFJS = function() {
            if (window.pdfjsLib) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = () => {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };
        
        // Lazy load Tesseract.js when OCR is used
        window.loadTesseract = function() {
            if (window.Tesseract) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };
    </script>
    
    <!-- Core bundle: critical modules - Preload for faster loading -->
    <!-- CACHE BUST: 20251215-groups-fix-cache-bust -->
    <link rel="preload" href="/dist/core-bundle.js?v=1768197262796" as="script">
    <script defer src="/dist/core-bundle.js?v=1768197262796"></script>

    <script>
        window.addEventListener('corebundle:ready', () => {
            try {
                if (window.DatabaseAPI && typeof window.DatabaseAPI.getProject !== 'function') {
                    window.DatabaseAPI.getProject = async function(id) {
                        try {
                            if (window.api && typeof window.api.getProject === 'function') {
                                return await window.api.getProject(id);
                            }
                        } catch (e) {
                            // fall through to direct fetch
                        }
                        const res = await fetch(`/api/projects/${id}`, {
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                            }
                        });
                        if (!res.ok) {
                            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                        }
                        const data = await res.json();
                        return data?.data ? data : { data: { project: data.project || data.data || data } };
                    };
                    console.log('üß© Shimmed DatabaseAPI.getProject at runtime');
                }
            } catch (err) {
                console.warn('DatabaseAPI.getProject shim failed:', err);
            }
        });
    </script>

    <script>
        window.addEventListener('corebundle:ready', () => {
            if (!window.AuthProvider || !window.useAuth) {
                console.error('‚ùå CRITICAL: AuthProvider not available after core bundle');
            } else {
                console.log('‚úÖ AuthProvider loaded successfully');
            }
        });
    </script>

    <script>
        window.addEventListener('corebundle:ready', () => {
            function patchApiLogin() {
                try {
                    if (!window.api || window.__apiLoginPatched) return;
                    const originalLogin = window.api.login;
                    if (typeof originalLogin !== 'function') return;
                    window.api.login = async function(email, password) {
                        try {
                            return await originalLogin(email, password);
                        } catch (err) {
                            try {
                                const res = await fetch(window.location.origin + '/api/auth/login', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    credentials: 'include',
                                    body: JSON.stringify({ email, password })
                                });
                                const text = await res.text();
                                const data = text ? JSON.parse(text) : {};
                                if (!res.ok) {
                                    const errorMessage = data?.error?.message || data?.message || `Request failed with status ${res.status}`;
                                    const error = new Error(errorMessage);
                                    error.status = res.status;
                                    throw error;
                                }
                                if (data?.accessToken) {
                                    window.storage?.setToken?.(data.accessToken);
                                } else if (data?.data?.accessToken) {
                                    window.storage?.setToken?.(data.data.accessToken);
                                } else {
                                    throw new Error('No access token received from login');
                                }
                                return data;
                            } catch (fallbackErr) {
                                throw fallbackErr;
                            }
                        }
                    };
                    window.__apiLoginPatched = true;
                    console.log('üß© Patched api.login to fallback to /auth/login');
                } catch (_) {}
            }
            patchApiLogin();
            window.addEventListener('load', patchApiLogin, { once: true });
        });
    </script>

    <!-- Lazy Load Non-Critical Components -->
    <!-- Vite Projects Module - Load before lazy-load-components so components are available -->
    <!-- Vite Projects Module - Load after React is confirmed available -->
    <script>
        // Wait for React to be available before loading Vite module
        function loadViteProjectsModule() {
            // More robust check - ensure React and its hooks are available
            if (typeof window.React !== 'undefined' && 
                window.React !== null && 
                typeof window.React.useState === 'function' &&
                typeof window.React.useEffect === 'function' &&
                typeof window.React.useRef === 'function') {
                
                // Check if already loaded from main source (lazy-load-components.js)
                // The Vite module should only be a fallback if MonthlyDocumentCollectionTracker or WeeklyFMSReviewTracker aren't available
                const hasMonthlyTracker = window.MonthlyDocumentCollectionTracker && typeof window.MonthlyDocumentCollectionTracker === 'function';
                const hasWeeklyTracker = window.WeeklyFMSReviewTracker && typeof window.WeeklyFMSReviewTracker === 'function';
                
                if (hasMonthlyTracker && hasWeeklyTracker) {
                    console.log('‚úÖ MonthlyDocumentCollectionTracker and WeeklyFMSReviewTracker already available from main source, skipping Vite module load');
                    // Dispatch event even if already loaded (for components that missed it)
                    if (typeof window.dispatchEvent === 'function') {
                        window.dispatchEvent(new CustomEvent('viteProjectsReady', {
                            detail: { 
                                MonthlyDocumentCollectionTracker: window.MonthlyDocumentCollectionTracker,
                                WeeklyFMSReviewTracker: window.WeeklyFMSReviewTracker
                            }
                        }));
                    }
                    return;
                }
                
                // If only one is missing, still load vite-projects module
                if (hasMonthlyTracker && !hasWeeklyTracker) {
                    console.log('‚ö†Ô∏è MonthlyDocumentCollectionTracker available but WeeklyFMSReviewTracker missing, loading Vite module...');
                } else if (!hasMonthlyTracker && hasWeeklyTracker) {
                    console.log('‚ö†Ô∏è WeeklyFMSReviewTracker available but MonthlyDocumentCollectionTracker missing, loading Vite module...');
                }
                
                // Check if script already exists - remove old ones with timestamp cache busting
                const existingScripts = document.querySelectorAll('script[src*="projects-module.js"]');
                // CACHE BUST VERSION: bump when deploying new Vite projects bundle
                const VITE_PROJECTS_VERSION = '20260112-3248496' + Date.now();
                console.log('üîç Checking for existing scripts. Found:', existingScripts.length);
                existingScripts.forEach(oldScript => {
                    const src = oldScript.src || oldScript.getAttribute('src') || '';
                    console.log('üîç Existing script found:', src);
                    // Remove scripts with timestamp cache busting (old version) OR wrong version
                    if (src.includes('projects-module.js') && (/v=\d{13}/.test(src) || !src.includes(VITE_PROJECTS_VERSION))) {
                        console.log('üóëÔ∏è Removing old/wrong version script:', src);
                        oldScript.remove();
                    }
                });
                
                // Check again after cleanup
                const existingScript = document.querySelector('script[src*="projects-module.js"]');
                if (existingScript) {
                    const src = existingScript.src || existingScript.getAttribute('src') || '';
                    // Only use existing script if it has the correct version
                    if (src.includes(VITE_PROJECTS_VERSION)) {
                        console.log('‚úÖ Vite Projects module script already added with correct version, waiting for load...');
                        // Listen for both components to become available
                        const checkExisting = setInterval(() => {
                            const hasMonthly = window.MonthlyDocumentCollectionTracker && typeof window.MonthlyDocumentCollectionTracker === 'function';
                            const hasWeekly = window.WeeklyFMSReviewTracker && typeof window.WeeklyFMSReviewTracker === 'function';
                            if (hasMonthly && hasWeekly) {
                                console.log('‚úÖ MonthlyDocumentCollectionTracker and WeeklyFMSReviewTracker became available from existing script');
                                clearInterval(checkExisting);
                                // Dispatch event
                                if (typeof window.dispatchEvent === 'function') {
                                    window.dispatchEvent(new CustomEvent('viteProjectsReady', {
                                        detail: { 
                                            MonthlyDocumentCollectionTracker: window.MonthlyDocumentCollectionTracker,
                                            WeeklyFMSReviewTracker: window.WeeklyFMSReviewTracker
                                        }
                                    }));
                                }
                            } else if (hasMonthly) {
                                console.log('‚è≥ MonthlyDocumentCollectionTracker available, waiting for WeeklyFMSReviewTracker...');
                            } else if (hasWeekly) {
                                console.log('‚è≥ WeeklyFMSReviewTracker available, waiting for MonthlyDocumentCollectionTracker...');
                            }
                        }, 100);
                        setTimeout(() => {
                            clearInterval(checkExisting);
                            // Dispatch event even if not fully loaded
                            if (typeof window.dispatchEvent === 'function') {
                                const detail = {};
                                if (window.MonthlyDocumentCollectionTracker) detail.MonthlyDocumentCollectionTracker = window.MonthlyDocumentCollectionTracker;
                                if (window.WeeklyFMSReviewTracker) detail.WeeklyFMSReviewTracker = window.WeeklyFMSReviewTracker;
                                if (Object.keys(detail).length > 0) {
                                    window.dispatchEvent(new CustomEvent('viteProjectsReady', { detail }));
                                }
                            }
                        }, 10000); // Increased timeout to 10 seconds
                        return;
                    } else {
                        console.log('üóëÔ∏è Removing existing script with wrong version:', src);
                        existingScript.remove();
                    }
                }
                
                const script = document.createElement('script');
                script.type = 'module';
                // Cache busting with version - update this when deploying new changes
                // IMPORTANT: This version must match the one used above
                // NOTE: The Vite projects bundle is served from the /vite-projects static path on the server
                script.src = '/vite-projects/projects-module.js?v=' + VITE_PROJECTS_VERSION + '&t=' + Date.now() + '&_=' + Math.random().toString(36).substring(7);
                console.log('üì¶ Loading vite projects module from /vite-projects with version:', VITE_PROJECTS_VERSION);
                script.onload = () => {
                    console.log('‚úÖ Vite Projects module script loaded successfully');
                    // Poll for both components to become available (more robust than fixed timeout)
                    let attempts = 0;
                    const maxAttempts = 50; // 5 seconds (50 * 100ms) - increased for slower connections
                    const checkComponents = setInterval(() => {
                        attempts++;
                        const hasMonthly = window.MonthlyDocumentCollectionTracker && typeof window.MonthlyDocumentCollectionTracker === 'function';
                        const hasWeekly = window.WeeklyFMSReviewTracker && typeof window.WeeklyFMSReviewTracker === 'function';
                        
                        if (hasMonthly && hasWeekly) {
                            console.log('‚úÖ Both MonthlyDocumentCollectionTracker and WeeklyFMSReviewTracker available after script load (attempt ' + attempts + ')');
                            clearInterval(checkComponents);
                            // Ensure event is dispatched with both components
                            if (typeof window.dispatchEvent === 'function') {
                                window.dispatchEvent(new CustomEvent('viteProjectsReady', {
                                    detail: { 
                                        MonthlyDocumentCollectionTracker: window.MonthlyDocumentCollectionTracker,
                                        WeeklyFMSReviewTracker: window.WeeklyFMSReviewTracker
                                    }
                                }));
                                console.log('üì¢ Dispatched viteProjectsReady event after component load (both components)');
                            }
                        } else if (hasMonthly && !hasWeekly) {
                            console.log('‚è≥ MonthlyDocumentCollectionTracker available, waiting for WeeklyFMSReviewTracker... (attempt ' + attempts + ')');
                            if (attempts >= maxAttempts) {
                                console.warn('‚ö†Ô∏è Script loaded but WeeklyFMSReviewTracker not available after ' + maxAttempts + ' attempts');
                                clearInterval(checkComponents);
                                // Dispatch event with what we have
                                if (typeof window.dispatchEvent === 'function') {
                                    window.dispatchEvent(new CustomEvent('viteProjectsReady', {
                                        detail: { 
                                            MonthlyDocumentCollectionTracker: window.MonthlyDocumentCollectionTracker
                                        }
                                    }));
                                }
                            }
                        } else if (!hasMonthly && hasWeekly) {
                            console.log('‚è≥ WeeklyFMSReviewTracker available, waiting for MonthlyDocumentCollectionTracker... (attempt ' + attempts + ')');
                            if (attempts >= maxAttempts) {
                                console.warn('‚ö†Ô∏è Script loaded but MonthlyDocumentCollectionTracker not available after ' + maxAttempts + ' attempts');
                                clearInterval(checkComponents);
                                // Dispatch event with what we have
                                if (typeof window.dispatchEvent === 'function') {
                                    window.dispatchEvent(new CustomEvent('viteProjectsReady', {
                                        detail: { 
                                            WeeklyFMSReviewTracker: window.WeeklyFMSReviewTracker
                                        }
                                    }));
                                }
                            }
                        } else if (attempts >= maxAttempts) {
                            console.warn('‚ö†Ô∏è Script loaded but neither component available after ' + maxAttempts + ' attempts');
                            console.warn('‚ö†Ô∏è Available window components:', Object.keys(window).filter(k => k.includes('Project') || k.includes('Tracker') || k.includes('Modal')));
                            clearInterval(checkComponents);
                        }
                    }, 100);
                };
                script.onerror = (error) => {
                    console.error('‚ùå Failed to load Vite Projects module script:', error);
                    console.error('‚ùå Script URL:', script.src);
                    console.error('‚ùå Please check that the file exists at: dist/vite-projects/projects-module.js');
                    console.error('‚ùå This may be a server configuration issue (502 Bad Gateway suggests nginx/backend misconfiguration)');
                    
                    // Check if components might be available from another source
                    // (they might have been loaded from the main app build instead)
                    setTimeout(() => {
                        const hasMonthly = window.MonthlyDocumentCollectionTracker && typeof window.MonthlyDocumentCollectionTracker === 'function';
                        const hasWeekly = window.WeeklyFMSReviewTracker && typeof window.WeeklyFMSReviewTracker === 'function';
                        
                        if (hasMonthly || hasWeekly) {
                            const detail = {};
                            if (hasMonthly) {
                                detail.MonthlyDocumentCollectionTracker = window.MonthlyDocumentCollectionTracker;
                                console.log('‚úÖ MonthlyDocumentCollectionTracker found from alternative source');
                            }
                            if (hasWeekly) {
                                detail.WeeklyFMSReviewTracker = window.WeeklyFMSReviewTracker;
                                console.log('‚úÖ WeeklyFMSReviewTracker found from alternative source');
                            }
                            
                            // Dispatch event anyway so dependent components can proceed
                            if (typeof window.dispatchEvent === 'function' && Object.keys(detail).length > 0) {
                                window.dispatchEvent(new CustomEvent('viteProjectsReady', { detail }));
                                console.log('üì¢ Dispatched viteProjectsReady event with available components');
                            }
                            
                            if (!hasMonthly) {
                                console.warn('‚ö†Ô∏è MonthlyDocumentCollectionTracker not available - monthly document collection features may be limited');
                            }
                            if (!hasWeekly) {
                                console.warn('‚ö†Ô∏è WeeklyFMSReviewTracker not available - weekly FMS checklist features may be limited');
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Neither MonthlyDocumentCollectionTracker nor WeeklyFMSReviewTracker available - some features may be limited');
                            console.warn('‚ö†Ô∏è To fix: Ensure vite-projects files are built and deployed to the server');
                            console.warn('‚ö†Ô∏è Run: npm run build:vite-projects && deploy dist/vite-projects/ to server');
                        }
                    }, 2000); // Check after 2 seconds to allow other loaders to complete
                };
                document.head.appendChild(script);
                
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                // Cache busting with version - update this when deploying new changes
                // Served from the same /vite-projects static route as the JS bundle
                link.href = '/vite-projects/projects-index.css?v=' + VITE_PROJECTS_VERSION;
                link.onerror = () => console.warn('‚ö†Ô∏è Failed to load Vite Projects CSS');
                document.head.appendChild(link);
                console.log('‚úÖ Vite Projects module loading...');
                console.log('üì¶ Script URL:', script.src);
                console.log('üì¶ CSS URL:', link.href);
            } else {
                // Retry after a short delay
                setTimeout(loadViteProjectsModule, 50);
            }
        }
        
        // Start loading when React is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadViteProjectsModule);
        } else {
            loadViteProjectsModule();
        }
        
        // Also listen for React ready event as fallback
        window.addEventListener('babelready', () => {
            const hasMonthly = window.MonthlyDocumentCollectionTracker && typeof window.MonthlyDocumentCollectionTracker === 'function';
            const hasWeekly = window.WeeklyFMSReviewTracker && typeof window.WeeklyFMSReviewTracker === 'function';
            if (!hasMonthly || !hasWeekly) {
                console.log('üîÑ babelready event received, checking Vite module... (missing:', !hasMonthly ? 'MonthlyDocumentCollectionTracker' : '', !hasWeekly ? 'WeeklyFMSReviewTracker' : '', ')');
                loadViteProjectsModule();
            }
        });
    </script>
    
    <!-- Lazy loader - CACHE BUST 20260108-deep-link-fix-v1 -->
    <!-- Prefetch for faster lazy loading -->
    <link rel="prefetch" href="/lazy-load-components.js?v=20260112-3248496" as="script">
    <script defer src="/lazy-load-components.js?v=20260112-3248496"></script>
    
    <!-- Mobile Detection and Responsive Component Loading -->
    <script>
        window.addEventListener('corebundle:ready', () => {
            // Mobile detection utility - more restrictive to avoid desktop interference
            window.isMobile = () => {
                return window.innerWidth <= 640 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            };
            
            // Responsive component wrapper (needs React, but React is loaded by now)
            window.ResponsiveComponent = ({ mobileComponent, desktopComponent, children }) => {
                if (!window.React || !window.React.useState) return children;
                const [isMobile, setIsMobile] = window.React.useState(window.isMobile());
                
                window.React.useEffect(() => {
                    const handleResize = () => {
                        setIsMobile(window.isMobile());
                    };
                    
                    window.addEventListener('resize', handleResize);
                    return () => window.removeEventListener('resize', handleResize);
                }, []);
                
                if (isMobile && mobileComponent) {
                    return window.React.createElement(mobileComponent, children?.props || {});
                } else if (desktopComponent) {
                    return window.React.createElement(desktopComponent, children?.props || {});
                }
                
                return children;
            };
            
            // Set up components for immediate loading
            // Use original components with full functionality
            // Prioritize DashboardLive for drag-drop and resize features
            window.Dashboard = window.DashboardLive || window.DashboardSimple || window.DashboardFallback || window.DashboardDatabaseFirst || window.DashboardFallback;
            
            // üöÄ FORCE USE ONLY Clients.jsx (has Pipeline opportunity fixes)
            // Wait for Clients to load before checking (deferred check)
            setTimeout(() => {
                if (window.Clients) {
                    console.log('‚úÖ Using window.Clients (Pipeline fixes enabled)');
                } else {
                    const clientsScripts = Array.from(document.querySelectorAll('script[src*="Clients"]'));
                    const loading = clientsScripts.some(s => !s.complete);
                    if (loading) {
                        setTimeout(() => {
                            if (window.Clients) {
                                console.log('‚úÖ window.Clients loaded after delay');
                            }
                        }, 2000);
                    }
                }
            }, 3000); // Check after lazy loading has started
            // Use the main Projects component (has latest fixes) with fallback
            window.Projects = window.Projects || window.ProjectsDatabaseFirst || window.ProjectsSimple;
            // Use main Teams component, fallback to TeamsSimple only if main fails
            window.Teams = window.Teams || window.TeamsSimple;
            window.TimeTracking = window.TimeTracking || window.TimeTrackingDatabaseFirst;
            window.Invoicing = window.InvoicingDatabaseFirst || window.QuickInvoicing;
            // Ensure Manufacturing is available - check after lazy loading
            setTimeout(() => {
                if (!window.Manufacturing) {
                    const scripts = Array.from(document.querySelectorAll('script[src*="Manufacturing"]'));
                    const stillLoading = scripts.some(s => !s.complete || s.readyState === 'loading');
                    if (stillLoading) {
                        setTimeout(() => {
                            if (window.Manufacturing) {
                                console.log('‚úÖ Manufacturing component loaded after delay');
                            } else {
                                const scriptsAfterDelay = Array.from(document.querySelectorAll('script[src*="Manufacturing"]'));
                                const stillLoadingAfterDelay = scriptsAfterDelay.some(s => !s.complete || s.readyState === 'loading');
                                if (!stillLoadingAfterDelay && scriptsAfterDelay.length > 0) {
                                    console.warn('‚ö†Ô∏è Manufacturing not loaded after delay - check for errors');
                                }
                            }
                        }, 2000);
                    } else if (scripts.length > 0) {
                        setTimeout(() => {
                            if (!window.Manufacturing) {
                                console.warn('‚ö†Ô∏è Manufacturing scripts loaded but component not registered - check for JS errors');
                            }
                        }, 1000);
                    }
                } else {
                    console.log('‚úÖ Manufacturing component available:', typeof window.Manufacturing);
                }
            }, 3000); // Check after lazy loading has started
            
            // Listen for manufacturingComponentReady event
            window.addEventListener('manufacturingComponentReady', () => {
                if (window.Manufacturing) {
                    console.log('‚úÖ Manufacturing component ready event received');
                }
            });
            
            // Only show error after a longer delay if still not loaded
            // Increased timeout to 20 seconds to account for lazy loading delays
            setTimeout(() => {
                if (!window.Manufacturing) {
                    const scripts = Array.from(document.querySelectorAll('script[src*="Manufacturing"]'));
                    
                    // Check if scripts are still loading (lazy loading in progress)
                    const stillLoading = scripts.some(s => {
                        // Check if script is still loading
                        if (s.readyState && s.readyState !== 'complete' && s.readyState !== 'loaded') {
                            return true;
                        }
                        // Check if script was just added (might not have loaded yet)
                        if (s.async || s.defer) {
                            // For async/defer scripts, check if they're in the DOM but not executed
                            return !s.complete && !s.onerror;
                        }
                        return false;
                    });
                    
                    // If scripts are still loading, wait a bit more before showing error
                    if (stillLoading && scripts.length > 0) {
                        console.log('‚è≥ Manufacturing component still loading, waiting a bit longer...');
                        setTimeout(() => {
                            if (!window.Manufacturing) {
                                // Now check again after additional wait
                                const scriptsAfterWait = Array.from(document.querySelectorAll('script[src*="Manufacturing"]'));
                                const errorInScript = scriptsAfterWait.some(s => {
                                    try {
                                        return s.onerror !== null;
                                    } catch (e) {
                                        return false;
                                    }
                                });
                                
                                // Only show error if scripts have finished loading
                                const allComplete = scriptsAfterWait.every(s => 
                                    s.readyState === 'complete' || s.readyState === 'loaded' || s.complete
                                );
                                
                                if (allComplete && !errorInScript) {
                                    console.warn('‚ö†Ô∏è Manufacturing component not registered after scripts loaded');
                                    console.warn('   ‚Üí Component may still be initializing, check console for registration messages');
                                } else if (errorInScript) {
                                    console.error('‚ùå Manufacturing script loading errors detected');
                                    console.error('   ‚Üí Check network tab for failed requests');
                                }
                            }
                        }, 5000); // Wait 5 more seconds
                        return;
                    }
                    
                    const errorInScript = scripts.some(s => {
                        try {
                            return s.onerror !== null;
                        } catch (e) {
                            return false;
                        }
                    });
                    
                    // Only show error if no scripts found (component not being loaded at all)
                    // or if scripts have errors
                    if (scripts.length === 0) {
                        console.warn('‚ö†Ô∏è No Manufacturing scripts found - component may be lazy loaded later');
                        console.warn('   ‚Üí This is normal if Manufacturing page hasn\'t been accessed yet');
                    } else if (errorInScript) {
                        console.error('‚ùå Manufacturing script loading errors detected');
                        console.error('   ‚Üí Check network tab for failed requests');
                        console.error('   ‚Üí Verify /dist/src/components/manufacturing/Manufacturing.js exists');
                    } else {
                        // Scripts loaded but component not registered - might still be initializing
                        console.warn('‚ö†Ô∏è Manufacturing scripts loaded but component not yet registered');
                        console.warn('   ‚Üí Component may still be initializing (check for registration messages above)');
                        console.warn('   ‚Üí This is normal during lazy loading - component will be available when needed');
                    }
                }
            }, 20000); // Increased to 20 seconds to account for lazy loading
            // Late bind Clients if it registers after this script
            // NOTE: Only bind main Clients component - ClientsSimple has been removed
            (function() {
                function bindClients() {
                    if (!window.Clients) {
                        // Only use main Clients component - no fallback to ClientsSimple
                        window.Clients = window.Clients || window.ClientsDatabaseFirst || window.ClientsCached;
                        if (window.Clients) {
                            console.log('‚úÖ Bound window.Clients dynamically');
                        }
                    }
                }
                bindClients();
                let tries = 0;
                const t = setInterval(() => {
                    if (window.Clients || ++tries > 10) return clearInterval(t);
                    bindClients();
                }, 300);
            })();
        });
    </script>
    
    <!-- App Entry Point - App component is registered by core bundle -->
    <script>
        // Verify App loaded with retry mechanism (handles network delays)
        let appCheckAttempts = 0;
        let appCheckStopped = false;
        let appCheckTimeoutId = null;
        const maxAppCheckAttempts = 20; // 10 seconds total (20 * 500ms)
        function checkAppLoaded() {
            // Stop if already checked max attempts
            if (appCheckStopped) {
                return false;
            }
            
            appCheckAttempts++;
            if (window.App) {
                console.log('‚úÖ App component loaded');
                appCheckStopped = true;
                if (appCheckTimeoutId) {
                    clearTimeout(appCheckTimeoutId);
                    appCheckTimeoutId = null;
                }
                return true;
            }
            if (appCheckAttempts >= maxAppCheckAttempts) {
                console.warn('‚ö†Ô∏è App component not loaded after 10 seconds - checking for network errors');
                console.warn('If you see network errors above, the server may be experiencing connectivity issues');
                console.warn('The fast-loader will continue trying to mount the app...');
                appCheckStopped = true;
                if (appCheckTimeoutId) {
                    clearTimeout(appCheckTimeoutId);
                    appCheckTimeoutId = null;
                }
                return false;
            }
            appCheckTimeoutId = setTimeout(checkAppLoaded, 500);
            return false;
        }
        appCheckTimeoutId = setTimeout(checkAppLoaded, 1000); // Start checking after 1 second
    </script>
    
    
    <!-- Mount App - Fast loader for immediate mounting -->
    <link rel="preload" href="/fast-loader.js" as="script">
    <script defer src="/fast-loader.js"></script>
    
    <!-- Simple fallback mount - only if fast-loader didn't mount -->
    <script>
        setTimeout(() => {
            if (!window.__appMounted && window.React && window.ReactDOM && window.App) {
                try {
                    const root = document.getElementById('root');
                    if (root && !root._reactRootContainer) {
                        if (window.__reactRoot) {
                            window.__reactRoot.render(window.React.createElement(window.App));
                        } else {
                            const reactRoot = window.ReactDOM.createRoot(root);
                            window.__reactRoot = reactRoot;
                            reactRoot.render(window.React.createElement(window.App));
                        }
                        window.__appMounted = true;
                        console.log('‚úÖ App mounted by fallback loader');
                    }
                } catch (error) {
                    console.error('‚ùå Mount error:', error);
                }
            }
            // Note: fast-loader tries for 15 seconds, so don't warn here
            // If fast-loader fails, it will show its own error message
        }, 3000);
    </script>
    
    <!-- Final safety: keep DatabaseAPI.getProject available even if overwritten later -->
    <script>
        (function() {
            function ensureGetProject() {
                try {
                    if (!window.DatabaseAPI) window.DatabaseAPI = {};
                    if (typeof window.DatabaseAPI.getProject !== 'function') {
                        window.DatabaseAPI.getProject = async function(id) {
                            try {
                                if (window.api && typeof window.api.getProject === 'function') {
                                    return await window.api.getProject(id);
                                }
                            } catch (e) {
                                // fall through
                            }
                            const res = await fetch(`/api/projects/${id}`, {
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                                }
                            });
                            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                            const data = await res.json();
                            return data?.data ? data : { data: { project: data.project || data.data || data } };
                        };
                        console.log('üß© Ensured DatabaseAPI.getProject (final safety)');
                    }
                } catch (err) {
                    // ignore
                }
            }
            // Run now, on load, and briefly after to cover late overrides
            ensureGetProject();
            window.addEventListener('load', ensureGetProject);
            let tries = 0;
            const t = setInterval(() => {
                ensureGetProject();
                if (++tries >= 10) clearInterval(t);
            }, 500);
        })();
    </script>
</body>
</html>
