<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#0284c7">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Abcotronics">
    <title>Abcotronics - Fuel Management Services</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Tailwind CSS - Production Build -->
    <link rel="preload" href="./dist/styles.css?v=20251112-list-view" as="style">
    <link rel="stylesheet" href="./dist/styles.css?v=20251112-list-view">
    
    <!-- Resource hints for faster loading -->
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <!-- Early theme boot: CRITICAL - Never apply dark mode when user wants light mode -->
    <script>
        (function() {
            try {
                var root = document.documentElement;
                var storedTheme = localStorage.getItem('abcotronics_theme');
                var useSystemTheme = localStorage.getItem('abcotronics_use_system_theme') === 'true';
                
                // CRITICAL: If user explicitly chose light mode and is NOT following system,
                // NEVER apply dark mode - force light mode always
                if (!useSystemTheme && storedTheme === 'light') {
                    root.classList.remove('light','dark');
                    root.classList.add('light');
                    localStorage.setItem('abcotronics_theme', 'light');
                    localStorage.setItem('abcotronics_use_system_theme', 'false');
                    return;
                }
                
                // If following system, check system preference
                if (useSystemTheme) {
                    var systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    var themeToApply = systemPrefersDark ? 'dark' : 'light';
                    root.classList.remove('light','dark');
                    root.classList.add(themeToApply);
                    localStorage.setItem('abcotronics_theme', themeToApply);
                    return;
                }
                
                // Default: light mode (first time user or no preference)
                var themeToApply = (storedTheme === 'dark') ? 'dark' : 'light';
                root.classList.remove('light','dark');
                root.classList.add(themeToApply);
                localStorage.setItem('abcotronics_theme', themeToApply);
                localStorage.setItem('abcotronics_use_system_theme', 'false');
            } catch (e) {}
        })();
    </script>
    
    <!-- Cache Clearing Script - Runs early to clear stale cache -->
    <script>
        (function() {
            // Check if we need to force clear cache (via URL parameter or localStorage flag)
            try {
                var urlParams = new URLSearchParams(window.location.search);
                var hashParams = new URLSearchParams((window.location.hash || '').split('?')[1] || '');
                var shouldClearCache = urlParams.has('clearCache') || 
                                      urlParams.has('forceRefresh') || 
                                      hashParams.has('clearCache') || 
                                      hashParams.has('forceRefresh') ||
                                      localStorage.getItem('abcotronics_force_clear_cache') === 'true';
                
                if (shouldClearCache) {
                    console.log('üßπ Force clearing cache on page load...');
                    // Clear localStorage cache flags
                    localStorage.removeItem('abcotronics_force_clear_cache');
                    
                    // Clear sessionStorage
                    try {
                        sessionStorage.clear();
                    } catch (e) {
                        console.warn('Could not clear sessionStorage:', e);
                    }
                    
                    // Set a flag for when DatabaseAPI loads to clear its cache
                    window.__CLEAR_DATABASE_CACHE_ON_LOAD__ = true;
                    
                    // Remove refresh parameters from URL
                    if (urlParams.has('clearCache') || urlParams.has('forceRefresh')) {
                        urlParams.delete('clearCache');
                        urlParams.delete('forceRefresh');
                        var newSearch = urlParams.toString();
                        var newUrl = window.location.pathname + (newSearch ? '?' + newSearch : '') + window.location.hash;
                        window.history.replaceState({}, '', newUrl);
                    }
                    
                    console.log('‚úÖ Cache clear flag set - will clear when DatabaseAPI loads');
                }
            } catch (e) {
                console.warn('Error in cache clearing script:', e);
            }
        })();
    </script>
    
    <!-- Mobile Optimizations CSS -->
    <link rel="stylesheet" href="mobile-optimizations.css">
    
    <!-- Mobile Refresh 2025 - Complete mobile overhaul -->
    <link rel="stylesheet" href="mobile-refresh-2025.css">
    
    <!-- Mobile Critical Fix - Fixes content disappearing below 766px -->
    <link rel="stylesheet" href="mobile-critical-fix.css">
    
    <!-- Mobile NUCLEAR Fix - Most aggressive fix possible -->
    <link rel="stylesheet" href="mobile-nuclear-fix.css?v=20250106-mobile-fix">
    
    <!-- Dark Mode Fixes CSS -->
    <link rel="stylesheet" href="dark-mode-fixes.css">
    
    <!-- Mobile UX Enhancement - Beautiful, modern, user-friendly design (loads ABSOLUTELY LAST) -->
    <link rel="stylesheet" href="mobile-ux-enhancement.css?v=20250106-ux-final-mobile-fix">
    
    <!-- Public Job Card Mobile Overrides -->
    <link rel="stylesheet" href="job-card-public-mobile.css?v=20251112-fix-box-sizes">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    
    <!-- Custom Primary Colors -->
    <style>
        :root {
            --primary-50: #e0f2fe;
            --primary-100: #bae6fd;
            --primary-200: #7dd3fc;
            --primary-300: #38bdf8;
            --primary-400: #0ea5e9;
            --primary-500: #0284c7;
            --primary-600: #0369a1;
            --primary-700: #075985;
            --primary-800: #0c4a6e;
            --primary-900: #082f49;
        }
        .bg-primary-500 { background-color: var(--primary-500); }
        .text-primary-500 { color: var(--primary-500); }
        .border-primary-500 { border-color: var(--primary-500); }
        .hover\:bg-primary-600:hover { background-color: var(--primary-600); }
        .hover\:bg-primary-700:hover { background-color: var(--primary-700); }
    </style>
    <style>
        /* Force login brand white regardless of dark mode overrides */
        .login-brand { color: #ffffff !important; }
        html:not(.dark) h1.login-brand, html:not(.dark) #loginBrand {
            color: #ffffff !important;
            -webkit-text-fill-color: #ffffff !important;
        }
    </style>
    
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            body {
                font-size: 16px; /* Prevents zoom on iOS */
                line-height: 1.5;
            }
            
            /* Prevent horizontal scroll */
            html, body {
                overflow-x: hidden;
                width: 100%;
            }
            
            /* Touch-friendly buttons */
            button, .btn, [role="button"] {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            /* Better form inputs */
            input, textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 8px;
            }
            
            /* Improved scrolling */
            .overflow-y-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Mobile horizontal scrollable navigation tabs */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .overflow-x-auto::-webkit-scrollbar {
                display: none;
            }
            
            /* Ensure tab buttons maintain readable width on mobile */
            .overflow-x-auto button {
                min-width: max-content;
                flex-shrink: 0;
                white-space: nowrap;
            }
            
            /* Mobile table to card conversion */
            .table-responsive {
                display: none;
            }
            
            .table-mobile {
                display: block;
            }
            
            .mobile-card {
                background: white;
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                border: 1px solid #e5e7eb;
            }
            
            .dark .mobile-card {
                background: #1f2937;
                border-color: #374151;
            }
            
            /* Mobile modal optimizations */
            .modal {
                margin: 0;
                max-height: 100vh;
                border-radius: 0;
            }
            
            .modal-dialog {
                margin: 0;
                max-width: 100%;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            
            .modal-content {
                flex: 1;
                border-radius: 0;
                border: none;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        @media (min-width: 769px) {
            .table-mobile {
                display: none;
            }
            
            .table-responsive {
                display: block;
            }
        }
        
        .sidebar-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar-scrollbar::-webkit-scrollbar-thumb {
            background: #0284c7;
            border-radius: 3px;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        /* Mobile-friendly horizontal scrolling - show scrollbar on mobile */
        @media (max-width: 1024px) {
            .scrollbar-hide {
                -ms-overflow-style: auto;
                scrollbar-width: thin;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: block;
                height: 8px;
            }
            .scrollbar-hide::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.3);
                border-radius: 4px;
            }
            .scrollbar-hide::-webkit-scrollbar-track {
                background: rgba(0, 0, 0, 0.05);
            }
        }
        /* Mobile-friendly touch targets */
        @media (max-width: 640px) {
            button, input, select, textarea {
                min-height: 44px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 login-page">
    <div id="root"></div>

    <!-- React Production Builds - Much faster than development -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js" onload="if(typeof React !== 'undefined') { window.React = React; console.log('‚úÖ React loaded'); }" onerror="console.error('‚ùå Failed to load React from CDN');"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" onload="if(typeof React !== 'undefined') { window.React = React; } if(typeof ReactDOM !== 'undefined') { window.ReactDOM = ReactDOM; window.BabelReady = true; window.dispatchEvent(new Event('babelready')); console.log('‚úÖ ReactDOM loaded'); }" onerror="console.error('‚ùå Failed to load ReactDOM from CDN');"></script>
    
    <!-- Verify React loaded and expose globally (fallback) -->
    <script>
        // Fallback check after scripts load
        setTimeout(() => {
            if (typeof React !== 'undefined') {
                window.React = React;
                console.log('‚úÖ React verified');
            } else {
                console.error('‚ùå React not loaded - check CDN connection');
            }
            if (typeof ReactDOM !== 'undefined') {
                window.ReactDOM = ReactDOM;
                // Dispatch ready event
                if (!window.BabelReady) {
                    window.BabelReady = true;
                    window.dispatchEvent(new Event('babelready'));
                }
                console.log('‚úÖ ReactDOM verified');
            } else {
                console.error('‚ùå ReactDOM not loaded - check CDN connection');
            }
        }, 1000);
    </script>
    
    <!-- Leaflet JavaScript - Lazy load (only needed for maps) -->
    <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Fix for exports undefined errors -->
    <script>
        // Enhanced polyfill for CommonJS exports in browser environment
        if (typeof exports === 'undefined') {
            window.exports = {};
            window.exports = window.exports || {};
        }
        if (typeof module === 'undefined') {
            window.module = { exports: {} };
            window.module = window.module || { exports: {} };
        }
        if (typeof require === 'undefined') {
            window.require = function() { return {}; };
        }
        if (typeof global === 'undefined') {
            window.global = window;
        }
        if (typeof process === 'undefined') {
            window.process = { env: {} };
        }
        
        // Prevent CommonJS modules from breaking
        window.define = window.define || function() {};
        window.define.amd = false;
    </script>
    
    <!-- Global Error Handlers -->
    <script>
        // Global unhandled promise rejection handler (v3 - ultra-robust database error detection)
        // Updated: 2025-11-04 - Enhanced to detect and suppress database connection errors
        window.addEventListener('unhandledrejection', function(event) {
            try {
                const error = event.reason;
                
                // Extract ALL possible error text sources
                let allErrorText = '';
                
                if (error instanceof Error) {
                    allErrorText = [
                        error.message || '',
                        error.name || '',
                        error.toString(),
                        error.stack || ''
                    ].join(' ').toLowerCase();
                } else if (typeof error === 'string') {
                    allErrorText = error.toLowerCase();
                } else if (error && typeof error === 'object') {
                    allErrorText = [
                        error.message || '',
                        error.error?.message || '',
                        error.reason?.message || '',
                        String(error),
                        JSON.stringify(error).substring(0, 500) // Limit to avoid huge strings
                    ].join(' ').toLowerCase();
                } else {
                    allErrorText = String(error).toLowerCase();
                }
                
                // Check for database connection errors - very broad pattern matching
                // Match ANY indication of database/connection/server issues
                const isDatabaseError = 
                    allErrorText.includes('database connection failed') ||
                    allErrorText.includes('database server is unreachable') ||
                    allErrorText.includes('database server') && allErrorText.includes('unreachable') ||
                    (allErrorText.includes('unreachable') && (allErrorText.includes('database') || allErrorText.includes('server'))) ||
                    allErrorText.includes('contact support if this issue persists') ||
                    allErrorText.includes('please contact support') ||
                    allErrorText.includes('contact support') ||
                    allErrorText.includes('econnrefused') ||
                    allErrorText.includes('etimedout') ||
                    allErrorText.includes('can\'t reach database') ||
                    allErrorText.includes('cannot reach database') ||
                    (allErrorText.includes('connection') && allErrorText.includes('failed') && allErrorText.includes('database')) ||
                    (allErrorText.includes('server') && allErrorText.includes('unreachable'));
                
                // Check for opportunities API errors (500s) - these are server-side issues
                const isOpportunitiesApiError = 
                    allErrorText.includes('failed to list opportunities') ||
                    (allErrorText.includes('opportunities') && (allErrorText.includes('500') || allErrorText.includes('server error'))) ||
                    (allErrorText.includes('/opportunities') && (allErrorText.includes('500') || allErrorText.includes('internal server error')));
                
                // Only log non-database and non-opportunities-api errors
                if (!isDatabaseError && !isOpportunitiesApiError) {
                    console.error('üö® Unhandled Promise Rejection:', {
                        reason: error,
                        promise: event.promise,
                        error: error instanceof Error ? {
                            message: error.message,
                            stack: error.stack,
                            name: error.name
                        } : error,
                        timestamp: new Date().toISOString()
                    });
                }
                // Database errors are silently suppressed - they're expected when DB is down
                
                // Prevent default browser error handling
                event.preventDefault();
                
            } catch (handlerError) {
                // Error handler itself failed - just prevent default
                event.preventDefault();
            }
        });
        
        // Global error handler for JavaScript errors
        window.addEventListener('error', function(event) {
            console.error('üö® Global Error:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error,
                stack: event.error?.stack,
                timestamp: new Date().toISOString()
            });
        });
        
        console.log('‚úÖ Global error handlers registered');
    </script>
    
    <!-- Lazy load heavy libraries when needed -->
    <script>
        // Lazy load PDF.js when PDF to Word converter is used
        window.loadPDFJS = function() {
            if (window.pdfjsLib) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = () => {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };
        
        // Lazy load Tesseract.js when OCR is used
        window.loadTesseract = function() {
            if (window.Tesseract) return Promise.resolve();
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };
    </script>
    
    <!-- Core bundle: critical modules -->
    <script defer src="./dist/core-bundle.js?v=20251114-doc-collection-fix"></script>

    <script>
        window.addEventListener('corebundle:ready', () => {
            try {
                if (window.DatabaseAPI && typeof window.DatabaseAPI.getProject !== 'function') {
                    window.DatabaseAPI.getProject = async function(id) {
                        try {
                            if (window.api && typeof window.api.getProject === 'function') {
                                return await window.api.getProject(id);
                            }
                        } catch (e) {
                            // fall through to direct fetch
                        }
                        const res = await fetch(`/api/projects/${id}`, {
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                            }
                        });
                        if (!res.ok) {
                            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                        }
                        const data = await res.json();
                        return data?.data ? data : { data: { project: data.project || data.data || data } };
                    };
                    console.log('üß© Shimmed DatabaseAPI.getProject at runtime');
                }
            } catch (err) {
                console.warn('DatabaseAPI.getProject shim failed:', err);
            }
        });
    </script>

    <script>
        window.addEventListener('corebundle:ready', () => {
            if (!window.AuthProvider || !window.useAuth) {
                console.error('‚ùå CRITICAL: AuthProvider not available after core bundle');
            } else {
                console.log('‚úÖ AuthProvider loaded successfully');
            }
        });
    </script>

    <script>
        window.addEventListener('corebundle:ready', () => {
            function patchApiLogin() {
                try {
                    if (!window.api || window.__apiLoginPatched) return;
                    const originalLogin = window.api.login;
                    if (typeof originalLogin !== 'function') return;
                    window.api.login = async function(email, password) {
                        try {
                            return await originalLogin(email, password);
                        } catch (err) {
                            try {
                                const res = await fetch(window.location.origin + '/api/auth/login', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    credentials: 'include',
                                    body: JSON.stringify({ email, password })
                                });
                                const text = await res.text();
                                const data = text ? JSON.parse(text) : {};
                                if (!res.ok) {
                                    const errorMessage = data?.error?.message || data?.message || `Request failed with status ${res.status}`;
                                    const error = new Error(errorMessage);
                                    error.status = res.status;
                                    throw error;
                                }
                                if (data?.accessToken) {
                                    window.storage?.setToken?.(data.accessToken);
                                } else if (data?.data?.accessToken) {
                                    window.storage?.setToken?.(data.data.accessToken);
                                } else {
                                    throw new Error('No access token received from login');
                                }
                                return data;
                            } catch (fallbackErr) {
                                throw fallbackErr;
                            }
                        }
                    };
                    window.__apiLoginPatched = true;
                    console.log('üß© Patched api.login to fallback to /auth/login');
                } catch (_) {}
            }
            patchApiLogin();
            window.addEventListener('load', patchApiLogin, { once: true });
        });
    </script>

    <!-- Lazy Load Non-Critical Components -->
    <!-- Vite Projects Module - Load before lazy-load-components so components are available -->
    <!-- Vite Projects Module - Load after React is confirmed available -->
    <script>
        // Wait for React to be available before loading Vite module
        function loadViteProjectsModule() {
            // More robust check - ensure React and its hooks are available
            if (typeof window.React !== 'undefined' && 
                window.React !== null && 
                typeof window.React.useState === 'function' &&
                typeof window.React.useEffect === 'function' &&
                typeof window.React.useRef === 'function') {
                
                // Check if already loaded
                if (window.MonthlyDocumentCollectionTracker && typeof window.MonthlyDocumentCollectionTracker === 'function') {
                    console.log('‚úÖ Vite Projects module already loaded');
                    // Dispatch event even if already loaded (for components that missed it)
                    if (typeof window.dispatchEvent === 'function') {
                        window.dispatchEvent(new CustomEvent('viteProjectsReady', {
                            detail: { 
                                Projects: window.Projects,
                                ProjectDetail: window.ProjectDetail,
                                ProjectModal: window.ProjectModal,
                                MonthlyDocumentCollectionTracker: window.MonthlyDocumentCollectionTracker 
                            }
                        }));
                    }
                    return;
                }
                
                // Check if script already exists
                const existingScript = document.querySelector('script[src*="projects-module.js"]');
                if (existingScript) {
                    console.log('‚úÖ Vite Projects module script already added, waiting for load...');
                    // Listen for the component to become available
                    const checkExisting = setInterval(() => {
                        if (window.MonthlyDocumentCollectionTracker && typeof window.MonthlyDocumentCollectionTracker === 'function') {
                            console.log('‚úÖ MonthlyDocumentCollectionTracker became available from existing script');
                            clearInterval(checkExisting);
                        }
                    }, 100);
                    setTimeout(() => clearInterval(checkExisting), 5000);
                    return;
                }
                
                const script = document.createElement('script');
                script.type = 'module';
                script.src = './dist/vite-projects/projects-module.js?v=' + Date.now();
                script.onload = () => {
                    console.log('‚úÖ Vite Projects module script loaded successfully');
                    // Poll for components to become available (more robust than fixed timeout)
                    let attempts = 0;
                    const maxAttempts = 30; // 3 seconds (30 * 100ms)
                    const checkComponents = setInterval(() => {
                        attempts++;
                        if (window.MonthlyDocumentCollectionTracker && typeof window.MonthlyDocumentCollectionTracker === 'function') {
                            console.log('‚úÖ MonthlyDocumentCollectionTracker available after script load (attempt ' + attempts + ')');
                            clearInterval(checkComponents);
                            // Ensure event is dispatched
                            if (typeof window.dispatchEvent === 'function') {
                                window.dispatchEvent(new CustomEvent('viteProjectsReady', {
                                    detail: { 
                                        Projects: window.Projects,
                                        ProjectDetail: window.ProjectDetail,
                                        ProjectModal: window.ProjectModal,
                                        MonthlyDocumentCollectionTracker: window.MonthlyDocumentCollectionTracker 
                                    }
                                }));
                                console.log('üì¢ Dispatched viteProjectsReady event after component load');
                            }
                        } else if (attempts >= maxAttempts) {
                            console.warn('‚ö†Ô∏è Script loaded but MonthlyDocumentCollectionTracker not available after ' + maxAttempts + ' attempts');
                            console.warn('‚ö†Ô∏è Available window components:', Object.keys(window).filter(k => k.includes('Project') || k.includes('Tracker') || k.includes('Modal')));
                            clearInterval(checkComponents);
                        }
                    }, 100);
                };
                script.onerror = (error) => {
                    console.error('‚ùå Failed to load Vite Projects module script:', error);
                    console.error('‚ùå Script URL:', script.src);
                    console.error('‚ùå Please check that the file exists at: dist/vite-projects/projects-module.js');
                };
                document.head.appendChild(script);
                
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = './dist/vite-projects/projects-index.css?v=' + Date.now();
                link.onerror = () => console.warn('‚ö†Ô∏è Failed to load Vite Projects CSS');
                document.head.appendChild(link);
                console.log('‚úÖ Vite Projects module loading...');
            } else {
                // Retry after a short delay
                setTimeout(loadViteProjectsModule, 50);
            }
        }
        
        // Start loading when React is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadViteProjectsModule);
        } else {
            loadViteProjectsModule();
        }
        
        // Also listen for React ready event as fallback
        window.addEventListener('babelready', () => {
            if (!window.MonthlyDocumentCollectionTracker) {
                console.log('üîÑ babelready event received, checking Vite module...');
                loadViteProjectsModule();
            }
        });
    </script>
    
    <script defer src="./lazy-load-components.js?v=20251114-doc-collection-fix"></script>
    
    <!-- Mobile Detection and Responsive Component Loading -->
    <script>
        window.addEventListener('corebundle:ready', () => {
            // Mobile detection utility - more restrictive to avoid desktop interference
            window.isMobile = () => {
                return window.innerWidth <= 640 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            };
            
            // Responsive component wrapper (needs React, but React is loaded by now)
            window.ResponsiveComponent = ({ mobileComponent, desktopComponent, children }) => {
                if (!window.React || !window.React.useState) return children;
                const [isMobile, setIsMobile] = window.React.useState(window.isMobile());
                
                window.React.useEffect(() => {
                    const handleResize = () => {
                        setIsMobile(window.isMobile());
                    };
                    
                    window.addEventListener('resize', handleResize);
                    return () => window.removeEventListener('resize', handleResize);
                }, []);
                
                if (isMobile && mobileComponent) {
                    return window.React.createElement(mobileComponent, children?.props || {});
                } else if (desktopComponent) {
                    return window.React.createElement(desktopComponent, children?.props || {});
                }
                
                return children;
            };
            
            // Set up components for immediate loading
            // Use original components with full functionality
            // Temporarily prioritize DashboardSimple to avoid cached DashboardLive errors
            window.Dashboard = window.DashboardSimple || window.DashboardFallback || window.DashboardDatabaseFirst || window.DashboardLive || window.DashboardFallback;
            
            // üöÄ FORCE USE ONLY Clients.jsx (has Pipeline opportunity fixes)
            // Wait for Clients to load before checking (deferred check)
            setTimeout(() => {
                if (window.Clients) {
                    console.log('‚úÖ Using window.Clients (Pipeline fixes enabled)');
                } else {
                    const clientsScripts = Array.from(document.querySelectorAll('script[src*="Clients"]'));
                    const loading = clientsScripts.some(s => !s.complete);
                    if (loading) {
                        setTimeout(() => {
                            if (window.Clients) {
                                console.log('‚úÖ window.Clients loaded after delay');
                            }
                        }, 2000);
                    }
                }
            }, 3000); // Check after lazy loading has started
            // Use the main Projects component (has latest fixes) with fallback
            window.Projects = window.Projects || window.ProjectsDatabaseFirst || window.ProjectsSimple;
            // Use main Teams component, fallback to TeamsSimple only if main fails
            window.Teams = window.Teams || window.TeamsSimple;
            window.TimeTracking = window.TimeTracking || window.TimeTrackingDatabaseFirst;
            window.Invoicing = window.InvoicingDatabaseFirst || window.QuickInvoicing;
            // Ensure Manufacturing is available - check after lazy loading
            setTimeout(() => {
                if (!window.Manufacturing) {
                    const scripts = Array.from(document.querySelectorAll('script[src*="Manufacturing"]'));
                    const stillLoading = scripts.some(s => !s.complete || s.readyState === 'loading');
                    if (stillLoading) {
                        setTimeout(() => {
                            if (window.Manufacturing) {
                                console.log('‚úÖ Manufacturing component loaded after delay');
                            } else {
                                const scriptsAfterDelay = Array.from(document.querySelectorAll('script[src*="Manufacturing"]'));
                                const stillLoadingAfterDelay = scriptsAfterDelay.some(s => !s.complete || s.readyState === 'loading');
                                if (!stillLoadingAfterDelay && scriptsAfterDelay.length > 0) {
                                    console.warn('‚ö†Ô∏è Manufacturing not loaded after delay - check for errors');
                                }
                            }
                        }, 2000);
                    } else if (scripts.length > 0) {
                        setTimeout(() => {
                            if (!window.Manufacturing) {
                                console.warn('‚ö†Ô∏è Manufacturing scripts loaded but component not registered - check for JS errors');
                            }
                        }, 1000);
                    }
                } else {
                    console.log('‚úÖ Manufacturing component available:', typeof window.Manufacturing);
                }
            }, 3000); // Check after lazy loading has started
            
            // Only show error after a longer delay if still not loaded
            setTimeout(() => {
                if (!window.Manufacturing) {
                    const scripts = Array.from(document.querySelectorAll('script[src*="Manufacturing"]'));
                    const errorInScript = scripts.some(s => {
                        try {
                            return s.onerror !== null;
                        } catch (e) {
                            return false;
                        }
                    });
                    if (errorInScript || scripts.length === 0) {
                        console.error('‚ùå Manufacturing component failed to load after 10 seconds');
                        console.error('‚ùå Check browser console for JavaScript errors in Manufacturing.jsx');
                    }
                }
            }, 10000);
            // Late bind Clients if it registers after this script
            (function() {
                function bindClients() {
                    if (!window.Clients) {
                        window.Clients = window.Clients || window.ClientsDatabaseFirst || window.ClientsSimple || window.ClientsCached;
                        if (window.Clients) {
                            console.log('‚úÖ Bound window.Clients dynamically');
                        }
                    }
                }
                bindClients();
                let tries = 0;
                const t = setInterval(() => {
                    if (window.Clients || ++tries > 10) return clearInterval(t);
                    bindClients();
                }, 300);
            })();
        });
    </script>
    
    <!-- App Entry Point - App component is registered by core bundle -->
    <script>
        // Verify App loaded with retry mechanism (handles network delays)
        let appCheckAttempts = 0;
        const maxAppCheckAttempts = 20; // 10 seconds total (20 * 500ms)
        function checkAppLoaded() {
            appCheckAttempts++;
            if (window.App) {
                console.log('‚úÖ App component loaded');
                return true;
            }
            if (appCheckAttempts >= maxAppCheckAttempts) {
                console.warn('‚ö†Ô∏è App component not loaded after 10 seconds - checking for network errors');
                console.warn('If you see network errors above, the server may be experiencing connectivity issues');
                console.warn('The fast-loader will continue trying to mount the app...');
                return false;
            }
            setTimeout(checkAppLoaded, 500);
            return false;
        }
        setTimeout(checkAppLoaded, 1000); // Start checking after 1 second
    </script>
    
    
    <!-- Mount App - Fast loader for immediate mounting -->
    <script defer src="./fast-loader.js"></script>
    
    <!-- Simple fallback mount - only if fast-loader didn't mount -->
    <script>
        setTimeout(() => {
            if (!window.__appMounted && window.React && window.ReactDOM && window.App) {
                try {
                    const root = document.getElementById('root');
                    if (root && !root._reactRootContainer) {
                        if (window.__reactRoot) {
                            window.__reactRoot.render(window.React.createElement(window.App));
                        } else {
                            const reactRoot = window.ReactDOM.createRoot(root);
                            window.__reactRoot = reactRoot;
                            reactRoot.render(window.React.createElement(window.App));
                        }
                        window.__appMounted = true;
                        console.log('‚úÖ App mounted by fallback loader');
                    }
                } catch (error) {
                    console.error('‚ùå Mount error:', error);
                }
            }
            // Note: fast-loader tries for 15 seconds, so don't warn here
            // If fast-loader fails, it will show its own error message
        }, 3000);
    </script>
    
    <!-- Final safety: keep DatabaseAPI.getProject available even if overwritten later -->
    <script>
        (function() {
            function ensureGetProject() {
                try {
                    if (!window.DatabaseAPI) window.DatabaseAPI = {};
                    if (typeof window.DatabaseAPI.getProject !== 'function') {
                        window.DatabaseAPI.getProject = async function(id) {
                            try {
                                if (window.api && typeof window.api.getProject === 'function') {
                                    return await window.api.getProject(id);
                                }
                            } catch (e) {
                                // fall through
                            }
                            const res = await fetch(`/api/projects/${id}`, {
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                                }
                            });
                            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                            const data = await res.json();
                            return data?.data ? data : { data: { project: data.project || data.data || data } };
                        };
                        console.log('üß© Ensured DatabaseAPI.getProject (final safety)');
                    }
                } catch (err) {
                    // ignore
                }
            }
            // Run now, on load, and briefly after to cover late overrides
            ensureGetProject();
            window.addEventListener('load', ensureGetProject);
            let tries = 0;
            const t = setInterval(() => {
                ensureGetProject();
                if (++tries >= 10) clearInterval(t);
            }, 500);
        })();
    </script>
</body>
</html>
