<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Cleanup Utility - Abcotronics ERP</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0284c7;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #0284c7;
        }
        button {
            background: #0284c7;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
        }
        button:hover {
            background: #0369a1;
        }
        button.danger {
            background: #dc2626;
        }
        button.danger:hover {
            background: #b91c1c;
        }
        .success {
            padding: 15px;
            background: #d1fae5;
            color: #065f46;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }
        .info {
            padding: 15px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 6px;
            margin: 15px 0;
        }
        .warning {
            padding: 15px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 6px;
            margin: 15px 0;
        }
        code {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }
        pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
        }
        ul {
            margin: 10px 0;
            padding-left: 25px;
        }
        li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Data Cleanup Utility</h1>
        <p class="subtitle">Update your localStorage to use the new user system</p>

        <div class="info">
            <strong>‚ÑπÔ∏è Why do I need this?</strong><br>
            Your browser has cached old project data with previous demo users. This utility will update all existing projects and tasks to use the new user names: <strong>Gareth Mauck</strong> and <strong>David Buttemer</strong>.
        </div>

        <div class="section">
            <h3>Option 1: Update Existing Data (Recommended)</h3>
            <p>This will migrate all your existing projects and tasks to use the new users:</p>
            <ul>
                <li>Sarah Johnson ‚Üí Gareth Mauck</li>
                <li>Mike Chen ‚Üí David Buttemer</li>
                <li>Emily Davis ‚Üí Gareth Mauck</li>
                <li>John Smith ‚Üí David Buttemer</li>
                <li>All other users ‚Üí Gareth Mauck</li>
            </ul>
            <button onclick="migrateUsers()">‚ú® Migrate User Data</button>
        </div>

        <div class="section">
            <h3>Option 2: Clear All Data (Fresh Start)</h3>
            <p>‚ö†Ô∏è This will delete ALL your data and start fresh with the new user system.</p>
            <div class="warning">
                <strong>Warning:</strong> This will permanently delete:
                <ul>
                    <li>All projects and tasks</li>
                    <li>All clients and leads</li>
                    <li>All time entries</li>
                    <li>All invoices</li>
                </ul>
                Only the user accounts (Gareth & David) will remain.
            </div>
            <button class="danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
        </div>

        <div class="section">
            <h3>Option 3: View Current Data</h3>
            <p>See what's currently stored in your browser:</p>
            <button onclick="viewData()">üëÅÔ∏è View Data</button>
            <pre id="dataOutput" style="display: none; margin-top: 15px;"></pre>
        </div>

        <div id="successMessage" class="success"></div>
    </div>

    <script>
        // User mapping for migration
        const userMapping = {
            'Sarah Johnson': 'Gareth Mauck',
            'Mike Chen': 'David Buttemer',
            'Emily Davis': 'Gareth Mauck',
            'John Smith': 'David Buttemer',
            'Heidi Rabe': 'Gareth Mauck',
            'Anton Rabe': 'David Buttemer',
            'Andrew Hallatt': 'Gareth Mauck',
            'Darren Mortimer': 'David Buttemer',
            'Ruwan Coetzee': 'Gareth Mauck',
            'Caitlyn Fraser': 'David Buttemer'
        };

        function migrateUsers() {
            if (!confirm('This will update all existing projects and tasks to use Gareth Mauck and David Buttemer. Continue?')) {
                return;
            }

            let updateCount = 0;

            // Migrate Projects
            const projects = JSON.parse(localStorage.getItem('abcotronics_projects') || '[]');
            projects.forEach(project => {
                // Update assignedTo
                if (project.assignedTo && userMapping[project.assignedTo]) {
                    project.assignedTo = userMapping[project.assignedTo];
                    updateCount++;
                }
                // Update manager
                if (project.manager && userMapping[project.manager]) {
                    project.manager = userMapping[project.manager];
                    updateCount++;
                }
                // Update tasks
                if (project.tasks && Array.isArray(project.tasks)) {
                    project.tasks.forEach(task => {
                        if (task.assignee && userMapping[task.assignee]) {
                            task.assignee = userMapping[task.assignee];
                            updateCount++;
                        }
                        // Update subtasks
                        if (task.subtasks && Array.isArray(task.subtasks)) {
                            task.subtasks.forEach(subtask => {
                                if (subtask.assignee && userMapping[subtask.assignee]) {
                                    subtask.assignee = userMapping[subtask.assignee];
                                    updateCount++;
                                }
                            });
                        }
                    });
                }
            });
            localStorage.setItem('abcotronics_projects', JSON.stringify(projects));

            // Migrate Time Entries
            const timeEntries = JSON.parse(localStorage.getItem('abcotronics_timeEntries') || '[]');
            timeEntries.forEach(entry => {
                if (entry.user && userMapping[entry.user]) {
                    entry.user = userMapping[entry.user];
                    updateCount++;
                }
            });
            localStorage.setItem('abcotronics_timeEntries', JSON.stringify(timeEntries));

            // Ensure Users are set correctly
            const users = [
                {
                    id: '1',
                    name: 'Gareth Mauck',
                    email: 'gareth.mauck@abcotronics.com',
                    phone: '+27 11 123 4567',
                    role: 'admin',
                    department: 'Management',
                    status: 'Active',
                    customPermissions: [],
                    createdAt: new Date().toISOString()
                },
                {
                    id: '2',
                    name: 'David Buttemer',
                    email: 'david.buttemer@abcotronics.com',
                    phone: '+27 11 123 4568',
                    role: 'manager',
                    department: 'Technical',
                    status: 'Active',
                    customPermissions: [],
                    createdAt: new Date().toISOString()
                }
            ];
            localStorage.setItem('abcotronics_users', JSON.stringify(users));

            showSuccess(`‚úÖ Migration complete! Updated ${updateCount} user assignments. Please refresh the page.`);
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è Are you ABSOLUTELY SURE? This will delete ALL your data!')) {
                return;
            }
            if (!confirm('This cannot be undone! Click OK to proceed with deletion.')) {
                return;
            }

            // Clear all localStorage except keep the users
            const keys = [
                'abcotronics_projects',
                'abcotronics_clients',
                'abcotronics_leads',
                'abcotronics_timeEntries',
                'abcotronics_invoices',
                'abcotronics_deposits',
                'abcotronics_notes_templates',
                'abcotronics_reminder_settings',
                'abcotronics_invoice_template'
            ];

            keys.forEach(key => localStorage.removeItem(key));

            // Set up fresh users
            const users = [
                {
                    id: '1',
                    name: 'Gareth Mauck',
                    email: 'gareth.mauck@abcotronics.com',
                    phone: '+27 11 123 4567',
                    role: 'admin',
                    department: 'Management',
                    status: 'Active',
                    customPermissions: [],
                    createdAt: new Date().toISOString()
                },
                {
                    id: '2',
                    name: 'David Buttemer',
                    email: 'david.buttemer@abcotronics.com',
                    phone: '+27 11 123 4568',
                    role: 'manager',
                    department: 'Technical',
                    status: 'Active',
                    customPermissions: [],
                    createdAt: new Date().toISOString()
                }
            ];
            localStorage.setItem('abcotronics_users', JSON.stringify(users));

            showSuccess('‚úÖ All data cleared! Users reset to Gareth Mauck and David Buttemer. Please refresh the page.');
        }

        function viewData() {
            const data = {
                users: JSON.parse(localStorage.getItem('abcotronics_users') || '[]'),
                projects: JSON.parse(localStorage.getItem('abcotronics_projects') || '[]'),
                clients: JSON.parse(localStorage.getItem('abcotronics_clients') || '[]'),
                timeEntries: JSON.parse(localStorage.getItem('abcotronics_timeEntries') || '[]')
            };

            const output = document.getElementById('dataOutput');
            output.style.display = 'block';
            output.textContent = JSON.stringify(data, null, 2);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 10000);
        }
    </script>
</body>
</html>
