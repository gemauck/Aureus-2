<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP System Fixes Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .test-fail { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .test-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">ğŸ”§ ERP System Fixes Test</h1>
        
        <div id="test-results" class="space-y-4">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Loading Test Components...</h2>
                <div id="loading-status" class="text-blue-600">â³ Initializing...</div>
            </div>
        </div>
    </div>

    <!-- Load core utilities first -->
    <script src="src/utils/localStorage.js"></script>
    <script src="src/utils/dataService.js"></script>
    
    <!-- Load test components -->
    <script src="src/components/teams/Teams.jsx"></script>
    <script src="src/components/projects/Projects.jsx"></script>
    <script src="src/components/projects/ProjectDetail.jsx"></script>
    <script src="src/components/projects/ProjectModal.jsx"></script>
    <script src="src/components/projects/ProjectProgressTracker.jsx"></script>
    <script src="src/components/projects/MonthlyDocumentCollectionTracker.jsx"></script>

    <script>
        // Test Suite
        class ERPFixesTest {
            constructor() {
                this.results = [];
                this.testData = {
                    clients: [
                        { id: 1, name: 'Test Client', type: 'client', email: 'test@client.com' }
                    ],
                    projects: [
                        { id: 1, name: 'Test Project', client: 'Test Client', status: 'Active' }
                    ],
                    users: [
                        { id: 1, name: 'Test User', email: 'test@user.com', status: 'Active' }
                    ]
                };
            }

            async runTests() {
                console.log('ğŸ§ª Starting ERP Fixes Test Suite...');
                
                // Test 1: Storage Utilities
                await this.testStorageUtilities();
                
                // Test 2: DataService Integration
                await this.testDataServiceIntegration();
                
                // Test 3: Teams Component
                await this.testTeamsComponent();
                
                // Test 4: Projects Component
                await this.testProjectsComponent();
                
                // Test 5: ProjectDetail Component
                await this.testProjectDetailComponent();
                
                // Test 6: ProjectModal Component
                await this.testProjectModalComponent();
                
                // Test 7: ProjectProgressTracker Component
                await this.testProjectProgressTrackerComponent();
                
                // Test 8: MonthlyDocumentCollectionTracker Component
                await this.testMonthlyDocumentCollectionTrackerComponent();
                
                // Display Results
                this.displayResults();
            }

            async testStorageUtilities() {
                const testName = 'Storage Utilities';
                try {
                    // Check if storage is available
                    if (!window.storage) {
                        throw new Error('window.storage is not available');
                    }

                    // Test basic methods
                    const methods = ['getClients', 'setClients', 'getProjects', 'setProjects', 'getUsers', 'getTeamDocuments'];
                    for (const method of methods) {
                        if (typeof window.storage[method] !== 'function') {
                            throw new Error(`Storage method ${method} is not a function`);
                        }
                    }

                    // Test data operations
                    window.storage.setClients(this.testData.clients);
                    const retrievedClients = window.storage.getClients();
                    if (!retrievedClients || retrievedClients.length === 0) {
                        throw new Error('Failed to retrieve clients from storage');
                    }

                    this.addResult(testName, true, 'All storage utilities working correctly');
                } catch (error) {
                    this.addResult(testName, false, error.message);
                }
            }

            async testDataServiceIntegration() {
                const testName = 'DataService Integration';
                try {
                    if (!window.dataService) {
                        throw new Error('window.dataService is not available');
                    }

                    // Test async methods
                    const methods = ['getClients', 'setClients', 'getProjects', 'setProjects', 'getTeamDocuments'];
                    for (const method of methods) {
                        if (typeof window.dataService[method] !== 'function') {
                            throw new Error(`DataService method ${method} is not a function`);
                        }
                    }

                    // Test data operations
                    await window.dataService.setClients(this.testData.clients);
                    const retrievedClients = await window.dataService.getClients();
                    if (!retrievedClients || retrievedClients.length === 0) {
                        throw new Error('Failed to retrieve clients from dataService');
                    }

                    this.addResult(testName, true, 'DataService integration working correctly');
                } catch (error) {
                    this.addResult(testName, false, error.message);
                }
            }

            async testTeamsComponent() {
                const testName = 'Teams Component';
                try {
                    if (!window.Teams) {
                        throw new Error('Teams component is not available');
                    }

                    // Test that Teams component can be instantiated
                    const teamsElement = React.createElement(window.Teams);
                    if (!teamsElement) {
                        throw new Error('Failed to create Teams component');
                    }

                    this.addResult(testName, true, 'Teams component loads without errors');
                } catch (error) {
                    this.addResult(testName, false, error.message);
                }
            }

            async testProjectsComponent() {
                const testName = 'Projects Component';
                try {
                    if (!window.Projects) {
                        throw new Error('Projects component is not available');
                    }

                    // Test that Projects component can be instantiated
                    const projectsElement = React.createElement(window.Projects);
                    if (!projectsElement) {
                        throw new Error('Failed to create Projects component');
                    }

                    this.addResult(testName, true, 'Projects component loads without errors');
                } catch (error) {
                    this.addResult(testName, false, error.message);
                }
            }

            async testProjectDetailComponent() {
                const testName = 'ProjectDetail Component';
                try {
                    if (!window.ProjectDetail) {
                        throw new Error('ProjectDetail component is not available');
                    }

                    // Test with mock project data
                    const mockProject = {
                        id: 1,
                        name: 'Test Project',
                        client: 'Test Client',
                        status: 'Active',
                        tasks: [],
                        taskLists: [],
                        customFieldDefinitions: [],
                        documents: []
                    };

                    const projectDetailElement = React.createElement(window.ProjectDetail, {
                        project: mockProject,
                        onBack: () => {}
                    });

                    if (!projectDetailElement) {
                        throw new Error('Failed to create ProjectDetail component');
                    }

                    this.addResult(testName, true, 'ProjectDetail component loads without errors');
                } catch (error) {
                    this.addResult(testName, false, error.message);
                }
            }

            async testProjectModalComponent() {
                const testName = 'ProjectModal Component';
                try {
                    if (!window.ProjectModal) {
                        throw new Error('ProjectModal component is not available');
                    }

                    const projectModalElement = React.createElement(window.ProjectModal, {
                        project: null,
                        onSave: () => {},
                        onClose: () => {}
                    });

                    if (!projectModalElement) {
                        throw new Error('Failed to create ProjectModal component');
                    }

                    this.addResult(testName, true, 'ProjectModal component loads without errors');
                } catch (error) {
                    this.addResult(testName, false, error.message);
                }
            }

            async testProjectProgressTrackerComponent() {
                const testName = 'ProjectProgressTracker Component';
                try {
                    if (!window.ProjectProgressTracker) {
                        throw new Error('ProjectProgressTracker component is not available');
                    }

                    const progressTrackerElement = React.createElement(window.ProjectProgressTracker, {
                        onBack: () => {}
                    });

                    if (!progressTrackerElement) {
                        throw new Error('Failed to create ProjectProgressTracker component');
                    }

                    this.addResult(testName, true, 'ProjectProgressTracker component loads without errors');
                } catch (error) {
                    this.addResult(testName, false, error.message);
                }
            }

            async testMonthlyDocumentCollectionTrackerComponent() {
                const testName = 'MonthlyDocumentCollectionTracker Component';
                try {
                    if (!window.MonthlyDocumentCollectionTracker) {
                        throw new Error('MonthlyDocumentCollectionTracker component is not available');
                    }

                    const mockProject = {
                        id: 1,
                        name: 'Test Project',
                        documentSections: []
                    };

                    const trackerElement = React.createElement(window.MonthlyDocumentCollectionTracker, {
                        project: mockProject,
                        onBack: () => {}
                    });

                    if (!trackerElement) {
                        throw new Error('Failed to create MonthlyDocumentCollectionTracker component');
                    }

                    this.addResult(testName, true, 'MonthlyDocumentCollectionTracker component loads without errors');
                } catch (error) {
                    this.addResult(testName, false, error.message);
                }
            }

            addResult(testName, passed, message) {
                this.results.push({ testName, passed, message });
                console.log(`${passed ? 'âœ…' : 'âŒ'} ${testName}: ${message}`);
            }

            displayResults() {
                const container = document.getElementById('test-results');
                container.innerHTML = '';

                const passedTests = this.results.filter(r => r.passed).length;
                const totalTests = this.results.length;

                // Summary
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'bg-white rounded-lg shadow p-6 mb-6';
                summaryDiv.innerHTML = `
                    <h2 class="text-xl font-semibold mb-4">ğŸ“Š Test Results Summary</h2>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-600">${passedTests}</div>
                            <div class="text-sm text-gray-600">Passed</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-red-600">${totalTests - passedTests}</div>
                            <div class="text-sm text-gray-600">Failed</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-600">${totalTests}</div>
                            <div class="text-sm text-gray-600">Total</div>
                        </div>
                    </div>
                `;
                container.appendChild(summaryDiv);

                // Individual test results
                this.results.forEach(result => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = `test-result ${result.passed ? 'test-pass' : 'test-fail'}`;
                    resultDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <strong>${result.testName}</strong>
                                <div class="text-sm mt-1">${result.message}</div>
                            </div>
                            <div class="text-2xl">${result.passed ? 'âœ…' : 'âŒ'}</div>
                        </div>
                    `;
                    container.appendChild(resultDiv);
                });

                // Overall status
                const statusDiv = document.createElement('div');
                statusDiv.className = `test-result ${passedTests === totalTests ? 'test-pass' : 'test-fail'}`;
                statusDiv.innerHTML = `
                    <div class="text-center">
                        <h3 class="text-lg font-semibold">
                            ${passedTests === totalTests ? 'ğŸ‰ All Tests Passed!' : 'âš ï¸ Some Tests Failed'}
                        </h3>
                        <p class="mt-2">
                            ${passedTests === totalTests 
                                ? 'The ERP system fixes are working correctly and ready for deployment.' 
                                : 'Please review the failed tests before deploying.'}
                        </p>
                    </div>
                `;
                container.appendChild(statusDiv);
            }
        }

        // Initialize and run tests when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingStatus = document.getElementById('loading-status');
            loadingStatus.textContent = 'ğŸ”„ Running tests...';
            
            const testSuite = new ERPFixesTest();
            await testSuite.runTests();
            
            loadingStatus.textContent = 'âœ… Tests completed!';
        });
    </script>
</body>
</html>
