<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP System Functionality Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SystemTest = () => {
            const [results, setResults] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [testProgress, setTestProgress] = useState(0);

            const addResult = (category, test, status, message, details = '') => {
                setResults(prev => [...prev, { 
                    category, 
                    test, 
                    status, 
                    message, 
                    details,
                    timestamp: new Date().toLocaleTimeString() 
                }]);
            };

            const runSystemTest = async () => {
                setIsLoading(true);
                setResults([]);
                setTestProgress(0);
                
                try {
                    // Test 1: Authentication System
                    addResult('Authentication', 'Login Test', 'info', 'Testing user authentication...');
                    setTestProgress(10);
                    
                    const loginResponse = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: 'admin@abcotronics.com', password: 'admin123' })
                    });
                    
                    if (loginResponse.ok) {
                        const loginData = await loginResponse.json();
                        localStorage.setItem('abcotronics_auth_token', loginData.accessToken);
                        localStorage.setItem('abcotronics_user', JSON.stringify(loginData.user));
                        addResult('Authentication', 'Login Test', 'success', 'Login successful', `User: ${loginData.user.name}`);
                    } else {
                        addResult('Authentication', 'Login Test', 'error', 'Login failed');
                        return;
                    }

                    // Test 2: User Profile
                    addResult('Authentication', 'Profile Test', 'info', 'Testing user profile retrieval...');
                    setTestProgress(20);
                    
                    const profileResponse = await fetch('/api/me', {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}` }
                    });
                    
                    if (profileResponse.ok) {
                        const profileData = await profileResponse.json();
                        addResult('Authentication', 'Profile Test', 'success', 'Profile retrieved successfully', `Role: ${profileData.role}`);
                    } else {
                        addResult('Authentication', 'Profile Test', 'error', 'Profile retrieval failed');
                    }

                    // Test 3: Clients System
                    addResult('Clients', 'Create Client', 'info', 'Testing client creation...');
                    setTestProgress(30);
                    
                    const clientData = {
                        name: 'Test Client Corp',
                        industry: 'Technology',
                        status: 'Active',
                        email: 'test@clientcorp.com',
                        phone: '+27123456789',
                        address: '123 Test Street, Cape Town',
                        website: 'https://testclientcorp.com',
                        notes: 'Test client for system validation',
                        contacts: [
                            {
                                id: 1,
                                name: 'John Doe',
                                role: 'CEO',
                                email: 'john@testclientcorp.com',
                                phone: '+27123456789',
                                department: 'Executive'
                            }
                        ],
                        sites: [
                            {
                                id: 1,
                                name: 'Head Office',
                                address: '123 Test Street, Cape Town',
                                type: 'Office',
                                isPrimary: true
                            }
                        ],
                        opportunities: [
                            {
                                id: 1,
                                name: 'Software Development Project',
                                value: 50000,
                                status: 'Proposal',
                                expectedCloseDate: '2024-04-30',
                                probability: 75
                            }
                        ]
                    };

                    const createClientResponse = await fetch('/api/clients', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}`
                        },
                        body: JSON.stringify(clientData)
                    });
                    
                    if (createClientResponse.ok) {
                        const newClient = await createClientResponse.json();
                        addResult('Clients', 'Create Client', 'success', 'Client created successfully', `Client: ${newClient.data.client.name}`);
                        
                        // Test client update
                        addResult('Clients', 'Update Client', 'info', 'Testing client update...');
                        const updateResponse = await fetch(`/api/clients/${newClient.data.client.id}`, {
                            method: 'PATCH',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}`
                            },
                            body: JSON.stringify({ name: 'Updated Test Client Corp', industry: 'Manufacturing' })
                        });
                        
                        if (updateResponse.ok) {
                            addResult('Clients', 'Update Client', 'success', 'Client updated successfully');
                        } else {
                            addResult('Clients', 'Update Client', 'error', 'Client update failed');
                        }
                    } else {
                        addResult('Clients', 'Create Client', 'error', 'Client creation failed');
                    }

                    // Test 4: Leads System
                    addResult('Leads', 'Create Lead', 'info', 'Testing lead creation...');
                    setTestProgress(40);
                    
                    const leadData = {
                        name: 'Test Lead Company',
                        industry: 'Healthcare',
                        status: 'New',
                        value: 25000,
                        source: 'Website',
                        firstContactDate: '2024-03-15',
                        notes: 'Test lead for system validation',
                        contacts: [
                            {
                                id: 1,
                                name: 'Jane Smith',
                                role: 'Marketing Director',
                                email: 'jane@testleadcompany.com',
                                phone: '+27987654321'
                            }
                        ]
                    };

                    const createLeadResponse = await fetch('/api/leads', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}`
                        },
                        body: JSON.stringify(leadData)
                    });
                    
                    if (createLeadResponse.ok) {
                        const newLead = await createLeadResponse.json();
                        addResult('Leads', 'Create Lead', 'success', 'Lead created successfully', `Lead: ${newLead.data.name}`);
                        
                        // Test lead update
                        addResult('Leads', 'Update Lead', 'info', 'Testing lead update...');
                        const updateLeadResponse = await fetch(`/api/leads/${newLead.data.id}`, {
                            method: 'PUT',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}`
                            },
                            body: JSON.stringify({ status: 'Qualified', value: 30000 })
                        });
                        
                        if (updateLeadResponse.ok) {
                            addResult('Leads', 'Update Lead', 'success', 'Lead updated successfully');
                        } else {
                            addResult('Leads', 'Update Lead', 'error', 'Lead update failed');
                        }
                    } else {
                        addResult('Leads', 'Create Lead', 'error', 'Lead creation failed');
                    }

                    // Test 5: Projects System
                    addResult('Projects', 'Create Project', 'info', 'Testing project creation...');
                    setTestProgress(50);
                    
                    const projectData = {
                        name: 'Test ERP Implementation',
                        client: 'Test Client Corp',
                        type: 'Implementation',
                        status: 'Active',
                        startDate: '2024-03-01',
                        dueDate: '2024-06-30',
                        progress: 25,
                        assignedTo: 'Gareth Mauck',
                        description: 'Test project for system validation',
                        budget: 100000,
                        actualCost: 25000,
                        tasks: [
                            {
                                id: 1,
                                name: 'Requirements Analysis',
                                status: 'Completed',
                                assignedTo: 'Team Lead',
                                dueDate: '2024-03-15'
                            },
                            {
                                id: 2,
                                name: 'System Design',
                                status: 'In Progress',
                                assignedTo: 'Architect',
                                dueDate: '2024-04-15'
                            }
                        ]
                    };

                    const createProjectResponse = await fetch('/api/projects', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}`
                        },
                        body: JSON.stringify(projectData)
                    });
                    
                    if (createProjectResponse.ok) {
                        const newProject = await createProjectResponse.json();
                        addResult('Projects', 'Create Project', 'success', 'Project created successfully', `Project: ${newProject.data.name}`);
                    } else {
                        addResult('Projects', 'Create Project', 'error', 'Project creation failed');
                    }

                    // Test 6: Invoicing System
                    addResult('Invoicing', 'Create Invoice', 'info', 'Testing invoice creation...');
                    setTestProgress(60);
                    
                    const invoiceData = {
                        invoiceNumber: 'INV-TEST-001',
                        client: 'Test Client Corp',
                        project: 'Test ERP Implementation',
                        date: '2024-03-15',
                        dueDate: '2024-04-15',
                        subtotal: 25000,
                        vat: 3750,
                        total: 28750,
                        status: 'Sent',
                        lineItems: [
                            {
                                description: 'ERP Implementation Services',
                                quantity: 100,
                                rate: 250,
                                amount: 25000
                            }
                        ],
                        notes: 'Test invoice for system validation'
                    };

                    const createInvoiceResponse = await fetch('/api/invoices', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}`
                        },
                        body: JSON.stringify(invoiceData)
                    });
                    
                    if (createInvoiceResponse.ok) {
                        const newInvoice = await createInvoiceResponse.json();
                        addResult('Invoicing', 'Create Invoice', 'success', 'Invoice created successfully', `Invoice: ${newInvoice.data.invoiceNumber}`);
                    } else {
                        addResult('Invoicing', 'Create Invoice', 'error', 'Invoice creation failed');
                    }

                    // Test 7: Time Tracking System
                    addResult('Time Tracking', 'Create Time Entry', 'info', 'Testing time entry creation...');
                    setTestProgress(70);
                    
                    const timeEntryData = {
                        date: '2024-03-15',
                        project: 'Test ERP Implementation',
                        client: 'Test Client Corp',
                        task: 'System Analysis',
                        hours: 8,
                        billable: true,
                        employee: 'Gareth Mauck',
                        description: 'Analyzed system requirements and prepared implementation plan',
                        rate: 250,
                        totalAmount: 2000
                    };

                    const createTimeEntryResponse = await fetch('/api/time-entries', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}`
                        },
                        body: JSON.stringify(timeEntryData)
                    });
                    
                    if (createTimeEntryResponse.ok) {
                        const newTimeEntry = await createTimeEntryResponse.json();
                        addResult('Time Tracking', 'Create Time Entry', 'success', 'Time entry created successfully', `Task: ${newTimeEntry.data.task}`);
                    } else {
                        addResult('Time Tracking', 'Create Time Entry', 'error', 'Time entry creation failed');
                    }

                    // Test 8: User Management
                    addResult('User Management', 'Invite User', 'info', 'Testing user invitation...');
                    setTestProgress(80);
                    
                    const inviteData = {
                        email: 'testuser@abcotronics.co.za',
                        name: 'Test User',
                        role: 'user'
                    };

                    const inviteResponse = await fetch('/api/users/invite', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}`
                        },
                        body: JSON.stringify(inviteData)
                    });
                    
                    if (inviteResponse.ok) {
                        const inviteResult = await inviteResponse.json();
                        addResult('User Management', 'Invite User', 'success', 'User invitation sent successfully', `Email: ${inviteResult.data.invitation.email}`);
                    } else {
                        addResult('User Management', 'Invite User', 'error', 'User invitation failed');
                    }

                    // Test 9: Data Retrieval
                    addResult('Data Retrieval', 'Get All Data', 'info', 'Testing data retrieval...');
                    setTestProgress(90);
                    
                    const [clientsRes, leadsRes, projectsRes, invoicesRes, timeEntriesRes] = await Promise.allSettled([
                        fetch('/api/clients', { headers: { 'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}` }}),
                        fetch('/api/leads', { headers: { 'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}` }}),
                        fetch('/api/projects', { headers: { 'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}` }}),
                        fetch('/api/invoices', { headers: { 'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}` }}),
                        fetch('/api/time-entries', { headers: { 'Authorization': `Bearer ${localStorage.getItem('abcotronics_auth_token')}` }})
                    ]);

                    const dataResults = {
                        clients: clientsRes.status === 'fulfilled' ? 'success' : 'error',
                        leads: leadsRes.status === 'fulfilled' ? 'success' : 'error',
                        projects: projectsRes.status === 'fulfilled' ? 'success' : 'error',
                        invoices: invoicesRes.status === 'fulfilled' ? 'success' : 'error',
                        timeEntries: timeEntriesRes.status === 'fulfilled' ? 'success' : 'error'
                    };

                    addResult('Data Retrieval', 'Get All Data', 'success', 'All data retrieval tests completed', `Results: ${JSON.stringify(dataResults)}`);

                    // Test 10: System Health
                    addResult('System Health', 'Health Check', 'info', 'Testing system health...');
                    setTestProgress(100);
                    
                    const healthResponse = await fetch('/api/health');
                    if (healthResponse.ok) {
                        const healthData = await healthResponse.json();
                        addResult('System Health', 'Health Check', 'success', 'System health check passed', `Status: ${healthData.status}`);
                    } else {
                        addResult('System Health', 'Health Check', 'error', 'System health check failed');
                    }

                    addResult('System Test', 'Complete', 'success', 'All system functionality tests completed successfully!');

                } catch (error) {
                    addResult('System Test', 'Error', 'error', `System test failed: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            const getStatusIcon = (status) => {
                switch (status) {
                    case 'success': return '✅';
                    case 'error': return '❌';
                    case 'info': return 'ℹ️';
                    default: return '⏳';
                }
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'success': return 'bg-green-100 text-green-800 border-green-200';
                    case 'error': return 'bg-red-100 text-red-800 border-red-200';
                    case 'info': return 'bg-blue-100 text-blue-800 border-blue-200';
                    default: return 'bg-gray-100 text-gray-800 border-gray-200';
                }
            };

            const categories = [...new Set(results.map(r => r.category))];
            const successCount = results.filter(r => r.status === 'success').length;
            const errorCount = results.filter(r => r.status === 'error').length;
            const totalCount = results.length;

            return (
                <div className="min-h-screen bg-gray-100 py-8">
                    <div className="max-w-6xl mx-auto px-4">
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h1 className="text-3xl font-bold text-gray-900 mb-6">
                                🔧 ERP System Functionality Test
                            </h1>
                            
                            <p className="text-gray-600 mb-6">
                                Comprehensive testing of all ERP system functionality including authentication, 
                                data management, and database operations.
                            </p>

                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div className="text-2xl font-bold text-blue-600">{totalCount}</div>
                                    <div className="text-sm text-blue-800">Total Tests</div>
                                </div>
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div className="text-2xl font-bold text-green-600">{successCount}</div>
                                    <div className="text-sm text-green-800">Passed</div>
                                </div>
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <div className="text-2xl font-bold text-red-600">{errorCount}</div>
                                    <div className="text-sm text-red-800">Failed</div>
                                </div>
                                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <div className="text-2xl font-bold text-purple-600">
                                        {totalCount > 0 ? Math.round((successCount / totalCount) * 100) : 0}%
                                    </div>
                                    <div className="text-sm text-purple-800">Success Rate</div>
                                </div>
                            </div>

                            {isLoading && (
                                <div className="mb-6">
                                    <div className="bg-gray-200 rounded-full h-2">
                                        <div 
                                            className="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                            style={{ width: `${testProgress}%` }}
                                        ></div>
                                    </div>
                                    <p className="text-sm text-gray-600 mt-2">Progress: {testProgress}%</p>
                                </div>
                            )}

                            <button
                                onClick={runSystemTest}
                                disabled={isLoading}
                                className={`px-6 py-3 rounded-lg font-medium mb-6 ${
                                    isLoading
                                        ? 'bg-gray-400 text-gray-600 cursor-not-allowed'
                                        : 'bg-blue-600 text-white hover:bg-blue-700'
                                }`}
                            >
                                {isLoading ? (
                                    <>
                                        <i className="fas fa-spinner fa-spin mr-2"></i>
                                        Running System Test...
                                    </>
                                ) : (
                                    <>
                                        <i className="fas fa-play mr-2"></i>
                                        Run Complete System Test
                                    </>
                                )}
                            </button>

                            {results.length > 0 && (
                                <div className="space-y-6">
                                    {categories.map(category => (
                                        <div key={category} className="border border-gray-200 rounded-lg p-4">
                                            <h2 className="text-xl font-semibold text-gray-900 mb-4">{category}</h2>
                                            <div className="space-y-2">
                                                {results.filter(r => r.category === category).map((result, index) => (
                                                    <div key={index} className={`p-3 rounded-lg border ${getStatusColor(result.status)}`}>
                                                        <div className="flex justify-between items-start">
                                                            <div className="flex items-center space-x-2">
                                                                <span>{getStatusIcon(result.status)}</span>
                                                                <span className="font-medium">{result.test}</span>
                                                            </div>
                                                            <span className="text-sm opacity-75">{result.timestamp}</span>
                                                        </div>
                                                        <div className="text-sm mt-1">{result.message}</div>
                                                        {result.details && (
                                                            <div className="text-xs mt-1 opacity-75">{result.details}</div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            <div className="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <h3 className="font-semibold text-yellow-800 mb-2">Test Information:</h3>
                                <ul className="text-yellow-700 text-sm space-y-1">
                                    <li>• Tests all major ERP system functionality</li>
                                    <li>• Verifies database operations and API endpoints</li>
                                    <li>• Checks authentication and user management</li>
                                    <li>• Validates data persistence and retrieval</li>
                                    <li>• Monitors system health and performance</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<SystemTest />, document.getElementById('root'));
    </script>
</body>
</html>
