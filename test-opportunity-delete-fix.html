<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opportunity Delete Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üîß AI Opportunity Delete Fix Test</h1>
    
    <div class="test-section">
        <h2>Test Steps</h2>
        <ol>
            <li>Create a test opportunity</li>
            <li>Verify it exists</li>
            <li>Delete the opportunity</li>
            <li>Verify it's gone</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Actions</h2>
        <button onclick="runFullTest()">üöÄ Run Full Test</button>
        <button onclick="createTestOpportunity()">1. Create Test Opportunity</button>
        <button onclick="listOpportunities()">2. List All Opportunities</button>
        <button onclick="deleteTestOpportunity()">3. Delete Test Opportunity</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="logs"></div>
    </div>

    <script>
        let testOpportunityId = null;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function runFullTest() {
            clearLogs();
            log('üöÄ Starting full opportunity delete test...', 'info');
            
            try {
                // Step 1: Create opportunity
                await createTestOpportunity();
                if (!testOpportunityId) {
                    log('‚ùå Test failed: Could not create opportunity', 'error');
                    return;
                }
                
                // Step 2: Verify it exists
                await listOpportunities();
                
                // Step 3: Delete opportunity
                await deleteTestOpportunity();
                
                // Step 4: Verify it's gone
                setTimeout(async () => {
                    await listOpportunities();
                    log('‚úÖ Full test completed!', 'success');
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Test failed with error: ${error.message}`, 'error');
            }
        }

        async function createTestOpportunity() {
            try {
                log('üîÑ Creating test opportunity...', 'info');
                
                // First, get a client to attach the opportunity to
                const clientsResponse = await fetch('/api/clients', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!clientsResponse.ok) {
                    throw new Error(`Failed to get clients: ${clientsResponse.status}`);
                }
                
                const clientsData = await clientsResponse.json();
                const clients = clientsData.clients || [];
                
                if (clients.length === 0) {
                    log('‚ùå No clients found. Please create a client first.', 'error');
                    return;
                }
                
                const client = clients[0];
                log(`‚úÖ Found client: ${client.name}`, 'success');
                
                // Create test opportunity
                const opportunityData = {
                    title: `AI Fix Test Opportunity - ${Date.now()}`,
                    clientId: client.id,
                    stage: 'prospect',
                    value: 75000
                };
                
                const response = await fetch('/api/opportunities', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(opportunityData)
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Failed to create opportunity: ${response.status} - ${errorData}`);
                }
                
                const data = await response.json();
                testOpportunityId = data.opportunity.id;
                
                log(`‚úÖ Test opportunity created successfully!`, 'success');
                log(`   ID: ${testOpportunityId}`, 'info');
                log(`   Title: ${opportunityData.title}`, 'info');
                log(`   Client: ${client.name}`, 'info');
                
            } catch (error) {
                log(`‚ùå Error creating test opportunity: ${error.message}`, 'error');
                console.error('Create opportunity error:', error);
            }
        }

        async function listOpportunities() {
            try {
                log('üîÑ Listing all opportunities...', 'info');
                
                const response = await fetch('/api/opportunities', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to list opportunities: ${response.status}`);
                }
                
                const data = await response.json();
                const opportunities = data.opportunities || [];
                
                log(`‚úÖ Found ${opportunities.length} opportunities:`, 'success');
                
                opportunities.forEach(opp => {
                    const isTestOpp = opp.id === testOpportunityId;
                    const marker = isTestOpp ? 'üéØ ' : '   ';
                    log(`${marker}ID: ${opp.id} | Title: ${opp.title} | Client: ${opp.client?.name || 'Unknown'}`, 'info');
                });
                
                if (testOpportunityId && !opportunities.find(o => o.id === testOpportunityId)) {
                    log(`‚ö†Ô∏è Test opportunity ${testOpportunityId} not found in list!`, 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Error listing opportunities: ${error.message}`, 'error');
                console.error('List opportunities error:', error);
            }
        }

        async function deleteTestOpportunity() {
            if (!testOpportunityId) {
                log('‚ùå No test opportunity to delete. Please create one first.', 'error');
                return;
            }
            
            try {
                log(`üîÑ Deleting test opportunity ${testOpportunityId}...`, 'info');
                
                const response = await fetch(`/api/opportunities/${testOpportunityId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Failed to delete opportunity: ${response.status} - ${errorData}`);
                }
                
                const data = await response.json();
                
                log(`‚úÖ Test opportunity deleted successfully!`, 'success');
                log(`   Response: ${JSON.stringify(data)}`, 'info');
                
                testOpportunityId = null;
                
            } catch (error) {
                log(`‚ùå Error deleting test opportunity: ${error.message}`, 'error');
                console.error('Delete opportunity error:', error);
            }
        }

        // Check authentication on load
        window.addEventListener('load', () => {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                log('‚ùå No authentication token found. Please log in first.', 'error');
                log('   Go to the main app and log in, then come back to this test.', 'info');
            } else {
                log('‚úÖ Authentication token found. Ready to test!', 'success');
                log('üéØ AI Fix: Dynamic routing priority updated - DELETE requests should now work correctly', 'success');
            }
        });
    </script>
</body>
</html>
