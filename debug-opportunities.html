<!DOCTYPE html>
<html>
<head>
    <title>Opportunities Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .section { background: #2d2d2d; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .client { background: #3e3e3e; padding: 10px; margin: 5px 0; border-left: 3px solid #007acc; }
        .opportunity { background: #4e4e4e; padding: 8px; margin: 5px 0 5px 20px; border-left: 3px solid #4ec9b0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007acc; color: white; border: none; border-radius: 3px; }
        button:hover { background: #005a9e; }
        .error { color: #f48771; }
        .success { color: #4ec9b0; }
        .warning { color: #ce9178; }
        pre { background: #1e1e1e; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Opportunities Diagnostic Tool</h1>
    
    <div class="section">
        <button onclick="checkData()">üîÑ Check Current Data</button>
        <button onclick="fixAllClients()">üîß Fix All Clients</button>
        <button onclick="addTestOpportunity()">‚ûï Add Test Opportunity</button>
        <button onclick="clearAll()">üóëÔ∏è Clear All Data</button>
    </div>

    <div id="output"></div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const color = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            output.innerHTML += `<div class="${color}">${message}</div>`;
        }

        function checkData() {
            document.getElementById('output').innerHTML = '';
            log('<h2>üìä Current Data Status</h2>');
            
            // Get clients from localStorage
            const clientsStr = localStorage.getItem('abcotronics_clients');
            
            if (!clientsStr) {
                log('‚ùå No clients found in localStorage', 'error');
                return;
            }

            let clients;
            try {
                clients = JSON.parse(clientsStr);
                log(`‚úÖ Found ${clients.length} clients in localStorage`, 'success');
            } catch (e) {
                log('‚ùå Error parsing clients: ' + e.message, 'error');
                return;
            }

            // Check each client
            let totalOpportunities = 0;
            clients.forEach((client, index) => {
                log(`<div class="client">
                    <h3>Client ${index + 1}: ${client.name}</h3>
                    <div>ID: ${client.id}</div>
                    <div>Industry: ${client.industry || 'N/A'}</div>
                    <div>Has opportunities property: ${client.hasOwnProperty('opportunities') ? '‚úÖ YES' : '‚ùå NO'}</div>
                    ${client.opportunities ? `
                        <div>Opportunities count: ${client.opportunities.length}</div>
                        ${client.opportunities.length > 0 ? `
                            <div><strong>Opportunities:</strong></div>
                            ${client.opportunities.map((opp, oppIndex) => `
                                <div class="opportunity">
                                    <strong>${oppIndex + 1}. ${opp.name}</strong><br>
                                    Stage: ${opp.stage}<br>
                                    Probability: ${opp.probability}%<br>
                                    ${opp.expectedCloseDate ? `Expected Close: ${opp.expectedCloseDate}<br>` : ''}
                                    ${opp.notes ? `Notes: ${opp.notes}<br>` : ''}
                                    ID: ${opp.id}
                                </div>
                            `).join('')}
                        ` : '<div class="warning">‚ö†Ô∏è No opportunities added yet</div>'}
                    ` : '<div class="error">‚ùå No opportunities array!</div>'}
                </div>`);
                
                if (client.opportunities) {
                    totalOpportunities += client.opportunities.length;
                }
            });

            log(`<h3>üìà Summary</h3>
                <div>Total Clients: ${clients.length}</div>
                <div>Total Opportunities: ${totalOpportunities}</div>
                <div>Clients with opportunities array: ${clients.filter(c => c.opportunities).length}</div>
                <div>Clients with actual opportunities: ${clients.filter(c => c.opportunities && c.opportunities.length > 0).length}</div>
            `);

            // Show raw JSON
            log('<h3>üìÑ Raw JSON Data</h3>');
            log(`<pre>${JSON.stringify(clients, null, 2)}</pre>`);
        }

        function fixAllClients() {
            const clientsStr = localStorage.getItem('abcotronics_clients');
            if (!clientsStr) {
                log('‚ùå No clients found', 'error');
                return;
            }

            let clients = JSON.parse(clientsStr);
            let fixed = 0;

            clients = clients.map(client => {
                if (!client.opportunities) {
                    fixed++;
                    return { ...client, opportunities: [] };
                }
                return client;
            });

            localStorage.setItem('abcotronics_clients', JSON.stringify(clients));
            log(`‚úÖ Fixed ${fixed} clients - added opportunities array`, 'success');
            checkData();
        }

        function addTestOpportunity() {
            const clientsStr = localStorage.getItem('abcotronics_clients');
            if (!clientsStr) {
                log('‚ùå No clients found', 'error');
                return;
            }

            let clients = JSON.parse(clientsStr);
            if (clients.length === 0) {
                log('‚ùå No clients to add opportunity to', 'error');
                return;
            }

            // Add to first client
            const client = clients[0];
            if (!client.opportunities) {
                client.opportunities = [];
            }

            const testOpp = {
                id: Date.now(),
                name: 'Test Opportunity - Fleet Expansion',
                probability: 75,
                stage: 'Interest',
                expectedCloseDate: '2025-11-15',
                relatedSiteId: null,
                notes: 'This is a test opportunity added via diagnostic tool',
                createdAt: new Date().toISOString()
            };

            client.opportunities.push(testOpp);
            localStorage.setItem('abcotronics_clients', JSON.stringify(clients));
            
            log(`‚úÖ Added test opportunity to ${client.name}`, 'success');
            log(`Opportunity: "${testOpp.name}" - Stage: ${testOpp.stage} - Probability: ${testOpp.probability}%`, 'success');
            checkData();
        }

        function clearAll() {
            if (confirm('‚ö†Ô∏è This will delete ALL client data. Are you sure?')) {
                localStorage.removeItem('abcotronics_clients');
                log('üóëÔ∏è All client data cleared', 'warning');
                checkData();
            }
        }

        // Auto-run on load
        checkData();
    </script>
</body>
</html>
