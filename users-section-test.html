<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Section Test - Abcotronics ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Mock storage for testing
        window.storage = {
            getToken: () => 'mock-token-for-testing',
            getUser: () => ({
                id: 'test-admin',
                name: 'Test Admin',
                email: 'admin@test.com',
                role: 'admin'
            }),
            setUser: (user) => console.log('Setting user:', user),
            getUsers: () => [],
            setUsers: (users) => console.log('Setting users:', users)
        };

        // Mock theme hook
        window.useTheme = () => ({ isDark: false });

        // Mock API responses
        const mockApiResponses = {
            '/api/users': {
                users: [
                    {
                        id: 'user-1',
                        name: 'John Doe',
                        email: 'john@example.com',
                        role: 'member',
                        status: 'active',
                        createdAt: '2024-01-15T10:00:00Z',
                        lastLoginAt: '2024-01-20T14:30:00Z'
                    },
                    {
                        id: 'user-2',
                        name: 'Jane Smith',
                        email: 'jane@example.com',
                        role: 'manager',
                        status: 'active',
                        createdAt: '2024-01-10T09:00:00Z',
                        lastLoginAt: '2024-01-21T11:15:00Z'
                    }
                ],
                invitations: [
                    {
                        id: 'inv-1',
                        email: 'newuser@example.com',
                        name: 'New User',
                        role: 'member',
                        status: 'pending',
                        expiresAt: '2024-01-28T10:00:00Z',
                        createdAt: '2024-01-21T10:00:00Z'
                    }
                ]
            }
        };

        // Mock fetch
        const originalFetch = window.fetch;
        window.fetch = async (url, options) => {
            console.log('Mock API call:', url, options);
            
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (url === '/api/users' && options?.method === 'GET') {
                return {
                    ok: true,
                    json: async () => mockApiResponses['/api/users']
                };
            }
            
            if (url === '/api/users' && options?.method === 'POST') {
                return {
                    ok: true,
                    json: async () => ({
                        success: true,
                        message: 'User created successfully',
                        user: {
                            id: 'new-user-' + Date.now(),
                            name: JSON.parse(options.body).name,
                            email: JSON.parse(options.body).email,
                            role: JSON.parse(options.body).role,
                            status: 'active'
                        }
                    })
                };
            }
            
            if (url === '/api/users/invite' && options?.method === 'POST') {
                return {
                    ok: true,
                    json: async () => ({
                        success: true,
                        message: 'Invitation sent successfully',
                        invitation: {
                            id: 'inv-' + Date.now(),
                            email: JSON.parse(options.body).email,
                            name: JSON.parse(options.body).name,
                            role: JSON.parse(options.body).role,
                            status: 'pending',
                            expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
                        }
                    })
                };
            }
            
            return originalFetch(url, options);
        };

        const UsersTest = () => {
            const [testResults, setTestResults] = useState([]);
            const [isRunning, setIsRunning] = useState(false);
            const [userManagementLoaded, setUserManagementLoaded] = useState(false);

            const addTestResult = (test, status, message) => {
                setTestResults(prev => [...prev, {
                    id: Date.now(),
                    test,
                    status,
                    message,
                    timestamp: new Date().toLocaleTimeString()
                }]);
            };

            const checkUserManagementAvailability = () => {
                const isAvailable = !!window.UserManagement;
                setUserManagementLoaded(isAvailable);
                
                if (isAvailable) {
                    addTestResult('UserManagement Component', 'success', 'UserManagement component is loaded and available');
                } else {
                    addTestResult('UserManagement Component', 'error', 'UserManagement component is not loaded');
                }
                
                return isAvailable;
            };

            const runTests = async () => {
                setIsRunning(true);
                setTestResults([]);

                // Test 1: Check if UserManagement component is loaded
                addTestResult('Component Check', 'running', 'Checking if UserManagement component is available...');
                const componentAvailable = checkUserManagementAvailability();

                if (!componentAvailable) {
                    addTestResult('Component Load', 'error', 'UserManagement component not found. Check if the script is loaded in index.html');
                    setIsRunning(false);
                    return;
                }

                // Test 2: Test component rendering
                try {
                    addTestResult('Component Rendering', 'running', 'Testing component rendering...');
                    
                    // Create a test container
                    const testContainer = document.createElement('div');
                    document.body.appendChild(testContainer);
                    
                    // Try to render the component
                    const UserManagement = window.UserManagement;
                    ReactDOM.render(<UserManagement />, testContainer);
                    
                    // Check if it rendered without errors
                    setTimeout(() => {
                        const hasContent = testContainer.innerHTML.length > 100;
                        if (hasContent) {
                            addTestResult('Component Rendering', 'success', 'UserManagement component rendered successfully');
                        } else {
                            addTestResult('Component Rendering', 'error', 'Component rendered but appears empty');
                        }
                        
                        // Clean up
                        ReactDOM.unmountComponentAtNode(testContainer);
                        document.body.removeChild(testContainer);
                    }, 1000);
                    
                } catch (error) {
                    addTestResult('Component Rendering', 'error', `Component rendering failed: ${error.message}`);
                }

                // Test 3: API Connection
                try {
                    addTestResult('API Connection', 'running', 'Testing API connection...');
                    
                    const response = await fetch('/api/users');
                    const data = await response.json();
                    
                    if (response.ok && data.users) {
                        addTestResult('API Connection', 'success', `API connected successfully. Found ${data.users.length} users`);
                    } else {
                        addTestResult('API Connection', 'error', 'API response invalid');
                    }
                } catch (error) {
                    addTestResult('API Connection', 'error', `API connection failed: ${error.message}`);
                }

                // Test 4: Permission System
                try {
                    addTestResult('Permission System', 'running', 'Testing permission system...');
                    
                    if (window.PERMISSIONS && window.PermissionChecker) {
                        const checker = new window.PermissionChecker({ role: 'admin' });
                        const canManageUsers = checker.canManageUsers();
                        
                        if (canManageUsers) {
                            addTestResult('Permission System', 'success', 'Permission system working correctly');
                        } else {
                            addTestResult('Permission System', 'error', 'Permission system not working correctly');
                        }
                    } else {
                        addTestResult('Permission System', 'error', 'Permission system not loaded');
                    }
                } catch (error) {
                    addTestResult('Permission System', 'error', `Permission system error: ${error.message}`);
                }

                setIsRunning(false);
            };

            const getStatusIcon = (status) => {
                switch (status) {
                    case 'success':
                        return <i className="fas fa-check-circle text-green-500"></i>;
                    case 'error':
                        return <i className="fas fa-times-circle text-red-500"></i>;
                    case 'running':
                        return <i className="fas fa-spinner fa-spin text-blue-500"></i>;
                    default:
                        return <i className="fas fa-question-circle text-gray-500"></i>;
                }
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'success':
                        return 'bg-green-50 border-green-200 text-green-800';
                    case 'error':
                        return 'bg-red-50 border-red-200 text-red-800';
                    case 'running':
                        return 'bg-blue-50 border-blue-200 text-blue-800';
                    default:
                        return 'bg-gray-50 border-gray-200 text-gray-800';
                }
            };

            // Check component availability on mount
            useEffect(() => {
                checkUserManagementAvailability();
            }, []);

            return (
                <div className="min-h-screen p-8">
                    <div className="max-w-4xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-xl shadow-lg p-8 mb-8">
                            <div className="text-center">
                                <h1 className="text-3xl font-bold text-gray-900 mb-4">
                                    <i className="fas fa-user-cog text-blue-600 mr-3"></i>
                                    Users Section Availability Test
                                </h1>
                                <p className="text-gray-600 mb-6">
                                    Testing if the Users section is properly loaded and accessible in your ERP system.
                                </p>
                                
                                <div className="mb-6">
                                    <div className={`inline-flex items-center px-4 py-2 rounded-lg ${
                                        userManagementLoaded 
                                            ? 'bg-green-100 text-green-800' 
                                            : 'bg-red-100 text-red-800'
                                    }`}>
                                        <i className={`fas ${
                                            userManagementLoaded ? 'fa-check-circle' : 'fa-times-circle'
                                        } mr-2`}></i>
                                        UserManagement Component: {userManagementLoaded ? 'Available' : 'Not Available'}
                                    </div>
                                </div>
                                
                                <button
                                    onClick={runTests}
                                    disabled={isRunning}
                                    className={`px-8 py-3 rounded-lg font-semibold text-white transition-colors ${
                                        isRunning 
                                            ? 'bg-gray-400 cursor-not-allowed' 
                                            : 'bg-blue-600 hover:bg-blue-700'
                                    }`}
                                >
                                    {isRunning ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin mr-2"></i>
                                            Running Tests...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-play mr-2"></i>
                                            Run Diagnostic Tests
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>

                        {/* Test Results */}
                        <div className="bg-white rounded-xl shadow-lg p-8">
                            <h2 className="text-xl font-semibold text-gray-900 mb-6">
                                <i className="fas fa-clipboard-list mr-2"></i>
                                Test Results
                            </h2>
                            
                            {testResults.length === 0 ? (
                                <div className="text-center py-12 text-gray-500">
                                    <i className="fas fa-flask text-4xl mb-4"></i>
                                    <p>No tests run yet. Click "Run Diagnostic Tests" to start testing.</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {testResults.map((result) => (
                                        <div
                                            key={result.id}
                                            className={`p-4 rounded-lg border ${getStatusColor(result.status)}`}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center">
                                                    {getStatusIcon(result.status)}
                                                    <span className="ml-3 font-medium">{result.test}</span>
                                                </div>
                                                <span className="text-sm opacity-75">{result.timestamp}</span>
                                            </div>
                                            <p className="mt-2 text-sm">{result.message}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Troubleshooting Guide */}
                        <div className="bg-white rounded-xl shadow-lg p-8 mt-8">
                            <h2 className="text-xl font-semibold text-gray-900 mb-6">
                                <i className="fas fa-tools mr-2"></i>
                                Troubleshooting Guide
                            </h2>
                            
                            <div className="space-y-4">
                                <div className="p-4 border border-gray-200 rounded-lg">
                                    <h3 className="font-semibold text-gray-900 mb-2">
                                        <i className="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                        If UserManagement Component is Not Available:
                                    </h3>
                                    <ul className="text-sm text-gray-600 space-y-1 ml-6">
                                        <li>• Check if the script is loaded in index.html</li>
                                        <li>• Verify the file path: <code className="bg-gray-100 px-1 rounded">src/components/users/UserManagement.jsx</code></li>
                                        <li>• Check browser console for JavaScript errors</li>
                                        <li>• Ensure the component is properly exported to window.UserManagement</li>
                                    </ul>
                                </div>
                                
                                <div className="p-4 border border-gray-200 rounded-lg">
                                    <h3 className="font-semibold text-gray-900 mb-2">
                                        <i className="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                        If API Connection Fails:
                                    </h3>
                                    <ul className="text-sm text-gray-600 space-y-1 ml-6">
                                        <li>• Check if the server is running</li>
                                        <li>• Verify API endpoints are accessible</li>
                                        <li>• Check authentication token</li>
                                        <li>• Review server logs for errors</li>
                                    </ul>
                                </div>
                                
                                <div className="p-4 border border-gray-200 rounded-lg">
                                    <h3 className="font-semibold text-gray-900 mb-2">
                                        <i className="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                        If Permission System Fails:
                                    </h3>
                                    <ul className="text-sm text-gray-600 space-y-1 ml-6">
                                        <li>• Check if permissions.js is loaded</li>
                                        <li>• Verify PERMISSIONS object is available globally</li>
                                        <li>• Ensure PermissionChecker class is accessible</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        {/* Quick Actions */}
                        <div className="bg-white rounded-xl shadow-lg p-8 mt-8">
                            <h2 className="text-xl font-semibold text-gray-900 mb-6">
                                <i className="fas fa-bolt mr-2"></i>
                                Quick Actions
                            </h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button
                                    onClick={() => window.open('/index.html', '_blank')}
                                    className="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left"
                                >
                                    <i className="fas fa-external-link-alt text-blue-600 mr-2"></i>
                                    <span className="font-medium">Open Main ERP</span>
                                    <p className="text-sm text-gray-600 mt-1">Navigate to Users section</p>
                                </button>
                                
                                <button
                                    onClick={() => window.open('/user-management-test.html', '_blank')}
                                    className="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left"
                                >
                                    <i className="fas fa-vial text-green-600 mr-2"></i>
                                    <span className="font-medium">Run Full Test Suite</span>
                                    <p className="text-sm text-gray-600 mt-1">Comprehensive functionality test</p>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<UsersTest />, document.getElementById('root'));
    </script>
</body>
</html>
