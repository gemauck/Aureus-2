generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String                       @id @default(cuid())
  email                     String                       @unique
  name                      String?
  passwordHash              String?
  provider                  String                       @default("local")
  role                      String                       @default("user")
  status                    String                       @default("active")
  department                String                       @default("")
  jobTitle                  String                       @default("")
  phone                     String                       @default("")
  avatar                    String                       @default("")
  invitedBy                 String?
  mustChangePassword        Boolean                      @default(false)
  lastLoginAt               DateTime?
  employeeNumber            String?                      @unique
  position                  String                       @default("")
  employmentDate            DateTime?
  idNumber                  String                       @default("")
  taxNumber                 String?
  bankName                  String?
  accountNumber             String?
  branchCode                String?
  salary                    Float                        @default(0)
  employmentStatus          String                       @default("Active")
  address                   String                       @default("")
  emergencyContact          String                       @default("")
  createdAt                 DateTime                     @default(now())
  updatedAt                 DateTime                     @updatedAt
  lastSeenAt                DateTime?
  permissions               String                       @default("[]")
  accessibleProjectIds      String                       @default("[]")
  auditLogs                 AuditLog[]                   @relation("AuditActor")
  birthday                  Birthday?                    @relation("Birthdays")
  calendarNotes             CalendarNote[]
  ownedClients              Client[]                     @relation("ClientOwner")
  departmentNotesAssigned   DepartmentNotes[]            @relation("DepartmentNotesAssignee")
  feedback                  Feedback[]                   @relation("UserFeedback")
  feedbackReplies           FeedbackReply[]              @relation("FeedbackReplyAuthor")
  approvedLeaveApplications LeaveApplication[]           @relation("ApprovedLeaveApplications")
  rejectedLeaveApplications LeaveApplication[]           @relation("RejectedLeaveApplications")
  leaveApplications         LeaveApplication[]           @relation("LeaveApplications")
  leaveApprovers            LeaveApprover[]              @relation("LeaveApprovers")
  leaveBalances             LeaveBalance[]               @relation("LeaveBalances")
  actionItemsAssigned       MeetingActionItem[]          @relation("ActionItemAssignee")
  meetingComments           MeetingComment[]             @relation("MeetingCommentAuthor")
  meetingAllocations        MeetingUserAllocation[]      @relation("MeetingUserAllocations")
  memberships               Membership[]
  sentMessages              Message[]                    @relation("MessageSender")
  notifications             Notification[]               @relation("NotificationRecipient")
  notificationSettings      NotificationSetting?
  passwordHistory           PasswordHistory[]
  passwordResets            PasswordReset[]
  ownedProjects             Project[]                    @relation("ProjectOwner")
  securityEvents            SecurityEvent[]
  serviceFormTemplates      ServiceFormTemplate[]
  sessions                  Session[]
  starredClients            StarredClient[]
  starredOpportunities      StarredOpportunity[]
  tasks                     Task[]                       @relation("TaskAssignee")
  twoFactor                 TwoFactor?
  userTasks                 UserTask[]                   @relation("UserTaskOwner")
  userTaskTags              UserTaskTag[]                @relation("UserTaskTagOwner")
  userNotes                 UserNote[]                   @relation("UserNoteOwner")
  sharedNotes               UserNoteShare[]              @relation("UserNoteSharedWith")
  createdTickets            Ticket[]                     @relation("TicketCreator")
  assignedTickets           Ticket[]                     @relation("TicketAssignee")
  taskComments              TaskComment[]                @relation("TaskCommentAuthor")
  documentComments          DocumentItemComment[]        @relation("DocumentCommentAuthor")
  weeklyFMSComments         WeeklyFMSReviewItemComment[] @relation("WeeklyFMSCommentAuthor")
  monthlyFMSComments         MonthlyFMSReviewItemComment[] @relation("MonthlyFMSCommentAuthor")
  clientComments            ClientComment[]              @relation("ClientCommentAuthor")
  clientFollowUps           ClientFollowUp[]             @relation("ClientFollowUpAssignee")
  commentThreadSubscriptions CommentThreadSubscription[] @relation("CommentThreadSubscriber")
  projectCommentsAuthored   ProjectComment[]             @relation("ProjectCommentAuthor")
  projectDocumentsUploaded  ProjectDocument[]            @relation("ProjectDocumentUploader")
  projectTeamMemberships   ProjectTeamMember[]          @relation("ProjectTeamMemberUser")
  projectTeamMembersAdded   ProjectTeamMember[]          @relation("ProjectTeamMemberAdder")
  projectActivityLogs       ProjectActivityLog[]         @relation("ProjectActivityLogUser")

  @@index([createdAt])
  @@index([role])
  @@index([status])
  @@index([department])
  @@index([lastSeenAt])
}

model Team {
  id          String            @id @default(cuid())
  name        String
  icon        String?           // FontAwesome icon class (e.g., 'fa-user-tie')
  color       String?           // CSS color/theme color (e.g., 'blue', 'purple')
  description String?           // Team description
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  memberships Membership[]
  permissions TeamPermission[]
  documents   TeamDocument[]
  workflows   TeamWorkflow[]
  checklists  TeamChecklist[]
  notices     TeamNotice[]
  tasks       TeamTask[]
  executions  WorkflowExecution[]
}

model Membership {
  userId String
  teamId String
  role   String @default("user")
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, teamId])
  @@index([teamId])
  @@index([userId])
}

model TeamPermission {
  id          String   @id @default(cuid())
  teamId      String
  permission  String   // Permission description/identifier
  createdAt   DateTime @default(now())
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@index([teamId])
  @@unique([teamId, permission])
}

model Client {
  id              String   @id @default(cuid())
  name            String
  type            String
  industry        String   @default("Other")
  status          String   @default("Potential")
  stage           String   @default("Awareness")
  revenue         Float    @default(0)
  value           Float    @default(0)
  probability     Int      @default(0)
  lastContact     DateTime @default(now())
  address         String   @default("")
  website         String   @default("")
  notes           String   @default("")
  contacts        String   @default("[]")
  followUps       String   @default("[]")
  projectIds      String   @default("[]")
  comments        String   @default("[]")
  sites           String   @default("[]")
  contracts       String   @default("[]")
  activityLog     String   @default("[]")
  billingTerms    String   @default("{\"paymentTerms\":\"Net 30\",\"billingFrequency\":\"Monthly\",\"currency\":\"ZAR\",\"retainerAmount\":0,\"taxExempt\":false,\"notes\":\"\"}")
  ownerId         String?
  externalAgentId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  proposals       String   @default("[]")
  thumbnail       String   @default("")
  services        String   @default("[]")
  rssSubscribed   Boolean  @default(true)
  kyc             String   @default("{}")

  // JSONB columns for improved performance (Phase 1 Migration)
  // These columns are populated from String columns above
  contactsJsonb     Json?           @default("[]")
  followUpsJsonb    Json?           @default("[]")
  commentsJsonb     Json?           @default("[]")
  sitesJsonb        Json?           @default("[]")
  contractsJsonb    Json?           @default("[]")
  activityLogJsonb  Json?           @default("[]")
  billingTermsJsonb Json?           @default("{\"paymentTerms\":\"Net 30\",\"billingFrequency\":\"Monthly\",\"currency\":\"ZAR\",\"retainerAmount\":0,\"taxExempt\":false,\"notes\":\"\"}")
  proposalsJsonb    Json?           @default("[]")
  servicesJsonb     Json?           @default("[]")
  kycJsonb          Json?           @default("{}")
  owner             User?           @relation("ClientOwner", fields: [ownerId], references: [id])
  externalAgent     ExternalAgent?  @relation(fields: [externalAgentId], references: [id])
  newsArticles      ClientNews[]
  invoices          Invoice[]
  opportunities     Opportunity[]
  projects          Project[]
  salesOrders       SalesOrder[]
  starredBy         StarredClient[]
  tickets           Ticket[]

  // Company Group fields (Multiple group memberships)
  groupMemberships ClientCompanyGroup[] @relation("ClientGroups")
  groupChildren    ClientCompanyGroup[] @relation("GroupMembers")

  // Phase 3: Normalized tables
  clientContacts  ClientContact[]
  clientComments  ClientComment[]
  clientSites     ClientSite[]
  clientContracts ClientContract[]
  clientProposals ClientProposal[]
  clientFollowUps ClientFollowUp[]
  clientServices  ClientService[]

  @@index([createdAt])
  @@index([type])
  @@index([status])
  @@index([ownerId])
  @@index([externalAgentId])
}

model ClientCompanyGroup {
  id        String   @id @default(cuid())
  clientId  String
  groupId   String
  role      String?  @default("member")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation("ClientGroups", fields: [clientId], references: [id], onDelete: Cascade)
  group  Client @relation("GroupMembers", fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([clientId, groupId])
  @@index([clientId])
  @@index([groupId])
}

// Phase 3: Normalized Contact table
model ClientContact {
  id        String   @id @default(cuid())
  clientId  String
  name      String
  email     String?
  phone     String?
  mobile    String?
  role      String?
  title     String?
  isPrimary Boolean  @default(false)
  notes     String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([email])
  @@index([phone])
  @@index([mobile])
  @@index([isPrimary])
}

// Phase 3: Normalized Comment table
model ClientComment {
  id        String   @id @default(cuid())
  clientId  String
  text      String
  authorId  String?
  author    String   @default("") // Denormalized author name for quick display
  userName  String? // Username/email (denormalized)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client     Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  authorUser User?  @relation("ClientCommentAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([createdAt])
  @@index([authorId])
}

// Phase 6: Normalized Site table
model ClientSite {
  id            String   @id @default(cuid())
  clientId      String
  name          String
  address       String   @default("")
  contactPerson String?  @default("")
  contactPhone  String?  @default("")
  contactEmail  String?  @default("")
  notes         String   @default("")
  // Per-site lead tracking (for leads: each site can have its own stage/AIDA)
  siteLead      String?  @default("")
  stage         String?  @default("")
  aidaStatus    String?  @default("")
  // Site type: 'client' = do not show in Pipeline; 'lead' = show in Pipeline (clients can have sites that are still leads)
  siteType      String?  @default("lead")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([contactEmail])
}

// Phase 6: Normalized Contract table
model ClientContract {
  id         String   @id @default(cuid())
  clientId   String
  name       String
  size       Float?   @default(0)
  type       String?  @default("")
  uploadDate DateTime @default(now())
  url        String?  @default("")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([uploadDate])
}

// Phase 6: Normalized Proposal table
model ClientProposal {
  id                  String    @id @default(cuid())
  clientId            String
  title               String?   @default("")
  amount              Float?    @default(0)
  status              String?   @default("Pending")
  workingDocumentLink String?   @default("")
  createdDate         DateTime?
  expiryDate          DateTime?
  notes               String    @default("")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([status])
  @@index([createdDate])
}

// Phase 6: Normalized FollowUp table
model ClientFollowUp {
  id          String   @id @default(cuid())
  clientId    String
  date        String?  @default("")
  time        String?  @default("")
  type        String   @default("Call")
  description String   @default("")
  completed   Boolean  @default(false)
  assignedTo  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  assignee User?  @relation("ClientFollowUpAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([completed])
  @@index([date])
  @@index([assignedTo])
}

// Phase 6: Normalized Service table
model ClientService {
  id          String    @id @default(cuid())
  clientId    String
  name        String
  description String    @default("")
  price       Float?    @default(0)
  status      String?   @default("Active")
  startDate   DateTime?
  endDate     DateTime?
  notes       String    @default("")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([status])
  @@index([startDate])
}

model Industry {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([isActive])
}

model ExternalAgent {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clients   Client[]

  @@index([name])
  @@index([isActive])
}

model Project {
  id                           String                   @id @default(cuid())
  clientId                     String?
  name                         String
  description                  String                   @default("")
  clientName                   String                   @default("")
  status                       String                   @default("Planning")
  startDate                    DateTime                 @default(now())
  dueDate                      DateTime?
  budget                       Float                    @default(0)
  actualCost                   Float                    @default(0)
  progress                     Int                      @default(0)
  priority                     String                   @default("Medium")
  type                         String                   @default("Project")
  assignedTo                   String                   @default("")
  tasksList                    String                   @default("[]") // Legacy - deprecated, use Task table
  notes                        String                   @default("")
  hasTimeProcess               Boolean                  @default(false)
  hasDocumentCollectionProcess Boolean                  @default(false)
  documentSections             String                   @default("[]") // Legacy - deprecated, use DocumentSection table
  weeklyFMSReviewSections      String                   @default("[]") // Legacy - deprecated, use WeeklyFMSReviewSection table
  hasWeeklyFMSReviewProcess    Boolean                  @default(false)
  monthlyFMSReviewSections     String                   @default("[]") // Legacy - deprecated, use MonthlyFMSReviewSection table
  hasMonthlyFMSReviewProcess   Boolean                  @default(false)
  ownerId                      String?
  createdAt                    DateTime                 @default(now())
  updatedAt                    DateTime                 @updatedAt
  monthlyProgress              String                   @default("{}") // Keep as JSON - simple key-value structure, no complex queries needed
  invoices                     Invoice[]
  client                       Client?                  @relation(fields: [clientId], references: [id])
  owner                        User?                    @relation("ProjectOwner", fields: [ownerId], references: [id])
  tasks                        Task[]
  timeEntries                  TimeEntry[]
  tickets                      Ticket[]
  taskComments                 TaskComment[]
  documentSectionsTable        DocumentSection[]        @relation("DocumentSections")
  weeklyFMSReviewSectionsTable WeeklyFMSReviewSection[] @relation("WeeklyFMSReviewSections")
  monthlyFMSReviewSectionsTable MonthlyFMSReviewSection[] @relation("MonthlyFMSReviewSections")
  projectTaskLists              ProjectTaskList[]
  projectComments               ProjectComment[]         @relation("ProjectComments")
  projectDocuments              ProjectDocument[]
  projectTeamMembers            ProjectTeamMember[]
  projectCustomFieldDefinitions ProjectCustomFieldDefinition[]
  projectActivityLogs           ProjectActivityLog[]

  @@index([clientId])
  @@index([status])
  @@index([ownerId])
  @@index([createdAt])
}

model ProjectTaskList {
  id        String   @id @default(cuid())
  projectId String
  name      String   @default("")
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model ProjectComment {
  id        String          @id @default(cuid())
  projectId String
  parentId  String?
  text      String          @default("")
  authorId  String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  project   Project         @relation("ProjectComments", fields: [projectId], references: [id], onDelete: Cascade)
  authorUser User?          @relation("ProjectCommentAuthor", fields: [authorId], references: [id])
  parent   ProjectComment?  @relation("ProjectCommentReplies", fields: [parentId], references: [id])
  replies  ProjectComment[] @relation("ProjectCommentReplies")

  @@index([projectId])
  @@index([parentId])
  @@index([authorId])
}

model ProjectDocument {
  id         String   @id @default(cuid())
  projectId  String
  name       String   @default("")
  filePath   String   @default("")
  isActive   Boolean  @default(true)
  uploadDate DateTime @default(now())
  uploaderId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploader   User?    @relation("ProjectDocumentUploader", fields: [uploaderId], references: [id])

  @@index([projectId])
  @@index([uploaderId])
}

model ProjectTeamMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String?
  addedById String?
  addedDate DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User?    @relation("ProjectTeamMemberUser", fields: [userId], references: [id])
  adder     User?    @relation("ProjectTeamMemberAdder", fields: [addedById], references: [id])

  @@index([projectId])
  @@index([userId])
  @@index([addedById])
}

model ProjectCustomFieldDefinition {
  id        String   @id @default(cuid())
  projectId String
  name      String   @default("")
  type      String   @default("text")
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model ProjectActivityLog {
  id        String   @id @default(cuid())
  projectId String
  userId    String?
  action    String   @default("")
  details   String   @default("")
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User?    @relation("ProjectActivityLogUser", fields: [userId], references: [id])

  @@index([projectId])
  @@index([userId])
  @@index([createdAt])
}

model Opportunity {
  id        String               @id @default(cuid())
  clientId  String
  title     String
  stage     String               @default("Awareness")
  value     Float                @default(0)
  ownerId   String?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  proposals String               @default("[]")
  status    String               @default("Potential")
  client    Client               @relation(fields: [clientId], references: [id])
  starredBy StarredOpportunity[]

  @@index([clientId])
  @@index([createdAt])
  @@index([ownerId])
  @@index([status])
}

model SalesOrder {
  id              String    @id @default(cuid())
  orderNumber     String    @unique
  clientId        String?
  clientName      String    @default("")
  opportunityId   String?
  status          String    @default("draft")
  priority        String    @default("normal")
  orderDate       DateTime  @default(now())
  requiredDate    DateTime?
  shippedDate     DateTime?
  subtotal        Float     @default(0)
  tax             Float     @default(0)
  total           Float     @default(0)
  items           String    @default("[]")
  shippingAddress String    @default("")
  shippingMethod  String    @default("")
  notes           String    @default("")
  internalNotes   String    @default("")
  ownerId         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  client          Client?   @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@index([status])
  @@index([ownerId])
  @@index([opportunityId])
}

model Invoice {
  id            String    @id @default(cuid())
  clientId      String?
  projectId     String?
  invoiceNumber String    @unique
  clientName    String    @default("")
  issueDate     DateTime  @default(now())
  dueDate       DateTime?
  status        String    @default("Draft")
  subtotal      Float     @default(0)
  tax           Float     @default(0)
  total         Float     @default(0)
  balance       Float     @default(0)
  items         String    @default("[]")
  notes         String    @default("")
  ownerId       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  client        Client?   @relation(fields: [clientId], references: [id])
  project       Project?  @relation(fields: [projectId], references: [id])
}

model Task {
  id             String    @id @default(cuid())
  projectId      String
  parentTaskId   String?
  title          String
  description    String    @default("")
  status         String    @default("todo")
  priority       String    @default("Medium")
  assigneeId     String?
  assignee       String    @default("") // Denormalized assignee name
  dueDate        DateTime?
  listId         Int? // Task list/column ID (for Kanban)
  estimatedHours Float?
  actualHours    Float?
  blockedBy      String    @default("")

  // JSON fields for complex data (can be migrated to separate tables later if needed)
  tags         String @default("[]") // JSON array of tag strings
  attachments  String @default("[]") // JSON array of attachment objects
  checklist    String @default("[]") // JSON array of checklist items
  dependencies String @default("[]") // JSON array of task IDs
  subscribers  String @default("[]") // JSON array of user IDs
  customFields String @default("{}") // JSON object for custom field values

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assigneeUser User?         @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  parentTask   Task?         @relation("Subtasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subtasks     Task[]        @relation("Subtasks")
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  // TODO: Add comments relation after Task FK is added: comments TaskComment[]

  @@index([assigneeId])
  @@index([projectId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([createdAt])
  @@index([listId])
  @@index([parentTaskId])
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String // Task ID - now a foreign key to Task table
  projectId String // Project ID for quick queries and relations
  text      String
  authorId  String? // User ID if available
  author    String // Author name (denormalized for quick display)
  userName  String? // Username/email (denormalized)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // TODO: Add Task FK after tasks are migrated: task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  authorUser User?   @relation("TaskCommentAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@index([taskId])
  @@index([projectId])
  @@index([createdAt])
  @@index([authorId])
}

model TimeEntry {
  id          String   @id @default(cuid())
  projectId   String?
  date        DateTime @default(now())
  hours       Float
  projectName String   @default("")
  task        String   @default("")
  description String   @default("")
  employee    String   @default("")
  billable    Boolean  @default(true)
  rate        Float    @default(0)
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  project     Project? @relation(fields: [projectId], references: [id])
}

// Document Collection Tables
model DocumentSection {
  id          String   @id @default(cuid())
  projectId   String
  year        Int // Year this section belongs to (e.g., 2024, 2025)
  name        String
  description String   @default("")
  order       Int      @default(0) // For sorting sections
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project   Project        @relation("DocumentSections", fields: [projectId], references: [id], onDelete: Cascade)
  documents DocumentItem[]

  @@index([projectId])
  @@index([projectId, year])
  @@index([order])
}

model DocumentItem {
  id          String   @id @default(cuid())
  sectionId   String
  name        String
  description String   @default("")
  required    Boolean  @default(false)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  section  DocumentSection       @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  statuses DocumentItemStatus[]
  comments DocumentItemComment[]

  @@index([sectionId])
  @@index([order])
}

model DocumentItemStatus {
  id        String   @id @default(cuid())
  itemId    String
  year      Int // Year (e.g., 2024)
  month     Int // Month (1-12)
  status    String   @default("pending") // pending, collected, not_applicable, etc.
  updatedBy String? // User ID
  updatedAt DateTime @default(now())

  item DocumentItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([itemId, year, month])
  @@index([itemId])
  @@index([year, month])
}

model DocumentItemComment {
  id          String   @id @default(cuid())
  itemId      String
  year        Int
  month       Int
  text        String
  authorId    String?
  author      String   // Denormalized author name
  attachments String?  @default("[]") // JSON array of { name, url }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  item       DocumentItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  authorUser User?        @relation("DocumentCommentAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@index([itemId])
  @@index([itemId, year, month])
  @@index([createdAt])
}

// Weekly FMS Review Tables (duplicated from Monthly FMS Review)
model WeeklyFMSReviewSection {
  id          String   @id @default(cuid())
  projectId   String
  year        Int // Year (e.g., 2024)
  name        String
  description String   @default("")
  reviewer    String?  @default("") // Optional reviewer name
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project               @relation("WeeklyFMSReviewSections", fields: [projectId], references: [id], onDelete: Cascade)
  items   WeeklyFMSReviewItem[]

  @@index([projectId])
  @@index([projectId, year])
  @@index([order])
}

model WeeklyFMSReviewItem {
  id          String   @id @default(cuid())
  sectionId   String
  name        String
  description String   @default("")
  required    Boolean  @default(false)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  section  WeeklyFMSReviewSection       @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  statuses WeeklyFMSReviewItemStatus[]
  comments WeeklyFMSReviewItemComment[]

  @@index([sectionId])
  @@index([order])
}

model WeeklyFMSReviewItemStatus {
  id        String   @id @default(cuid())
  itemId    String
  year      Int // Year (e.g., 2024)
  month     Int // Month (1-12)
  status    String   @default("pending") // pending, completed, not_applicable, etc.
  updatedBy String? // User ID
  updatedAt DateTime @default(now())

  item WeeklyFMSReviewItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([itemId, year, month])
  @@index([itemId])
  @@index([year, month])
}

model WeeklyFMSReviewItemComment {
  id          String   @id @default(cuid())
  itemId      String
  year        Int
  month       Int
  text        String
  authorId    String?
  author      String   // Denormalized author name
  attachments String?  @default("[]") // JSON array of { name, url }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  item       WeeklyFMSReviewItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  authorUser User?               @relation("WeeklyFMSCommentAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@index([itemId])
  @@index([itemId, year, month])
  @@index([createdAt])
}

model MonthlyFMSReviewSection {
  id          String   @id @default(cuid())
  projectId   String
  year        Int // Year (e.g., 2024)
  name        String
  description String   @default("")
  reviewer    String?  @default("") // Optional reviewer name
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project               @relation("MonthlyFMSReviewSections", fields: [projectId], references: [id], onDelete: Cascade)
  items   MonthlyFMSReviewItem[]

  @@index([projectId])
  @@index([projectId, year])
  @@index([order])
}

model MonthlyFMSReviewItem {
  id          String   @id @default(cuid())
  sectionId   String
  name        String
  description String   @default("")
  required    Boolean  @default(false)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  section  MonthlyFMSReviewSection       @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  statuses MonthlyFMSReviewItemStatus[]
  comments MonthlyFMSReviewItemComment[]

  @@index([sectionId])
  @@index([order])
}

model MonthlyFMSReviewItemStatus {
  id        String   @id @default(cuid())
  itemId    String
  year      Int // Year (e.g., 2024)
  month     Int // Month (1-12)
  status    String   @default("pending") // pending, completed, not_applicable, etc.
  updatedBy String? // User ID
  updatedAt DateTime @default(now())

  item MonthlyFMSReviewItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([itemId, year, month])
  @@index([itemId])
  @@index([year, month])
}

model MonthlyFMSReviewItemComment {
  id          String   @id @default(cuid())
  itemId      String
  year        Int
  month       Int
  text        String
  authorId    String?
  author      String   // Denormalized author name
  attachments String?  @default("[]") // JSON array of { name, url }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  item       MonthlyFMSReviewItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  authorUser User?                @relation("MonthlyFMSCommentAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@index([itemId])
  @@index([itemId, year, month])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String
  action    String
  entity    String
  entityId  String
  diff      String?
  createdAt DateTime @default(now())
  actor     User     @relation("AuditActor", fields: [actorId], references: [id])
}

model Invitation {
  id                   String    @id @default(cuid())
  email                String    @unique
  name                 String
  role                 String    @default("user")
  token                String    @unique
  status               String    @default("pending")
  invitedBy            String?
  expiresAt            DateTime
  acceptedAt           DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  accessibleProjectIds String    @default("[]")

  @@index([createdAt])
  @@index([status])
}

model Feedback {
  id        String          @id @default(cuid())
  userId    String?
  pageUrl   String
  section   String          @default("")
  message   String
  type      String          @default("feedback")
  severity  String          @default("medium")
  meta      String?
  createdAt DateTime        @default(now())
  user      User?           @relation("UserFeedback", fields: [userId], references: [id])
  replies   FeedbackReply[]

  @@index([pageUrl])
  @@index([section])
  @@index([userId])
  @@index([createdAt])
}

model FeedbackReply {
  id         String   @id @default(cuid())
  feedbackId String
  userId     String?
  message    String
  createdAt  DateTime @default(now())
  feedback   Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  user       User?    @relation("FeedbackReplyAuthor", fields: [userId], references: [id])

  @@index([feedbackId])
  @@index([userId])
  @@index([createdAt])
}

model Ticket {
  id           String @id @default(cuid())
  ticketNumber String @unique
  title        String
  description  String @default("")
  status       String @default("open")
  priority     String @default("medium")
  category     String @default("general")
  type         String @default("internal")

  // Relationships
  createdById     String
  assignedToId    String?
  clientId        String?
  projectId       String?
  relatedTicketId String?

  // Metadata
  tags         String @default("[]")
  attachments  String @default("[]")
  comments     String @default("[]")
  activityLog  String @default("[]")
  customFields String @default("{}")

  // Email Integration
  sourceEmail    String? // Email address that created this ticket
  emailThreadId  String? // Thread ID for email threading (Message-ID or In-Reply-To)
  emailMessageId String? // Unique message ID from email provider
  emailSubject   String? // Original email subject

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  resolvedAt      DateTime?
  closedAt        DateTime?
  dueDate         DateTime?
  firstResponseAt DateTime?

  // SLA Tracking
  responseTimeMinutes     Int?
  resolutionTimeMinutes   Int?
  targetResponseMinutes   Int?
  targetResolutionMinutes Int?

  // Relations
  createdBy      User     @relation("TicketCreator", fields: [createdById], references: [id])
  assignedTo     User?    @relation("TicketAssignee", fields: [assignedToId], references: [id])
  client         Client?  @relation(fields: [clientId], references: [id])
  project        Project? @relation(fields: [projectId], references: [id])
  relatedTicket  Ticket?  @relation("RelatedTickets", fields: [relatedTicketId], references: [id])
  relatedTickets Ticket[] @relation("RelatedTickets")

  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([createdById])
  @@index([assignedToId])
  @@index([emailThreadId])
  @@index([emailMessageId])
  @@index([sourceEmail])
  @@index([clientId])
  @@index([projectId])
  @@index([createdAt])
  @@index([dueDate])
  @@index([ticketNumber])
}

model TeamDocument {
  id          String                    @id @default(cuid())
  teamId      String
  title       String
  category    String                    @default("General")
  description String                    @default("")
  content     String                    @default("")
  version     String                    @default("1.0")
  status      String                    @default("Draft")
  tags        Json?                     @default("[]") // JSONB array of strings
  attachments Json?                     @default("[]") // JSONB array of attachment objects
  createdBy   String                    @default("")
  ownerId     String?
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  team        Team                      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@index([teamId])
  @@index([status])
  @@index([category])
}

model TeamWorkflow {
  id          String                  @id @default(cuid())
  teamId      String
  title       String
  description String                  @default("")
  status      String                  @default("Draft")
  steps       Json?                   @default("[]") // JSONB array of workflow step objects
  tags        Json?                   @default("[]") // JSONB array of strings
  ownerId     String?
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  team        Team                    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  executions  WorkflowExecution[]      @relation("WorkflowExecutions")
  
  @@index([teamId])
  @@index([status])
}

model TeamChecklist {
  id          String   @id @default(cuid())
  teamId      String
  title       String
  description String   @default("")
  category    String   @default("General")
  frequency   String   @default("One-time")
  items       Json?    @default("[]") // JSONB array of checklist item objects
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@index([teamId])
  @@index([category])
  @@index([frequency])
}

model TeamNotice {
  id        String   @id @default(cuid())
  teamId    String
  title     String
  content   String
  priority  String   @default("Normal")
  author    String   @default("")
  date      DateTime @default(now())
  ownerId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@index([teamId])
  @@index([date])
  @@index([priority])
}

model WorkflowExecution {
  id             String        @id @default(cuid())
  workflowId     String?       // Optional: may reference a TeamWorkflow or be standalone
  workflowTitle  String
  teamId         String
  completedSteps Json?         @default("[]") // JSONB array of completed step identifiers
  notes          String        @default("")
  executedBy     String        @default("")
  executionDate  DateTime      @default(now())
  status         String        @default("Completed")
  ownerId        String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  team           Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  workflow       TeamWorkflow? @relation("WorkflowExecutions", fields: [workflowId], references: [id], onDelete: SetNull)
  
  @@index([teamId])
  @@index([workflowId])
  @@index([executionDate])
  @@index([status])
}

model TeamTask {
  id          String    @id @default(cuid())
  teamId      String
  title       String
  description String    @default("")
  status      String    @default("todo")
  priority    String    @default("Medium")
  assigneeId  String?
  dueDate     DateTime?
  tags        Json?     @default("[]") // JSONB array of strings
  attachments Json?     @default("[]") // JSONB array of attachment objects
  ownerId     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@index([teamId])
  @@index([status])
  @@index([priority])
  @@index([assigneeId])
  @@index([dueDate])
}

model InventoryItem {
  id                      String         @id @default(cuid())
  sku                     String
  name                    String
  category                String         @default("components")
  type                    String         @default("component")
  quantity                Float          @default(0)
  unit                    String         @default("pcs")
  reorderPoint            Float          @default(0)
  reorderQty              Float          @default(0)
  location                String         @default("")
  unitCost                Float          @default(0)
  totalValue              Float          @default(0)
  supplier                String         @default("")
  status                  String         @default("in_stock")
  lastRestocked           DateTime?
  ownerId                 String?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  thumbnail               String         @default("")
  legacyPartNumber        String         @default("")
  supplierPartNumbers     String         @default("[]")
  allocatedQuantity       Float          @default(0)
  completedQuantity       Float          @default(0)
  inProductionQuantity    Float          @default(0)
  locationId              String?
  manufacturingPartNumber String         @default("")
  boms                    BOM[]          @relation("BOMFinishedProduct")
  stockLocation           StockLocation? @relation(fields: [locationId], references: [id])

  @@index([sku])
  @@index([category])
  @@index([status])
  @@index([ownerId])
  @@index([locationId])
}

model BOM {
  id                String         @id @default(cuid())
  productSku        String
  productName       String
  version           String         @default("1.0")
  status            String         @default("active")
  effectiveDate     DateTime       @default(now())
  laborCost         Float          @default(0)
  overheadCost      Float          @default(0)
  totalMaterialCost Float          @default(0)
  totalCost         Float          @default(0)
  estimatedTime     Int            @default(0)
  components        String         @default("[]")
  notes             String         @default("")
  ownerId           String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  instructions      String         @default("")
  thumbnail         String         @default("")
  inventoryItemId   String?
  inventoryItem     InventoryItem? @relation("BOMFinishedProduct", fields: [inventoryItemId], references: [id])

  @@index([productSku])
  @@index([status])
  @@index([ownerId])
  @@index([inventoryItemId])
}

model ProductionOrder {
  id               String    @id @default(cuid())
  bomId            String    @default("")
  productSku       String
  productName      String
  quantity         Int       @default(0)
  quantityProduced Int       @default(0)
  status           String    @default("requested")
  priority         String    @default("normal")
  startDate        DateTime  @default(now())
  targetDate       DateTime?
  completedDate    DateTime?
  assignedTo       String    @default("")
  totalCost        Float     @default(0)
  notes            String    @default("")
  createdBy        String    @default("")
  ownerId          String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  workOrderNumber  String    @default("")
  allocationType   String    @default("stock")
  clientId         String?

  @@index([status])
  @@index([bomId])
  @@index([ownerId])
  @@index([clientId])
}

model StockMovement {
  id           String   @id @default(cuid())
  movementId   String
  date         DateTime @default(now())
  type         String
  itemName     String
  sku          String
  quantity     Float
  fromLocation String   @default("")
  toLocation   String   @default("")
  reference    String   @default("")
  performedBy  String   @default("")
  notes        String   @default("")
  ownerId      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([date])
  @@index([type])
  @@index([sku])
  @@index([ownerId])
}

model StockLocation {
  id             String              @id @default(cuid())
  code           String              @unique
  name           String
  type           String              @default("warehouse")
  status         String              @default("active")
  address        String              @default("")
  contactPerson  String              @default("")
  contactPhone   String              @default("")
  meta           String              @default("{}")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  inventoryItems InventoryItem[]
  inventory      LocationInventory[]

  @@index([type])
  @@index([status])
}

model LocationInventory {
  id            String        @id @default(cuid())
  locationId    String
  sku           String
  itemName      String
  quantity      Float         @default(0)
  unitCost      Float         @default(0)
  reorderPoint  Float         @default(0)
  lastRestocked DateTime?
  status        String        @default("in_stock")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  location      StockLocation @relation(fields: [locationId], references: [id])

  @@unique([locationId, sku])
  @@index([sku])
  @@index([locationId])
}

model Supplier {
  id             String          @id @default(cuid())
  code           String          @default("")
  name           String
  contactPerson  String          @default("")
  email          String          @default("")
  phone          String          @default("")
  website        String          @default("")
  address        String          @default("")
  paymentTerms   String          @default("Net 30")
  status         String          @default("active")
  notes          String          @default("")
  ownerId        String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  purchaseOrders PurchaseOrder[]

  @@index([name])
  @@index([status])
  @@index([ownerId])
}

model PurchaseOrder {
  id              String    @id @default(cuid())
  orderNumber     String    @unique
  supplierId      String
  supplierName    String    @default("")
  status          String    @default("draft")
  priority        String    @default("normal")
  orderDate       DateTime  @default(now())
  expectedDate    DateTime?
  receivedDate    DateTime?
  subtotal        Float     @default(0)
  tax             Float     @default(0)
  total           Float     @default(0)
  items           String    @default("[]")
  shippingAddress String    @default("")
  shippingMethod  String    @default("")
  notes           String    @default("")
  internalNotes   String    @default("")
  ownerId         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  supplier        Supplier  @relation(fields: [supplierId], references: [id])

  @@index([supplierId])
  @@index([status])
  @@index([ownerId])
}

model Message {
  id        String   @id @default(cuid())
  senderId  String
  content   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sender    User     @relation("MessageSender", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([createdAt])
  @@index([read])
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

model CalendarNote {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime
  note      String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  deviceInfo   String?
  ipAddress    String?
  userAgent    String?
  location     String?
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model TwoFactor {
  id          String   @id @default(cuid())
  userId      String   @unique
  secret      String
  backupCodes String
  enabled     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model SecurityEvent {
  id        String   @id @default(cuid())
  userId    String
  eventType String
  ipAddress String?
  userAgent String?
  details   String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
}

model PasswordHistory {
  id           String   @id @default(cuid())
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

model Vehicle {
  id          String    @id @default(cuid())
  name        String
  model       String    @default("")
  type        String    @default("")
  reg         String    @unique
  assetNumber String    @default("")
  status      String    @default("active")
  notes       String    @default("")
  ownerId     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  jobCards    JobCard[]

  @@index([status])
  @@index([ownerId])
  @@index([reg])
}

model JobCard {
  id                  String                @id @default(cuid())
  jobCardNumber       String                @unique
  agentName           String                @default("")
  otherTechnicians    String                @default("[]")
  clientId            String?
  clientName          String                @default("")
  siteId              String                @default("")
  siteName            String                @default("")
  location            String                @default("")
  timeOfDeparture     DateTime?
  timeOfArrival       DateTime?
  vehicleUsed         String                @default("")
  kmReadingBefore     Float                 @default(0)
  kmReadingAfter      Float                 @default(0)
  travelKilometers    Float                 @default(0)
  reasonForVisit      String                @default("")
  diagnosis           String                @default("")
  otherComments       String                @default("")
  photos              String                @default("[]")
  status              String                @default("draft")
  submittedAt         DateTime?
  completedAt         DateTime?
  ownerId             String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  actionsTaken        String                @default("")
  materialsBought     String                @default("[]")
  stockUsed           String                @default("[]")
  totalMaterialsCost  Float                 @default(0)
  arrivalBackAtOffice DateTime?
  departureFromSite   DateTime?
  locationLatitude    String                @default("")
  locationLongitude   String                @default("")
  totalTimeMinutes    Int                   @default(0)
  vehicleId           String?
  vehicle             Vehicle?              @relation(fields: [vehicleId], references: [id])
  serviceForms        ServiceFormInstance[]

  @@index([clientId])
  @@index([ownerId])
  @@index([status])
  @@index([createdAt])
  @@index([vehicleId])
}

model ServiceFormTemplate {
  id          String                @id @default(cuid())
  name        String
  description String                @default("")
  category    String                @default("General")
  isActive    Boolean               @default(true)
  version     Int                   @default(1)
  fields      String                @default("[]")
  createdById String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  instances   ServiceFormInstance[]
  createdBy   User?                 @relation(fields: [createdById], references: [id])

  @@index([category])
  @@index([isActive])
  @@index([createdById])
}

model ServiceFormInstance {
  id              String              @id @default(cuid())
  jobCardId       String
  templateId      String
  templateName    String              @default("")
  templateVersion Int                 @default(1)
  status          String              @default("not_started")
  answers         String              @default("[]")
  completedAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  jobCard         JobCard             @relation(fields: [jobCardId], references: [id], onDelete: Cascade)
  template        ServiceFormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([jobCardId])
  @@index([templateId])
  @@index([status])
  @@index([createdAt])
}

model ClientNews {
  id          String   @id @default(cuid())
  clientId    String
  title       String
  description String   @default("")
  url         String   @default("")
  source      String   @default("Unknown")
  publishedAt DateTime @default(now())
  isNew       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([publishedAt])
  @@index([isNew])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  link      String   @default("")
  read      Boolean  @default(false)
  metadata  String   @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([type])
}

// Subscriptions to comment threads (clients, leads, document items, etc.). Tasks use task.subscribers.
model CommentThreadSubscription {
  id         String   @id @default(cuid())
  threadType String   // 'client' | 'lead' | 'document_item' | 'weekly_fms' | 'monthly_fms'
  threadId   String   // clientId, leadId, or "itemId:year:month" for document/FMS
  userId     String
  createdAt  DateTime @default(now())
  user       User     @relation("CommentThreadSubscriber", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadType, threadId, userId])
  @@index([threadType, threadId])
  @@index([userId])
}

model NotificationSetting {
  id            String   @id @default(cuid())
  userId        String   @unique
  emailMentions Boolean  @default(true)
  emailComments Boolean  @default(true)
  emailTasks    Boolean  @default(true)
  emailInvoices Boolean  @default(true)
  emailSystem   Boolean  @default(true)
  inAppMentions Boolean  @default(true)
  inAppComments Boolean  @default(true)
  inAppTasks    Boolean  @default(true)
  inAppInvoices Boolean  @default(true)
  inAppSystem   Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model StarredClient {
  id        String   @id @default(cuid())
  userId    String
  clientId  String
  createdAt DateTime @default(now())
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId])
  @@index([userId])
  @@index([clientId])
}

model StarredOpportunity {
  id            String      @id @default(cuid())
  userId        String
  opportunityId String
  createdAt     DateTime    @default(now())
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, opportunityId])
  @@index([userId])
  @@index([opportunityId])
}

model SystemSettings {
  id                    String   @id @default("system")
  companyName           String   @default("Abcotronics")
  timezone              String   @default("Africa/Johannesburg")
  currency              String   @default("ZAR")
  dateFormat            String   @default("DD/MM/YYYY")
  language              String   @default("en")
  sessionTimeout        Int      @default(30)
  requirePasswordChange Boolean  @default(false)
  twoFactorAuth         Boolean  @default(false)
  auditLogging          Boolean  @default(true)
  emailProvider         String   @default("gmail")
  googleCalendar        Boolean  @default(false)
  quickbooks            Boolean  @default(false)
  slack                 Boolean  @default(false)
  updatedBy             String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([updatedBy])
}

model LeaveApplication {
  id              String    @id @default(cuid())
  userId          String
  leaveType       String
  startDate       DateTime
  endDate         DateTime
  days            Int
  reason          String
  emergency       Boolean   @default(false)
  status          String    @default("pending")
  appliedDate     DateTime  @default(now())
  approvedDate    DateTime?
  rejectedDate    DateTime?
  approvedById    String?
  rejectedById    String?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  approvedBy      User?     @relation("ApprovedLeaveApplications", fields: [approvedById], references: [id])
  rejectedBy      User?     @relation("RejectedLeaveApplications", fields: [rejectedById], references: [id])
  user            User      @relation("LeaveApplications", fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([approvedById])
}

model LeaveBalance {
  id        String   @id @default(cuid())
  userId    String
  leaveType String
  available Float    @default(0)
  used      Float    @default(0)
  balance   Float    @default(0)
  year      Int
  notes     String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("LeaveBalances", fields: [userId], references: [id])

  @@unique([userId, leaveType, year])
  @@index([userId])
  @@index([leaveType])
  @@index([year])
}

model LeaveApprover {
  id         String   @id @default(cuid())
  department String
  approverId String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  approver   User     @relation("LeaveApprovers", fields: [approverId], references: [id])

  @@unique([department, approverId])
  @@index([department])
  @@index([approverId])
}

model Birthday {
  id        String   @id @default(cuid())
  userId    String   @unique
  date      DateTime
  notes     String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("Birthdays", fields: [userId], references: [id])

  @@index([userId])
  @@index([date])
}

model MonthlyMeetingNotes {
  id              String                  @id @default(cuid())
  monthKey        String                  @unique
  monthlyGoals    String                  @default("")
  status          String                  @default("active")
  ownerId         String?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  actionItems     MeetingActionItem[]
  comments        MeetingComment[]
  userAllocations MeetingUserAllocation[]
  weeklyNotes     WeeklyMeetingNotes[]

  @@index([monthKey])
  @@index([status])
  @@index([ownerId])
}

model WeeklyMeetingNotes {
  id              String              @id @default(cuid())
  monthlyNotesId  String
  weekKey         String
  weekStart       DateTime
  weekEnd         DateTime?
  ownerId         String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  departmentNotes DepartmentNotes[]
  actionItems     MeetingActionItem[]
  monthlyNotes    MonthlyMeetingNotes @relation(fields: [monthlyNotesId], references: [id], onDelete: Cascade)

  @@unique([monthlyNotesId, weekKey])
  @@index([monthlyNotesId])
  @@index([weekKey])
  @@index([ownerId])
}

model DepartmentNotes {
  id             String              @id @default(cuid())
  weeklyNotesId  String
  departmentId   String
  successes      String              @default("")
  weekToFollow   String              @default("")
  frustrations   String              @default("")
  agendaPoints   String              @default("[]")
  attachments    String              @default("[]") // JSON array of attachment objects
  assignedUserId String?
  ownerId        String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  assignedUser   User?               @relation("DepartmentNotesAssignee", fields: [assignedUserId], references: [id])
  weeklyNotes    WeeklyMeetingNotes  @relation(fields: [weeklyNotesId], references: [id], onDelete: Cascade)
  actionItems    MeetingActionItem[]
  comments       MeetingComment[]

  @@unique([weeklyNotesId, departmentId])
  @@index([weeklyNotesId])
  @@index([departmentId])
  @@index([assignedUserId])
}

model MeetingActionItem {
  id                String               @id @default(cuid())
  monthlyNotesId    String?
  weeklyNotesId     String?
  departmentNotesId String?
  title             String
  description       String               @default("")
  status            String               @default("open")
  priority          String               @default("medium")
  assignedUserId    String?
  dueDate           DateTime?
  completedDate     DateTime?
  ownerId           String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  assignedUser      User?                @relation("ActionItemAssignee", fields: [assignedUserId], references: [id])
  departmentNotes   DepartmentNotes?     @relation(fields: [departmentNotesId], references: [id], onDelete: Cascade)
  monthlyNotes      MonthlyMeetingNotes? @relation(fields: [monthlyNotesId], references: [id], onDelete: Cascade)
  weeklyNotes       WeeklyMeetingNotes?  @relation(fields: [weeklyNotesId], references: [id], onDelete: Cascade)
  comments          MeetingComment[]

  @@index([monthlyNotesId])
  @@index([weeklyNotesId])
  @@index([departmentNotesId])
  @@index([assignedUserId])
  @@index([status])
  @@index([dueDate])
}

model MeetingComment {
  id                String               @id @default(cuid())
  monthlyNotesId    String?
  departmentNotesId String?
  actionItemId      String?
  content           String
  authorId          String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  actionItem        MeetingActionItem?   @relation(fields: [actionItemId], references: [id], onDelete: Cascade)
  author            User                 @relation("MeetingCommentAuthor", fields: [authorId], references: [id])
  departmentNotes   DepartmentNotes?     @relation(fields: [departmentNotesId], references: [id], onDelete: Cascade)
  monthlyNotes      MonthlyMeetingNotes? @relation(fields: [monthlyNotesId], references: [id], onDelete: Cascade)

  @@index([monthlyNotesId])
  @@index([departmentNotesId])
  @@index([actionItemId])
  @@index([authorId])
  @@index([createdAt])
}

model MeetingUserAllocation {
  id             String              @id @default(cuid())
  monthlyNotesId String
  departmentId   String
  userId         String
  role           String              @default("contributor")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  monthlyNotes   MonthlyMeetingNotes @relation(fields: [monthlyNotesId], references: [id], onDelete: Cascade)
  user           User                @relation("MeetingUserAllocations", fields: [userId], references: [id])

  @@unique([monthlyNotesId, departmentId, userId])
  @@index([monthlyNotesId])
  @@index([departmentId])
  @@index([userId])
}

model UserTask {
  id             String                @id @default(cuid())
  title          String
  description    String                @default("")
  status         String                @default("todo")
  priority       String                @default("medium")
  category       String                @default("")
  dueDate        DateTime?
  completedDate  DateTime?
  ownerId        String
  clientId       String?
  projectId      String?
  leadId         String?
  checklist      String                @default("[]")
  photos         String                @default("[]")
  files          String                @default("[]")
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  googleEventId  String?
  googleEventUrl String?
  owner          User                  @relation("UserTaskOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  tags           UserTaskTagRelation[]

  @@index([ownerId])
  @@index([status])
  @@index([category])
  @@index([dueDate])
  @@index([clientId])
  @@index([projectId])
  @@index([leadId])
  @@index([createdAt])
}

model UserTaskTag {
  id        String                @id @default(cuid())
  name      String
  color     String                @default("#3B82F6")
  ownerId   String
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  owner     User                  @relation("UserTaskTagOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  tasks     UserTaskTagRelation[]

  @@unique([ownerId, name])
  @@index([ownerId])
  @@index([name])
}

model UserTaskTagRelation {
  id        String      @id @default(cuid())
  taskId    String
  tagId     String
  createdAt DateTime    @default(now())
  tag       UserTaskTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  task      UserTask    @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
  @@index([taskId])
  @@index([tagId])
}

model DocumentCollectionTemplate {
  id          String   @id @default(cuid())
  name        String
  description String   @default("")
  sections    String   @default("[]")
  isDefault   Boolean  @default(false)
  type        String   @default("document-collection") // "document-collection" or "weekly-fms-review"
  ownerId     String?
  createdBy   String   @default("")
  updatedBy   String   @default("")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isDefault])
  @@index([ownerId])
  @@index([createdAt])
  @@index([type])
}

model UserNote {
  id         String          @id @default(cuid())
  title      String
  content    String          @default("")
  tags       String          @default("[]") // JSON array of tag strings
  ownerId    String
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  owner      User            @relation("UserNoteOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  sharedWith UserNoteShare[]

  @@index([ownerId])
  @@index([createdAt])
  @@index([updatedAt])
}

model UserNoteShare {
  id        String   @id @default(cuid())
  noteId    String
  userId    String
  createdAt DateTime @default(now())
  note      UserNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  user      User     @relation("UserNoteSharedWith", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([noteId, userId])
  @@index([noteId])
  @@index([userId])
}
