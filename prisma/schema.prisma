generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String                  @id @default(cuid())
  email                     String                  @unique
  name                      String?
  passwordHash              String?
  provider                  String                  @default("local")
  role                      String                  @default("user")
  status                    String                  @default("active")
  department                String                  @default("")
  jobTitle                  String                  @default("")
  phone                     String                  @default("")
  avatar                    String                  @default("")
  invitedBy                 String?
  mustChangePassword        Boolean                 @default(false)
  lastLoginAt               DateTime?
  employeeNumber            String?                 @unique
  position                  String                  @default("")
  employmentDate            DateTime?
  idNumber                  String                  @default("")
  taxNumber                 String?
  bankName                  String?
  accountNumber             String?
  branchCode                String?
  salary                    Float                   @default(0)
  employmentStatus          String                  @default("Active")
  address                   String                  @default("")
  emergencyContact          String                  @default("")
  createdAt                 DateTime                @default(now())
  updatedAt                 DateTime                @updatedAt
  lastSeenAt                DateTime?
  permissions               String                  @default("[]")
  accessibleProjectIds      String                  @default("[]")
  auditLogs                 AuditLog[]              @relation("AuditActor")
  birthday                  Birthday?               @relation("Birthdays")
  calendarNotes             CalendarNote[]
  ownedClients              Client[]                @relation("ClientOwner")
  departmentNotesAssigned   DepartmentNotes[]       @relation("DepartmentNotesAssignee")
  feedback                  Feedback[]              @relation("UserFeedback")
  feedbackReplies           FeedbackReply[]         @relation("FeedbackReplyAuthor")
  approvedLeaveApplications LeaveApplication[]      @relation("ApprovedLeaveApplications")
  rejectedLeaveApplications LeaveApplication[]      @relation("RejectedLeaveApplications")
  leaveApplications         LeaveApplication[]      @relation("LeaveApplications")
  leaveApprovers            LeaveApprover[]         @relation("LeaveApprovers")
  leaveBalances             LeaveBalance[]          @relation("LeaveBalances")
  actionItemsAssigned       MeetingActionItem[]     @relation("ActionItemAssignee")
  meetingComments           MeetingComment[]        @relation("MeetingCommentAuthor")
  meetingAllocations        MeetingUserAllocation[] @relation("MeetingUserAllocations")
  memberships               Membership[]
  sentMessages              Message[]               @relation("MessageSender")
  notifications             Notification[]          @relation("NotificationRecipient")
  notificationSettings      NotificationSetting?
  passwordHistory           PasswordHistory[]
  passwordResets            PasswordReset[]
  ownedProjects             Project[]               @relation("ProjectOwner")
  securityEvents            SecurityEvent[]
  serviceFormTemplates      ServiceFormTemplate[]
  sessions                  Session[]
  starredClients            StarredClient[]
  starredOpportunities      StarredOpportunity[]
  tasks                     Task[]                  @relation("TaskAssignee")
  twoFactor                 TwoFactor?
  userTasks                 UserTask[]              @relation("UserTaskOwner")
  userTaskTags              UserTaskTag[]           @relation("UserTaskTagOwner")
}

model Team {
  id          String       @id @default(cuid())
  name        String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  memberships Membership[]
}

model Membership {
  userId String
  teamId String
  role   String @default("user")
  team   Team   @relation(fields: [teamId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@id([userId, teamId])
}

model Client {
  id            String          @id @default(cuid())
  name          String
  type          String
  industry      String          @default("Other")
  status        String          @default("Potential")
  stage         String          @default("Awareness")
  revenue       Float           @default(0)
  value         Float           @default(0)
  probability   Int             @default(0)
  lastContact   DateTime        @default(now())
  address       String          @default("")
  website       String          @default("")
  notes         String          @default("")
  contacts      String          @default("[]")
  followUps     String          @default("[]")
  projectIds    String          @default("[]")
  comments      String          @default("[]")
  sites         String          @default("[]")
  contracts     String          @default("[]")
  activityLog   String          @default("[]")
  billingTerms  String          @default("{\"paymentTerms\":\"Net 30\",\"billingFrequency\":\"Monthly\",\"currency\":\"ZAR\",\"retainerAmount\":0,\"taxExempt\":false,\"notes\":\"\"}")
  ownerId       String?
  externalAgentId String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  proposals     String          @default("[]")
  thumbnail     String          @default("")
  services      String          @default("[]")
  rssSubscribed Boolean         @default(true)
  owner         User?           @relation("ClientOwner", fields: [ownerId], references: [id])
  externalAgent ExternalAgent?  @relation(fields: [externalAgentId], references: [id])
  newsArticles  ClientNews[]
  invoices      Invoice[]
  opportunities Opportunity[]
  projects      Project[]
  salesOrders   SalesOrder[]
  starredBy     StarredClient[]
  
  // Company Group fields (Hybrid: Primary parent + multiple group memberships)
  parentGroupId       String?
  parentGroup         Client?                @relation("PrimaryParent", fields: [parentGroupId], references: [id])
  childCompanies      Client[]               @relation("PrimaryParent")
  groupMemberships    ClientCompanyGroup[]   @relation("ClientGroups")
  groupChildren       ClientCompanyGroup[]   @relation("GroupMembers")

  @@index([createdAt])
  @@index([type])
  @@index([status])
  @@index([ownerId])
  @@index([externalAgentId])
  @@index([parentGroupId])
}

model ClientCompanyGroup {
  id        String   @id @default(cuid())
  clientId  String
  groupId   String
  role      String?  @default("member")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  client    Client   @relation("ClientGroups", fields: [clientId], references: [id], onDelete: Cascade)
  group     Client   @relation("GroupMembers", fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([clientId, groupId])
  @@index([clientId])
  @@index([groupId])
}

model Industry {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([isActive])
}

model ExternalAgent {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clients   Client[]

  @@index([name])
  @@index([isActive])
}

model Project {
  id                           String      @id @default(cuid())
  clientId                     String?
  name                         String
  description                  String      @default("")
  clientName                   String      @default("")
  status                       String      @default("Planning")
  startDate                    DateTime    @default(now())
  dueDate                      DateTime?
  budget                       Float       @default(0)
  actualCost                   Float       @default(0)
  progress                     Int         @default(0)
  priority                     String      @default("Medium")
  type                         String      @default("Project")
  assignedTo                   String      @default("")
  tasksList                    String      @default("[]")
  taskLists                    String      @default("[]")
  customFieldDefinitions       String      @default("[]")
  documents                    String      @default("[]")
  comments                     String      @default("[]")
  activityLog                  String      @default("[]")
  team                         String      @default("[]")
  notes                        String      @default("")
  hasDocumentCollectionProcess Boolean     @default(false)
  documentSections             String      @default("[]")
  ownerId                      String?
  createdAt                    DateTime    @default(now())
  updatedAt                    DateTime    @updatedAt
  monthlyProgress              String      @default("{}")
  invoices                     Invoice[]
  client                       Client?     @relation(fields: [clientId], references: [id])
  owner                        User?       @relation("ProjectOwner", fields: [ownerId], references: [id])
  tasks                        Task[]
  timeEntries                  TimeEntry[]

  @@index([clientId])
  @@index([status])
  @@index([ownerId])
  @@index([createdAt])
}

model Opportunity {
  id        String               @id @default(cuid())
  clientId  String
  title     String
  stage     String               @default("Awareness")
  value     Float                @default(0)
  ownerId   String?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  proposals String               @default("[]")
  status    String               @default("Potential")
  client    Client               @relation(fields: [clientId], references: [id])
  starredBy StarredOpportunity[]
}

model SalesOrder {
  id              String    @id @default(cuid())
  orderNumber     String    @unique
  clientId        String?
  clientName      String    @default("")
  opportunityId   String?
  status          String    @default("draft")
  priority        String    @default("normal")
  orderDate       DateTime  @default(now())
  requiredDate    DateTime?
  shippedDate     DateTime?
  subtotal        Float     @default(0)
  tax             Float     @default(0)
  total           Float     @default(0)
  items           String    @default("[]")
  shippingAddress String    @default("")
  shippingMethod  String    @default("")
  notes           String    @default("")
  internalNotes   String    @default("")
  ownerId         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  client          Client?   @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@index([status])
  @@index([ownerId])
  @@index([opportunityId])
}

model Invoice {
  id            String    @id @default(cuid())
  clientId      String?
  projectId     String?
  invoiceNumber String    @unique
  clientName    String    @default("")
  issueDate     DateTime  @default(now())
  dueDate       DateTime?
  status        String    @default("Draft")
  subtotal      Float     @default(0)
  tax           Float     @default(0)
  total         Float     @default(0)
  balance       Float     @default(0)
  items         String    @default("[]")
  notes         String    @default("")
  ownerId       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  client        Client?   @relation(fields: [clientId], references: [id])
  project       Project?  @relation(fields: [projectId], references: [id])
}

model Task {
  id           String    @id @default(cuid())
  projectId    String
  parentTaskId String?
  title        String
  status       String    @default("todo")
  assigneeId   String?
  dueDate      DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  assignee     User?     @relation("TaskAssignee", fields: [assigneeId], references: [id])
  parentTask   Task?     @relation("Subtasks", fields: [parentTaskId], references: [id])
  subtasks     Task[]    @relation("Subtasks")
  project      Project   @relation(fields: [projectId], references: [id])
}

model TimeEntry {
  id          String   @id @default(cuid())
  projectId   String?
  date        DateTime @default(now())
  hours       Float
  projectName String   @default("")
  task        String   @default("")
  description String   @default("")
  employee    String   @default("")
  billable    Boolean  @default(true)
  rate        Float    @default(0)
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  project     Project? @relation(fields: [projectId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String
  action    String
  entity    String
  entityId  String
  diff      String?
  createdAt DateTime @default(now())
  actor     User     @relation("AuditActor", fields: [actorId], references: [id])
}

model Invitation {
  id                   String    @id @default(cuid())
  email                String    @unique
  name                 String
  role                 String    @default("user")
  token                String    @unique
  status               String    @default("pending")
  invitedBy            String?
  expiresAt            DateTime
  acceptedAt           DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  accessibleProjectIds String    @default("[]")
}

model Feedback {
  id        String          @id @default(cuid())
  userId    String?
  pageUrl   String
  section   String          @default("")
  message   String
  type      String          @default("feedback")
  severity  String          @default("medium")
  meta      String?
  createdAt DateTime        @default(now())
  user      User?           @relation("UserFeedback", fields: [userId], references: [id])
  replies   FeedbackReply[]

  @@index([pageUrl])
  @@index([section])
  @@index([userId])
  @@index([createdAt])
}

model FeedbackReply {
  id         String   @id @default(cuid())
  feedbackId String
  userId     String?
  message    String
  createdAt  DateTime @default(now())
  feedback   Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  user       User?    @relation("FeedbackReplyAuthor", fields: [userId], references: [id])

  @@index([feedbackId])
  @@index([userId])
  @@index([createdAt])
}

model TeamDocument {
  id          String   @id @default(cuid())
  team        String
  title       String
  category    String   @default("General")
  description String   @default("")
  content     String   @default("")
  version     String   @default("1.0")
  status      String   @default("Draft")
  tags        String   @default("[]")
  attachments String   @default("[]")
  createdBy   String   @default("")
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TeamWorkflow {
  id          String   @id @default(cuid())
  team        String
  title       String
  description String   @default("")
  status      String   @default("Draft")
  steps       String   @default("[]")
  tags        String   @default("[]")
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TeamChecklist {
  id          String   @id @default(cuid())
  team        String
  title       String
  description String   @default("")
  category    String   @default("General")
  frequency   String   @default("One-time")
  items       String   @default("[]")
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TeamNotice {
  id        String   @id @default(cuid())
  team      String
  title     String
  content   String
  priority  String   @default("Normal")
  author    String   @default("")
  date      DateTime @default(now())
  ownerId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkflowExecution {
  id             String   @id @default(cuid())
  workflowId     String
  workflowTitle  String
  team           String
  completedSteps String   @default("[]")
  notes          String   @default("")
  executedBy     String   @default("")
  executionDate  DateTime @default(now())
  status         String   @default("Completed")
  ownerId        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model TeamTask {
  id          String    @id @default(cuid())
  team        String
  title       String
  description String    @default("")
  status      String    @default("todo")
  priority    String    @default("Medium")
  assigneeId  String?
  dueDate     DateTime?
  tags        String    @default("[]")
  attachments String    @default("[]")
  ownerId     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model InventoryItem {
  id                      String         @id @default(cuid())
  sku                     String
  name                    String
  category                String         @default("components")
  type                    String         @default("component")
  quantity                Float          @default(0)
  unit                    String         @default("pcs")
  reorderPoint            Float          @default(0)
  reorderQty              Float          @default(0)
  location                String         @default("")
  unitCost                Float          @default(0)
  totalValue              Float          @default(0)
  supplier                String         @default("")
  status                  String         @default("in_stock")
  lastRestocked           DateTime?
  ownerId                 String?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  thumbnail               String         @default("")
  legacyPartNumber        String         @default("")
  supplierPartNumbers     String         @default("[]")
  allocatedQuantity       Float          @default(0)
  completedQuantity       Float          @default(0)
  inProductionQuantity    Float          @default(0)
  locationId              String?
  manufacturingPartNumber String         @default("")
  boms                    BOM[]          @relation("BOMFinishedProduct")
  stockLocation           StockLocation? @relation(fields: [locationId], references: [id])

  @@index([sku])
  @@index([category])
  @@index([status])
  @@index([ownerId])
  @@index([locationId])
}

model BOM {
  id                String         @id @default(cuid())
  productSku        String
  productName       String
  version           String         @default("1.0")
  status            String         @default("active")
  effectiveDate     DateTime       @default(now())
  laborCost         Float          @default(0)
  overheadCost      Float          @default(0)
  totalMaterialCost Float          @default(0)
  totalCost         Float          @default(0)
  estimatedTime     Int            @default(0)
  components        String         @default("[]")
  notes             String         @default("")
  ownerId           String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  instructions      String         @default("")
  thumbnail         String         @default("")
  inventoryItemId   String?
  inventoryItem     InventoryItem? @relation("BOMFinishedProduct", fields: [inventoryItemId], references: [id])

  @@index([productSku])
  @@index([status])
  @@index([ownerId])
  @@index([inventoryItemId])
}

model ProductionOrder {
  id               String    @id @default(cuid())
  bomId            String    @default("")
  productSku       String
  productName      String
  quantity         Int       @default(0)
  quantityProduced Int       @default(0)
  status           String    @default("requested")
  priority         String    @default("normal")
  startDate        DateTime  @default(now())
  targetDate       DateTime?
  completedDate    DateTime?
  assignedTo       String    @default("")
  totalCost        Float     @default(0)
  notes            String    @default("")
  createdBy        String    @default("")
  ownerId          String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  workOrderNumber  String    @default("")
  allocationType   String    @default("stock")
  clientId         String?

  @@index([status])
  @@index([bomId])
  @@index([ownerId])
  @@index([clientId])
}

model StockMovement {
  id           String   @id @default(cuid())
  movementId   String
  date         DateTime @default(now())
  type         String
  itemName     String
  sku          String
  quantity     Float
  fromLocation String   @default("")
  toLocation   String   @default("")
  reference    String   @default("")
  performedBy  String   @default("")
  notes        String   @default("")
  ownerId      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([date])
  @@index([type])
  @@index([sku])
  @@index([ownerId])
}

model StockLocation {
  id             String              @id @default(cuid())
  code           String              @unique
  name           String
  type           String              @default("warehouse")
  status         String              @default("active")
  address        String              @default("")
  contactPerson  String              @default("")
  contactPhone   String              @default("")
  meta           String              @default("{}")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  inventoryItems InventoryItem[]
  inventory      LocationInventory[]

  @@index([type])
  @@index([status])
}

model LocationInventory {
  id            String        @id @default(cuid())
  locationId    String
  sku           String
  itemName      String
  quantity      Float         @default(0)
  unitCost      Float         @default(0)
  reorderPoint  Float         @default(0)
  lastRestocked DateTime?
  status        String        @default("in_stock")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  location      StockLocation @relation(fields: [locationId], references: [id])

  @@unique([locationId, sku])
  @@index([sku])
  @@index([locationId])
}

model Supplier {
  id             String          @id @default(cuid())
  code           String          @default("")
  name           String
  contactPerson  String          @default("")
  email          String          @default("")
  phone          String          @default("")
  website        String          @default("")
  address        String          @default("")
  paymentTerms   String          @default("Net 30")
  status         String          @default("active")
  notes          String          @default("")
  ownerId        String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  purchaseOrders PurchaseOrder[]

  @@index([name])
  @@index([status])
  @@index([ownerId])
}

model PurchaseOrder {
  id              String    @id @default(cuid())
  orderNumber     String    @unique
  supplierId      String
  supplierName    String    @default("")
  status          String    @default("draft")
  priority        String    @default("normal")
  orderDate       DateTime  @default(now())
  expectedDate    DateTime?
  receivedDate    DateTime?
  subtotal        Float     @default(0)
  tax             Float     @default(0)
  total           Float     @default(0)
  items           String    @default("[]")
  shippingAddress String    @default("")
  shippingMethod  String    @default("")
  notes           String    @default("")
  internalNotes   String    @default("")
  ownerId         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  supplier        Supplier  @relation(fields: [supplierId], references: [id])

  @@index([supplierId])
  @@index([status])
  @@index([ownerId])
}

model Message {
  id        String   @id @default(cuid())
  senderId  String
  content   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sender    User     @relation("MessageSender", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([createdAt])
  @@index([read])
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

model CalendarNote {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime
  note      String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  deviceInfo   String?
  ipAddress    String?
  userAgent    String?
  location     String?
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model TwoFactor {
  id          String   @id @default(cuid())
  userId      String   @unique
  secret      String
  backupCodes String
  enabled     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model SecurityEvent {
  id        String   @id @default(cuid())
  userId    String
  eventType String
  ipAddress String?
  userAgent String?
  details   String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
}

model PasswordHistory {
  id           String   @id @default(cuid())
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

model Vehicle {
  id          String    @id @default(cuid())
  name        String
  model       String    @default("")
  type        String    @default("")
  reg         String    @unique
  assetNumber String    @default("")
  status      String    @default("active")
  notes       String    @default("")
  ownerId     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  jobCards    JobCard[]

  @@index([status])
  @@index([ownerId])
  @@index([reg])
}

model JobCard {
  id                  String                @id @default(cuid())
  jobCardNumber       String                @unique
  agentName           String                @default("")
  otherTechnicians    String                @default("[]")
  clientId            String?
  clientName          String                @default("")
  siteId              String                @default("")
  siteName            String                @default("")
  location            String                @default("")
  timeOfDeparture     DateTime?
  timeOfArrival       DateTime?
  vehicleUsed         String                @default("")
  kmReadingBefore     Float                 @default(0)
  kmReadingAfter      Float                 @default(0)
  travelKilometers    Float                 @default(0)
  reasonForVisit      String                @default("")
  diagnosis           String                @default("")
  otherComments       String                @default("")
  photos              String                @default("[]")
  status              String                @default("draft")
  submittedAt         DateTime?
  completedAt         DateTime?
  ownerId             String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  actionsTaken        String                @default("")
  materialsBought     String                @default("[]")
  stockUsed           String                @default("[]")
  totalMaterialsCost  Float                 @default(0)
  arrivalBackAtOffice DateTime?
  departureFromSite   DateTime?
  locationLatitude    String                @default("")
  locationLongitude   String                @default("")
  totalTimeMinutes    Int                   @default(0)
  vehicleId           String?
  vehicle             Vehicle?              @relation(fields: [vehicleId], references: [id])
  serviceForms        ServiceFormInstance[]

  @@index([clientId])
  @@index([ownerId])
  @@index([status])
  @@index([createdAt])
  @@index([vehicleId])
}

model ServiceFormTemplate {
  id          String                @id @default(cuid())
  name        String
  description String                @default("")
  category    String                @default("General")
  isActive    Boolean               @default(true)
  version     Int                   @default(1)
  fields      String                @default("[]")
  createdById String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  instances   ServiceFormInstance[]
  createdBy   User?                 @relation(fields: [createdById], references: [id])

  @@index([category])
  @@index([isActive])
  @@index([createdById])
}

model ServiceFormInstance {
  id              String              @id @default(cuid())
  jobCardId       String
  templateId      String
  templateName    String              @default("")
  templateVersion Int                 @default(1)
  status          String              @default("not_started")
  answers         String              @default("[]")
  completedAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  jobCard         JobCard             @relation(fields: [jobCardId], references: [id], onDelete: Cascade)
  template        ServiceFormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([jobCardId])
  @@index([templateId])
  @@index([status])
  @@index([createdAt])
}

model ClientNews {
  id          String   @id @default(cuid())
  clientId    String
  title       String
  description String   @default("")
  url         String   @default("")
  source      String   @default("Unknown")
  publishedAt DateTime @default(now())
  isNew       Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([publishedAt])
  @@index([isNew])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  link      String   @default("")
  read      Boolean  @default(false)
  metadata  String   @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([type])
}

model NotificationSetting {
  id            String   @id @default(cuid())
  userId        String   @unique
  emailMentions Boolean  @default(true)
  emailComments Boolean  @default(true)
  emailTasks    Boolean  @default(true)
  emailInvoices Boolean  @default(true)
  emailSystem   Boolean  @default(true)
  inAppMentions Boolean  @default(true)
  inAppComments Boolean  @default(true)
  inAppTasks    Boolean  @default(true)
  inAppInvoices Boolean  @default(true)
  inAppSystem   Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model StarredClient {
  id        String   @id @default(cuid())
  userId    String
  clientId  String
  createdAt DateTime @default(now())
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId])
  @@index([userId])
  @@index([clientId])
}

model StarredOpportunity {
  id            String      @id @default(cuid())
  userId        String
  opportunityId String
  createdAt     DateTime    @default(now())
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, opportunityId])
  @@index([userId])
  @@index([opportunityId])
}

model SystemSettings {
  id                    String   @id @default("system")
  companyName           String   @default("Abcotronics")
  timezone              String   @default("Africa/Johannesburg")
  currency              String   @default("ZAR")
  dateFormat            String   @default("DD/MM/YYYY")
  language              String   @default("en")
  sessionTimeout        Int      @default(30)
  requirePasswordChange Boolean  @default(false)
  twoFactorAuth         Boolean  @default(false)
  auditLogging          Boolean  @default(true)
  emailProvider         String   @default("gmail")
  googleCalendar        Boolean  @default(false)
  quickbooks            Boolean  @default(false)
  slack                 Boolean  @default(false)
  updatedBy             String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([updatedBy])
}

model LeaveApplication {
  id              String    @id @default(cuid())
  userId          String
  leaveType       String
  startDate       DateTime
  endDate         DateTime
  days            Int
  reason          String
  emergency       Boolean   @default(false)
  status          String    @default("pending")
  appliedDate     DateTime  @default(now())
  approvedDate    DateTime?
  rejectedDate    DateTime?
  approvedById    String?
  rejectedById    String?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  approvedBy      User?     @relation("ApprovedLeaveApplications", fields: [approvedById], references: [id])
  rejectedBy      User?     @relation("RejectedLeaveApplications", fields: [rejectedById], references: [id])
  user            User      @relation("LeaveApplications", fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([approvedById])
}

model LeaveBalance {
  id        String   @id @default(cuid())
  userId    String
  leaveType String
  available Float    @default(0)
  used      Float    @default(0)
  balance   Float    @default(0)
  year      Int
  notes     String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("LeaveBalances", fields: [userId], references: [id])

  @@unique([userId, leaveType, year])
  @@index([userId])
  @@index([leaveType])
  @@index([year])
}

model LeaveApprover {
  id         String   @id @default(cuid())
  department String
  approverId String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  approver   User     @relation("LeaveApprovers", fields: [approverId], references: [id])

  @@unique([department, approverId])
  @@index([department])
  @@index([approverId])
}

model Birthday {
  id        String   @id @default(cuid())
  userId    String   @unique
  date      DateTime
  notes     String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("Birthdays", fields: [userId], references: [id])

  @@index([userId])
  @@index([date])
}

model MonthlyMeetingNotes {
  id              String                  @id @default(cuid())
  monthKey        String                  @unique
  monthlyGoals    String                  @default("")
  status          String                  @default("active")
  ownerId         String?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  actionItems     MeetingActionItem[]
  comments        MeetingComment[]
  userAllocations MeetingUserAllocation[]
  weeklyNotes     WeeklyMeetingNotes[]

  @@index([monthKey])
  @@index([status])
  @@index([ownerId])
}

model WeeklyMeetingNotes {
  id              String              @id @default(cuid())
  monthlyNotesId  String
  weekKey         String
  weekStart       DateTime
  weekEnd         DateTime?
  ownerId         String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  departmentNotes DepartmentNotes[]
  actionItems     MeetingActionItem[]
  monthlyNotes    MonthlyMeetingNotes @relation(fields: [monthlyNotesId], references: [id], onDelete: Cascade)

  @@unique([monthlyNotesId, weekKey])
  @@index([monthlyNotesId])
  @@index([weekKey])
  @@index([ownerId])
}

model DepartmentNotes {
  id             String              @id @default(cuid())
  weeklyNotesId  String
  departmentId   String
  successes      String              @default("")
  weekToFollow   String              @default("")
  frustrations   String              @default("")
  agendaPoints   String              @default("[]")
  attachments    String              @default("[]")  // JSON array of attachment objects
  assignedUserId String?
  ownerId        String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  assignedUser   User?               @relation("DepartmentNotesAssignee", fields: [assignedUserId], references: [id])
  weeklyNotes    WeeklyMeetingNotes  @relation(fields: [weeklyNotesId], references: [id], onDelete: Cascade)
  actionItems    MeetingActionItem[]
  comments       MeetingComment[]

  @@unique([weeklyNotesId, departmentId])
  @@index([weeklyNotesId])
  @@index([departmentId])
  @@index([assignedUserId])
}

model MeetingActionItem {
  id                String               @id @default(cuid())
  monthlyNotesId    String?
  weeklyNotesId     String?
  departmentNotesId String?
  title             String
  description       String               @default("")
  status            String               @default("open")
  priority          String               @default("medium")
  assignedUserId    String?
  dueDate           DateTime?
  completedDate     DateTime?
  ownerId           String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  assignedUser      User?                @relation("ActionItemAssignee", fields: [assignedUserId], references: [id])
  departmentNotes   DepartmentNotes?     @relation(fields: [departmentNotesId], references: [id], onDelete: Cascade)
  monthlyNotes      MonthlyMeetingNotes? @relation(fields: [monthlyNotesId], references: [id], onDelete: Cascade)
  weeklyNotes       WeeklyMeetingNotes?  @relation(fields: [weeklyNotesId], references: [id], onDelete: Cascade)
  comments          MeetingComment[]

  @@index([monthlyNotesId])
  @@index([weeklyNotesId])
  @@index([departmentNotesId])
  @@index([assignedUserId])
  @@index([status])
  @@index([dueDate])
}

model MeetingComment {
  id                String               @id @default(cuid())
  monthlyNotesId    String?
  departmentNotesId String?
  actionItemId      String?
  content           String
  authorId          String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  actionItem        MeetingActionItem?   @relation(fields: [actionItemId], references: [id], onDelete: Cascade)
  author            User                 @relation("MeetingCommentAuthor", fields: [authorId], references: [id])
  departmentNotes   DepartmentNotes?     @relation(fields: [departmentNotesId], references: [id], onDelete: Cascade)
  monthlyNotes      MonthlyMeetingNotes? @relation(fields: [monthlyNotesId], references: [id], onDelete: Cascade)

  @@index([monthlyNotesId])
  @@index([departmentNotesId])
  @@index([actionItemId])
  @@index([authorId])
  @@index([createdAt])
}

model MeetingUserAllocation {
  id             String              @id @default(cuid())
  monthlyNotesId String
  departmentId   String
  userId         String
  role           String              @default("contributor")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  monthlyNotes   MonthlyMeetingNotes @relation(fields: [monthlyNotesId], references: [id], onDelete: Cascade)
  user           User                @relation("MeetingUserAllocations", fields: [userId], references: [id])

  @@unique([monthlyNotesId, departmentId, userId])
  @@index([monthlyNotesId])
  @@index([departmentId])
  @@index([userId])
}

model UserTask {
  id             String                @id @default(cuid())
  title          String
  description    String                @default("")
  status         String                @default("todo")
  priority       String                @default("medium")
  category       String                @default("")
  dueDate        DateTime?
  completedDate  DateTime?
  ownerId        String
  clientId       String?
  projectId      String?
  checklist      String                @default("[]")
  photos         String                @default("[]")
  files          String                @default("[]")
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  googleEventId  String?
  googleEventUrl String?
  owner          User                  @relation("UserTaskOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  tags           UserTaskTagRelation[]

  @@index([ownerId])
  @@index([status])
  @@index([category])
  @@index([dueDate])
  @@index([clientId])
  @@index([projectId])
  @@index([createdAt])
}

model UserTaskTag {
  id        String                @id @default(cuid())
  name      String
  color     String                @default("#3B82F6")
  ownerId   String
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  owner     User                  @relation("UserTaskTagOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  tasks     UserTaskTagRelation[]

  @@unique([ownerId, name])
  @@index([ownerId])
  @@index([name])
}

model UserTaskTagRelation {
  id        String      @id @default(cuid())
  taskId    String
  tagId     String
  createdAt DateTime    @default(now())
  tag       UserTaskTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  task      UserTask    @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
  @@index([taskId])
  @@index([tagId])
}

model DocumentCollectionTemplate {
  id          String   @id @default(cuid())
  name        String
  description String   @default("")
  sections    String   @default("[]")
  isDefault   Boolean  @default(false)
  ownerId     String?
  createdBy   String   @default("")
  updatedBy   String   @default("")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isDefault])
  @@index([ownerId])
  @@index([createdAt])
}
