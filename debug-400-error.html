<!DOCTYPE html>
<html>
<head>
    <title>Debug 400 Error</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Debug 400 Error on /clients</h1>
    
    <div class="test info">
        <h3>Testing different request formats to identify the 400 error cause</h3>
    </div>
    
    <div id="results"></div>
    
    <button onclick="testClientsAPI()">Test Clients API</button>
    <button onclick="testWithFreshToken()">Test with Fresh Token</button>
    <button onclick="testDifferentMethods()">Test Different Methods</button>
    
    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
        }
        
        async function testClientsAPI() {
            addResult('Testing basic clients API call...', 'info');
            
            try {
                // Test without token first
                const response1 = await fetch('http://localhost:3000/api/clients');
                addResult(`No token: ${response1.status} ${response1.statusText}`, response1.ok ? 'success' : 'error');
                
                // Test with fresh token
                const loginResponse = await fetch('http://localhost:3000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@abcotronics.com',
                        password: 'admin123'
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error(`Login failed: ${loginResponse.status}`);
                }
                
                const loginData = await loginResponse.json();
                const token = loginData.data.accessToken;
                addResult(`Fresh token: ${token.substring(0, 20)}...`, 'success');
                
                // Test with fresh token
                const response2 = await fetch('http://localhost:3000/api/clients', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response2.ok) {
                    const data = await response2.json();
                    addResult(`With token: ${response2.status} - ${JSON.stringify(data).length} chars`, 'success');
                } else {
                    addResult(`With token: ${response2.status} ${response2.statusText}`, 'error');
                }
                
            } catch (error) {
                addResult(`Error: ${error.message}`, 'error');
            }
        }
        
        async function testWithFreshToken() {
            addResult('Testing with fresh token and detailed logging...', 'info');
            
            try {
                // Get fresh token
                const loginResponse = await fetch('http://localhost:3000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@abcotronics.com',
                        password: 'admin123'
                    })
                });
                
                const loginData = await loginResponse.json();
                const token = loginData.data.accessToken;
                
                // Decode token to check expiration
                const payload = JSON.parse(atob(token.split('.')[1]));
                const now = Math.floor(Date.now() / 1000);
                const expiresIn = payload.exp - now;
                
                addResult(`Token expires in: ${expiresIn} seconds`, expiresIn > 60 ? 'success' : 'error');
                
                // Test multiple requests
                for (let i = 0; i < 3; i++) {
                    const response = await fetch('http://localhost:3000/api/clients', {
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    addResult(`Request ${i + 1}: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        addResult(`Error details: ${errorText}`, 'error');
                    }
                    
                    // Small delay between requests
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
            } catch (error) {
                addResult(`Error: ${error.message}`, 'error');
            }
        }
        
        async function testDifferentMethods() {
            addResult('Testing different HTTP methods...', 'info');
            
            try {
                // Get fresh token
                const loginResponse = await fetch('http://localhost:3000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@abcotronics.com',
                        password: 'admin123'
                    })
                });
                
                const loginData = await loginResponse.json();
                const token = loginData.data.accessToken;
                
                // Test GET
                const getResponse = await fetch('http://localhost:3000/api/clients', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                addResult(`GET: ${getResponse.status} ${getResponse.statusText}`, getResponse.ok ? 'success' : 'error');
                
                // Test POST with empty body
                const postResponse = await fetch('http://localhost:3000/api/clients', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                addResult(`POST empty: ${postResponse.status} ${postResponse.statusText}`, postResponse.ok ? 'success' : 'error');
                
                // Test POST with valid data
                const postValidResponse = await fetch('http://localhost:3000/api/clients', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: 'Test Client',
                        type: 'client',
                        industry: 'Technology'
                    })
                });
                addResult(`POST valid: ${postValidResponse.status} ${postValidResponse.statusText}`, postValidResponse.ok ? 'success' : 'error');
                
            } catch (error) {
                addResult(`Error: ${error.message}`, 'error');
            }
        }
        
        // Auto-run test on page load
        window.addEventListener('load', () => {
            addResult('Page loaded. Click buttons to test different scenarios.', 'info');
        });
    </script>
</body>
</html>
