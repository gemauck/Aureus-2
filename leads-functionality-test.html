<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leads Functionality Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Load required utilities -->
    <script src="src/utils/localStorage.js"></script>
    <script src="src/utils/databaseAPI.js"></script>
    
    <!-- Load the Clients component -->
    <script src="src/components/clients/Clients.jsx" type="text/babel"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const LeadsTestApp = () => {
            const [testResults, setTestResults] = useState([]);
            const [isRunning, setIsRunning] = useState(false);

            const addTestResult = (test, status, message) => {
                setTestResults(prev => [...prev, { test, status, message, timestamp: new Date().toISOString() }]);
            };

            const runTests = async () => {
                setIsRunning(true);
                setTestResults([]);
                
                addTestResult('Test Setup', 'info', 'Starting leads functionality tests...');

                // Test 1: Check if API methods are available
                try {
                    if (window.api?.getLeads && window.api?.createLead && window.api?.updateLead && window.api?.deleteLead) {
                        addTestResult('API Methods', 'success', 'All lead API methods are available');
                    } else {
                        addTestResult('API Methods', 'error', 'Missing lead API methods');
                        return;
                    }
                } catch (error) {
                    addTestResult('API Methods', 'error', `Error checking API methods: ${error.message}`);
                    return;
                }

                // Test 2: Check if storage methods are available
                try {
                    if (window.storage?.getLeads && window.storage?.setLeads) {
                        addTestResult('Storage Methods', 'success', 'Lead storage methods are available');
                    } else {
                        addTestResult('Storage Methods', 'error', 'Missing lead storage methods');
                    }
                } catch (error) {
                    addTestResult('Storage Methods', 'error', `Error checking storage methods: ${error.message}`);
                }

                // Test 3: Test localStorage operations
                try {
                    const testLead = {
                        id: 'test-lead-1',
                        name: 'Test Lead',
                        industry: 'Technology',
                        status: 'New',
                        type: 'lead',
                        notes: 'Test lead for functionality testing'
                    };

                    // Save test lead
                    const currentLeads = window.storage?.getLeads?.() || [];
                    const updatedLeads = [...currentLeads, testLead];
                    window.storage?.setLeads?.(updatedLeads);

                    // Retrieve test lead
                    const retrievedLeads = window.storage?.getLeads?.();
                    const foundLead = retrievedLeads?.find(l => l.id === 'test-lead-1');

                    if (foundLead && foundLead.name === 'Test Lead') {
                        addTestResult('LocalStorage Save/Retrieve', 'success', 'Lead saved and retrieved successfully from localStorage');
                    } else {
                        addTestResult('LocalStorage Save/Retrieve', 'error', 'Failed to save or retrieve lead from localStorage');
                    }

                    // Clean up test lead
                    const cleanedLeads = retrievedLeads?.filter(l => l.id !== 'test-lead-1') || [];
                    window.storage?.setLeads?.(cleanedLeads);

                } catch (error) {
                    addTestResult('LocalStorage Operations', 'error', `Error in localStorage operations: ${error.message}`);
                }

                // Test 4: Test API operations (if token available)
                try {
                    const token = window.storage?.getToken?.();
                    if (token) {
                        addTestResult('Authentication', 'success', 'User is authenticated, testing API operations...');

                        // Test getting leads from API
                        try {
                            const apiLeads = await window.api.getLeads();
                            addTestResult('API Get Leads', 'success', `Retrieved ${apiLeads?.length || 0} leads from API`);
                        } catch (error) {
                            addTestResult('API Get Leads', 'error', `Failed to get leads from API: ${error.message}`);
                        }

                        // Test creating a lead via API
                        try {
                            const newLead = {
                                name: 'API Test Lead',
                                industry: 'Technology',
                                status: 'New',
                                type: 'lead',
                                notes: 'Test lead created via API'
                            };

                            const createdLead = await window.api.createLead(newLead);
                            if (createdLead && createdLead.id) {
                                addTestResult('API Create Lead', 'success', `Lead created successfully with ID: ${createdLead.id}`);

                                // Test updating the lead
                                try {
                                    const updatedLead = { ...createdLead, notes: 'Updated test lead' };
                                    const result = await window.api.updateLead(createdLead.id, updatedLead);
                                    addTestResult('API Update Lead', 'success', 'Lead updated successfully');

                                    // Test deleting the lead
                                    try {
                                        await window.api.deleteLead(createdLead.id);
                                        addTestResult('API Delete Lead', 'success', 'Lead deleted successfully');
                                    } catch (error) {
                                        addTestResult('API Delete Lead', 'error', `Failed to delete lead: ${error.message}`);
                                    }
                                } catch (error) {
                                    addTestResult('API Update Lead', 'error', `Failed to update lead: ${error.message}`);
                                }
                            } else {
                                addTestResult('API Create Lead', 'error', 'Failed to create lead via API');
                            }
                        } catch (error) {
                            addTestResult('API Create Lead', 'error', `Failed to create lead: ${error.message}`);
                        }
                    } else {
                        addTestResult('Authentication', 'warning', 'No authentication token found, skipping API tests');
                    }
                } catch (error) {
                    addTestResult('API Operations', 'error', `Error in API operations: ${error.message}`);
                }

                addTestResult('Test Complete', 'info', 'All tests completed');
                setIsRunning(false);
            };

            return (
                <div className="min-h-screen bg-gray-100 p-6">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h1 className="text-3xl font-bold text-gray-900 mb-6">
                                <i className="fas fa-vial text-blue-500 mr-3"></i>
                                Leads Functionality Test
                            </h1>

                            <div className="mb-6">
                                <button
                                    onClick={runTests}
                                    disabled={isRunning}
                                    className={`px-6 py-3 rounded-lg font-semibold ${
                                        isRunning
                                            ? 'bg-gray-400 text-gray-200 cursor-not-allowed'
                                            : 'bg-blue-500 text-white hover:bg-blue-600'
                                    }`}
                                >
                                    {isRunning ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin mr-2"></i>
                                            Running Tests...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-play mr-2"></i>
                                            Run Tests
                                        </>
                                    )}
                                </button>
                            </div>

                            <div className="space-y-4">
                                <h2 className="text-xl font-semibold text-gray-800 mb-4">Test Results</h2>
                                
                                {testResults.length === 0 ? (
                                    <div className="text-gray-500 text-center py-8">
                                        <i className="fas fa-info-circle text-4xl mb-4"></i>
                                        <p>Click "Run Tests" to test the leads functionality</p>
                                    </div>
                                ) : (
                                    testResults.map((result, index) => (
                                        <div
                                            key={index}
                                            className={`p-4 rounded-lg border-l-4 ${
                                                result.status === 'success'
                                                    ? 'bg-green-50 border-green-500'
                                                    : result.status === 'error'
                                                    ? 'bg-red-50 border-red-500'
                                                    : result.status === 'warning'
                                                    ? 'bg-yellow-50 border-yellow-500'
                                                    : 'bg-blue-50 border-blue-500'
                                            }`}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center">
                                                    <i
                                                        className={`fas mr-3 ${
                                                            result.status === 'success'
                                                                ? 'fa-check-circle text-green-500'
                                                                : result.status === 'error'
                                                                ? 'fa-times-circle text-red-500'
                                                                : result.status === 'warning'
                                                                ? 'fa-exclamation-triangle text-yellow-500'
                                                                : 'fa-info-circle text-blue-500'
                                                        }`}
                                                    ></i>
                                                    <span className="font-semibold text-gray-800">
                                                        {result.test}
                                                    </span>
                                                </div>
                                                <span className="text-sm text-gray-500">
                                                    {new Date(result.timestamp).toLocaleTimeString()}
                                                </span>
                                            </div>
                                            <p className="mt-2 text-gray-700 ml-8">{result.message}</p>
                                        </div>
                                    ))
                                )}
                            </div>

                            <div className="mt-8 p-4 bg-gray-50 rounded-lg">
                                <h3 className="font-semibold text-gray-800 mb-2">Test Summary</h3>
                                <div className="grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <div className="text-2xl font-bold text-green-600">
                                            {testResults.filter(r => r.status === 'success').length}
                                        </div>
                                        <div className="text-sm text-gray-600">Success</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-red-600">
                                            {testResults.filter(r => r.status === 'error').length}
                                        </div>
                                        <div className="text-sm text-gray-600">Errors</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-yellow-600">
                                            {testResults.filter(r => r.status === 'warning').length}
                                        </div>
                                        <div className="text-sm text-gray-600">Warnings</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<LeadsTestApp />, document.getElementById('root'));
    </script>
</body>
</html>
