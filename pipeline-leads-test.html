<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Leads Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">Pipeline Leads Integration Test</h1>
            
            <div class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h2 class="text-lg font-semibold text-blue-900 mb-2">Test Status</h2>
                    <div id="test-status" class="text-blue-700">Running tests...</div>
                </div>
                
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h2 class="text-lg font-semibold text-gray-900 mb-2">Test Results</h2>
                    <div id="test-results" class="text-gray-700">Loading...</div>
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h2 class="text-lg font-semibold text-green-900 mb-2">Pipeline Component</h2>
                    <div id="pipeline-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load dependencies -->
    <script src="src/utils/localStorage.js"></script>
    <script src="src/utils/databaseAPI.js"></script>
    <script src="src/components/clients/Pipeline.jsx"></script>
    
    <script>
        // Test configuration
        const TEST_CONFIG = {
            testLeads: [
                {
                    id: 'test-lead-1',
                    name: 'Test Lead 1',
                    type: 'lead',
                    stage: 'Awareness',
                    value: 50000,
                    industry: 'Mining',
                    contacts: [{ name: 'John Doe', email: 'john@test.com' }],
                    createdDate: new Date().toISOString()
                },
                {
                    id: 'test-lead-2',
                    name: 'Test Lead 2',
                    type: 'lead',
                    stage: 'Interest',
                    value: 75000,
                    industry: 'Forestry',
                    contacts: [{ name: 'Jane Smith', email: 'jane@test.com' }],
                    createdDate: new Date().toISOString()
                }
            ],
            testClients: [
                {
                    id: 'test-client-1',
                    name: 'Test Client 1',
                    type: 'client',
                    opportunities: [
                        {
                            id: 'test-opp-1',
                            name: 'Expansion Opportunity',
                            stage: 'Desire',
                            value: 100000,
                            createdDate: new Date().toISOString()
                        }
                    ]
                }
            ]
        };

        // Test functions
        async function runTests() {
            const statusDiv = document.getElementById('test-status');
            const resultsDiv = document.getElementById('test-results');
            
            try {
                statusDiv.innerHTML = 'üîÑ Running Pipeline Leads Integration Tests...';
                
                // Test 1: Check if Pipeline component exists
                if (typeof window.Pipeline === 'function') {
                    resultsDiv.innerHTML += '‚úÖ Pipeline component loaded successfully<br>';
                } else {
                    resultsDiv.innerHTML += '‚ùå Pipeline component not found<br>';
                    return;
                }
                
                // Test 2: Check if storage utilities exist
                if (window.storage && typeof window.storage.setLeads === 'function') {
                    resultsDiv.innerHTML += '‚úÖ Storage utilities available<br>';
                } else {
                    resultsDiv.innerHTML += '‚ùå Storage utilities not available<br>';
                    return;
                }
                
                // Test 3: Set up test data
                window.storage.setLeads(TEST_CONFIG.testLeads);
                window.storage.setClients(TEST_CONFIG.testClients);
                resultsDiv.innerHTML += '‚úÖ Test data loaded into storage<br>';
                
                // Test 4: Initialize Pipeline component
                const pipelineContainer = document.getElementById('pipeline-container');
                const pipelineElement = document.createElement('div');
                pipelineContainer.appendChild(pipelineElement);
                
                // Create React root and render Pipeline
                if (window.React && window.ReactDOM) {
                    const root = window.ReactDOM.createRoot(pipelineElement);
                    root.render(window.React.createElement(window.Pipeline));
                    resultsDiv.innerHTML += '‚úÖ Pipeline component rendered<br>';
                } else {
                    // Fallback: Create a simple test display
                    pipelineElement.innerHTML = `
                        <div class="bg-white rounded-lg p-4 border">
                            <h3 class="font-semibold mb-2">Pipeline Test Data</h3>
                            <div class="space-y-2">
                                <div class="text-sm">
                                    <strong>Test Leads:</strong> ${TEST_CONFIG.testLeads.length}
                                    <ul class="ml-4 mt-1">
                                        ${TEST_CONFIG.testLeads.map(lead => 
                                            `<li>‚Ä¢ ${lead.name} (${lead.stage}) - R${lead.value.toLocaleString()}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                                <div class="text-sm">
                                    <strong>Test Opportunities:</strong> ${TEST_CONFIG.testClients.reduce((sum, client) => sum + (client.opportunities?.length || 0), 0)}
                                    <ul class="ml-4 mt-1">
                                        ${TEST_CONFIG.testClients.flatMap(client => 
                                            client.opportunities?.map(opp => 
                                                `<li>‚Ä¢ ${opp.name} (${opp.stage}) - R${opp.value.toLocaleString()}</li>`
                                            ) || []
                                        ).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                    resultsDiv.innerHTML += '‚úÖ Pipeline test data displayed<br>';
                }
                
                // Test 5: Verify data loading
                const loadedLeads = window.storage.getLeads();
                const loadedClients = window.storage.getClients();
                
                if (loadedLeads && loadedLeads.length === TEST_CONFIG.testLeads.length) {
                    resultsDiv.innerHTML += '‚úÖ Leads data loaded correctly<br>';
                } else {
                    resultsDiv.innerHTML += `‚ùå Leads data issue: Expected ${TEST_CONFIG.testLeads.length}, got ${loadedLeads?.length || 0}<br>`;
                }
                
                if (loadedClients && loadedClients.length === TEST_CONFIG.testClients.length) {
                    resultsDiv.innerHTML += '‚úÖ Clients data loaded correctly<br>';
                } else {
                    resultsDiv.innerHTML += `‚ùå Clients data issue: Expected ${TEST_CONFIG.testClients.length}, got ${loadedClients?.length || 0}<br>`;
                }
                
                statusDiv.innerHTML = '‚úÖ All tests completed successfully!';
                statusDiv.className = 'text-green-700';
                
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Test failed: ' + error.message;
                statusDiv.className = 'text-red-700';
                resultsDiv.innerHTML += `‚ùå Error: ${error.message}<br>`;
            }
        }
        
        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runTests, 1000); // Give time for scripts to load
        });
        
        // Debug functions
        window.debugPipeline = () => {
            console.log('üîç Pipeline Debug Info:');
            console.log('- Pipeline component:', typeof window.Pipeline);
            console.log('- Storage available:', !!window.storage);
            console.log('- Leads in storage:', window.storage?.getLeads?.()?.length || 0);
            console.log('- Clients in storage:', window.storage?.getClients?.()?.length || 0);
            console.log('- DatabaseAPI available:', !!window.DatabaseAPI);
        };
        
        window.clearTestData = () => {
            window.storage?.setLeads?.([]);
            window.storage?.setClients?.([]);
            console.log('üßπ Test data cleared');
        };
    </script>
</body>
</html>
