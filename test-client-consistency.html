<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Consistency Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Client Consistency Test</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Test Controls -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-play-circle text-blue-600 mr-2"></i>
                    Test Controls
                </h2>
                <div class="space-y-4">
                    <button 
                        onclick="runConsistencyTest()"
                        class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                    >
                        <i class="fas fa-play mr-2"></i>
                        Run Consistency Test
                    </button>
                    <button 
                        onclick="seedDatabase()"
                        class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                    >
                        <i class="fas fa-seedling mr-2"></i>
                        Seed Database
                    </button>
                    <button 
                        onclick="clearCache()"
                        class="w-full bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors"
                    >
                        <i class="fas fa-trash mr-2"></i>
                        Clear Cache
                    </button>
                    <button 
                        onclick="checkCurrentData()"
                        class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors"
                    >
                        <i class="fas fa-search mr-2"></i>
                        Check Current Data
                    </button>
                </div>
            </div>

            <!-- Test Results -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-clipboard-list text-green-600 mr-2"></i>
                    Test Results
                </h2>
                <div id="testResults" class="space-y-3">
                    <p class="text-gray-500 italic">No tests run yet. Click "Run Consistency Test" to begin.</p>
                </div>
            </div>
        </div>

        <!-- Current Data Display -->
        <div class="mt-8 bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-database text-purple-600 mr-2"></i>
                Current Data Status
            </h2>
            <div id="currentData" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-medium text-blue-900 mb-2">Clients</h3>
                    <div id="clientsData" class="text-sm text-blue-800">Loading...</div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h3 class="font-medium text-green-900 mb-2">Leads</h3>
                    <div id="leadsData" class="text-sm text-green-800">Loading...</div>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <h3 class="font-medium text-purple-900 mb-2">Database</h3>
                    <div id="databaseData" class="text-sm text-purple-800">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Expected vs Actual -->
        <div class="mt-8 bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-balance-scale text-orange-600 mr-2"></i>
                Expected vs Actual
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-3">Expected Results</h3>
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-check text-green-600"></i>
                            <span class="text-sm text-gray-700">RGN appears in Leads section</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-check text-green-600"></i>
                            <span class="text-sm text-gray-700">Exxaro appears in Clients section</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-check text-green-600"></i>
                            <span class="text-sm text-gray-700">Same data for all users</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-check text-green-600"></i>
                            <span class="text-sm text-gray-700">Dashboard shows consistent counts</span>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-3">Actual Results</h3>
                    <div id="actualResults" class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-question text-gray-400"></i>
                            <span class="text-sm text-gray-500">Run test to see results</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test functions
        async function runConsistencyTest() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Running consistency test...</div>';
            
            try {
                const results = [];
                
                // Test 1: Check if RGN exists as lead
                const rgnTest = await testRGNLead();
                results.push({
                    test: 'RGN Lead Check',
                    status: rgnTest.success ? 'pass' : 'fail',
                    message: rgnTest.message
                });
                
                // Test 2: Check if Exxaro exists as client
                const exxaroTest = await testExxaroClient();
                results.push({
                    test: 'Exxaro Client Check',
                    status: exxaroTest.success ? 'pass' : 'fail',
                    message: exxaroTest.message
                });
                
                // Test 3: Check data consistency
                const consistencyTest = await testDataConsistency();
                results.push({
                    test: 'Data Consistency',
                    status: consistencyTest.success ? 'pass' : 'fail',
                    message: consistencyTest.message
                });
                
                // Display results
                displayTestResults(results);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Test failed: ${error.message}</div>`;
            }
        }
        
        async function testRGNLead() {
            try {
                if (window.DatabaseAPI) {
                    const response = await window.DatabaseAPI.getClients();
                    const clients = response?.data?.clients || [];
                    const rgn = clients.find(c => c.name === 'RGN' && c.type === 'lead');
                    
                    if (rgn) {
                        return {
                            success: true,
                            message: `✅ RGN found as lead (ID: ${rgn.id})`
                        };
                    } else {
                        return {
                            success: false,
                            message: '❌ RGN not found as lead in database'
                        };
                    }
                } else {
                    return {
                        success: false,
                        message: '❌ DatabaseAPI not available'
                    };
                }
            } catch (error) {
                return {
                    success: false,
                    message: `❌ Error checking RGN: ${error.message}`
                };
            }
        }
        
        async function testExxaroClient() {
            try {
                if (window.DatabaseAPI) {
                    const response = await window.DatabaseAPI.getClients();
                    const clients = response?.data?.clients || [];
                    const exxaro = clients.find(c => c.name === 'Exxaro' && c.type === 'client');
                    
                    if (exxaro) {
                        return {
                            success: true,
                            message: `✅ Exxaro found as client (ID: ${exxaro.id})`
                        };
                    } else {
                        return {
                            success: false,
                            message: '❌ Exxaro not found as client in database'
                        };
                    }
                } else {
                    return {
                        success: false,
                        message: '❌ DatabaseAPI not available'
                    };
                }
            } catch (error) {
                return {
                    success: false,
                    message: `❌ Error checking Exxaro: ${error.message}`
                };
            }
        }
        
        async function testDataConsistency() {
            try {
                // Check localStorage consistency
                const clients = JSON.parse(localStorage.getItem('abcotronics_clients') || '[]');
                const leads = JSON.parse(localStorage.getItem('abcotronics_leads') || '[]');
                
                const rgnInLeads = leads.find(l => l.name === 'RGN');
                const exxaroInClients = clients.find(c => c.name === 'Exxaro');
                
                if (rgnInLeads && exxaroInClients) {
                    return {
                        success: true,
                        message: `✅ Data consistency verified (${clients.length} clients, ${leads.length} leads)`
                    };
                } else {
                    return {
                        success: false,
                        message: '❌ Data inconsistency detected in localStorage'
                    };
                }
            } catch (error) {
                return {
                    success: false,
                    message: `❌ Error checking consistency: ${error.message}`
                };
            }
        }
        
        function displayTestResults(results) {
            const resultsDiv = document.getElementById('testResults');
            const actualResultsDiv = document.getElementById('actualResults');
            
            let html = '';
            let actualHtml = '';
            
            results.forEach(result => {
                const icon = result.status === 'pass' ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-600';
                html += `
                    <div class="flex items-center space-x-2 p-2 rounded ${result.status === 'pass' ? 'bg-green-50' : 'bg-red-50'}">
                        <i class="fas ${icon}"></i>
                        <span class="text-sm font-medium">${result.test}</span>
                        <span class="text-xs text-gray-600">${result.message}</span>
                    </div>
                `;
                
                actualHtml += `
                    <div class="flex items-center space-x-2">
                        <i class="fas ${icon}"></i>
                        <span class="text-sm text-gray-700">${result.test}</span>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            actualResultsDiv.innerHTML = actualHtml;
        }
        
        async function seedDatabase() {
            if (window.seedClientsAndLeads) {
                try {
                    const result = await window.seedClientsAndLeads();
                    if (result.success) {
                        alert('✅ Database seeded successfully!');
                        checkCurrentData();
                    } else {
                        alert('❌ Database seeding failed: ' + result.error);
                    }
                } catch (error) {
                    alert('❌ Database seeding error: ' + error.message);
                }
            } else {
                alert('❌ Seeding function not available');
            }
        }
        
        function clearCache() {
            localStorage.clear();
            alert('✅ Cache cleared! Refresh the page to see changes.');
        }
        
        function checkCurrentData() {
            // Check localStorage
            const clients = JSON.parse(localStorage.getItem('abcotronics_clients') || '[]');
            const leads = JSON.parse(localStorage.getItem('abcotronics_leads') || '[]');
            
            document.getElementById('clientsData').innerHTML = `
                <div>Count: ${clients.length}</div>
                <div class="text-xs mt-1">${clients.map(c => c.name).join(', ') || 'None'}</div>
            `;
            
            document.getElementById('leadsData').innerHTML = `
                <div>Count: ${leads.length}</div>
                <div class="text-xs mt-1">${leads.map(l => l.name).join(', ') || 'None'}</div>
            `;
            
            // Check database
            if (window.DatabaseAPI) {
                window.DatabaseAPI.getClients().then(response => {
                    const allClients = response?.data?.clients || [];
                    const dbClients = allClients.filter(c => c.type === 'client' || !c.type);
                    const dbLeads = allClients.filter(c => c.type === 'lead');
                    
                    document.getElementById('databaseData').innerHTML = `
                        <div>Total: ${allClients.length}</div>
                        <div class="text-xs mt-1">Clients: ${dbClients.length}, Leads: ${dbLeads.length}</div>
                    `;
                }).catch(error => {
                    document.getElementById('databaseData').innerHTML = `
                        <div class="text-red-600">Error: ${error.message}</div>
                    `;
                });
            } else {
                document.getElementById('databaseData').innerHTML = `
                    <div class="text-gray-500">DatabaseAPI not available</div>
                `;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkCurrentData();
        });
    </script>
</body>
</html>