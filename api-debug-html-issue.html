<!DOCTYPE html>
<html>
<head>
    <title>API Debug - HTML Response Issue</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; padding: 15px; margin: 10px 0; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin: 10px 0; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; margin: 10px 0; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        button.warning { background: #ffc107; color: black; }
        button.warning:hover { background: #e0a800; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .url-test { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üîç API Debug - HTML Response Issue</h1>
    
    <div class="warning">
        <h3>‚ö†Ô∏è Issue: "Unexpected token '<'" Error</h3>
        <p>The frontend is receiving HTML instead of JSON from API calls. This usually means:</p>
        <ul>
            <li>API endpoint doesn't exist (404 HTML page)</li>
            <li>Server error (500 HTML page)</li>
            <li>Authentication redirect (login HTML page)</li>
            <li>Wrong URL being called</li>
        </ul>
    </div>
    
    <div class="info">
        <h3>üß™ Debug Tests</h3>
        <p>Let's test each possible cause:</p>
    </div>
    
    <button onclick="testDirectAPI()">Test Direct API Call</button>
    <button onclick="testWithAuth()">Test With Authentication</button>
    <button onclick="testFrontendAPI()">Test Frontend API</button>
    <button onclick="checkURLs()">Check All URLs</button>
    <button onclick="clearCache()" class="warning">Clear Auth Cache</button>
    
    <div id="results"></div>
    
    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        async function testDirectAPI() {
            addResult('üß™ Testing direct API call to /api/clients...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/clients');
                const text = await response.text();
                
                addResult(`üìä Response Status: ${response.status}`, 'info');
                addResult(`üìä Response Headers: ${response.headers.get('content-type')}`, 'info');
                addResult(`üìä Response Length: ${text.length} characters`, 'info');
                
                if (text.trim().startsWith('<')) {
                    addResult('‚ùå CONFIRMED: Server is returning HTML!', 'error');
                    addResult(`üìÑ HTML Preview: ${text.substring(0, 200)}...`, 'error');
                } else {
                    addResult('‚úÖ Server is returning JSON/text', 'success');
                    addResult(`üìÑ Response Preview: ${text.substring(0, 200)}...`, 'info');
                }
                
            } catch (error) {
                addResult(`‚ùå Direct API call failed: ${error.message}`, 'error');
            }
        }
        
        async function testWithAuth() {
            addResult('üß™ Testing API call with authentication...', 'info');
            
            try {
                // Get token from localStorage
                const token = localStorage.getItem('abcotronics_token');
                addResult(`üîë Token found: ${token ? 'Yes' : 'No'}`, token ? 'success' : 'warning');
                
                if (!token) {
                    addResult('‚ùå No authentication token found', 'error');
                    return;
                }
                
                const response = await fetch('http://localhost:3000/api/clients', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const text = await response.text();
                
                addResult(`üìä Authenticated Response Status: ${response.status}`, 'info');
                addResult(`üìä Response Headers: ${response.headers.get('content-type')}`, 'info');
                
                if (text.trim().startsWith('<')) {
                    addResult('‚ùå Still getting HTML with auth!', 'error');
                    addResult(`üìÑ HTML Preview: ${text.substring(0, 200)}...`, 'error');
                } else {
                    addResult('‚úÖ Getting JSON with auth', 'success');
                    addResult(`üìÑ Response Preview: ${text.substring(0, 200)}...`, 'info');
                }
                
            } catch (error) {
                addResult(`‚ùå Authenticated API call failed: ${error.message}`, 'error');
            }
        }
        
        async function testFrontendAPI() {
            addResult('üß™ Testing frontend API utility...', 'info');
            
            try {
                // Wait for API to load
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (!window.api?.listClients) {
                    addResult('‚ùå listClients function not available', 'error');
                    return;
                }
                
                addResult('üì§ Calling window.api.listClients()...', 'info');
                const response = await window.api.listClients();
                
                addResult('‚úÖ Frontend API call succeeded!', 'success');
                addResult(`üìä Response: ${JSON.stringify(response, null, 2)}`, 'info');
                
            } catch (error) {
                addResult(`‚ùå Frontend API call failed: ${error.message}`, 'error');
                
                // Check if it's the HTML parsing error
                if (error.message.includes("Unexpected token '<'")) {
                    addResult('üîç This is the HTML parsing error we need to fix!', 'error');
                }
            }
        }
        
        function checkURLs() {
            addResult('üîç Checking all relevant URLs...', 'info');
            
            const urls = [
                'http://localhost:3000/api/health',
                'http://localhost:3000/api/clients',
                'http://localhost:3000/api/me',
                'http://localhost:8000/api/clients',  // Wrong port
                'http://localhost:8000/api/health'    // Wrong port
            ];
            
            urls.forEach(url => {
                addResult(`üìã Testing: ${url}`, 'info');
                
                fetch(url)
                    .then(response => response.text())
                    .then(text => {
                        if (text.trim().startsWith('<')) {
                            addResult(`‚ùå ${url} returns HTML`, 'error');
                        } else {
                            addResult(`‚úÖ ${url} returns JSON/text`, 'success');
                        }
                    })
                    .catch(error => {
                        addResult(`‚ùå ${url} failed: ${error.message}`, 'error');
                    });
            });
        }
        
        function clearCache() {
            addResult('üßπ Clearing authentication cache...', 'info');
            
            localStorage.removeItem('abcotronics_token');
            localStorage.removeItem('abcotronics_user');
            
            addResult('‚úÖ Cache cleared', 'success');
            addResult('üí° Try logging in again', 'info');
        }
        
        // Auto-run tests on page load
        window.addEventListener('load', () => {
            addResult('üîß API Debug Tool Loaded', 'info');
            addResult('üí° Let\'s find out why the API is returning HTML instead of JSON', 'info');
            
            // Auto-run direct API test
            setTimeout(() => {
                testDirectAPI();
            }, 1000);
        });
        
        // Load the API utilities for testing
        const script1 = document.createElement('script');
        script1.src = '/src/utils/api.js';
        document.head.appendChild(script1);
        
        const script2 = document.createElement('script');
        script2.src = '/src/utils/authStorage.js';
        document.head.appendChild(script2);
    </script>
</body>
</html>
