<!DOCTYPE html>
<html>
<head>
    <title>Authentication Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; padding: 15px; margin: 10px 0; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin: 10px 0; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; padding: 15px; margin: 10px 0; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        button.warning { background: #ffc107; color: black; }
        button.warning:hover { background: #e0a800; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîê Authentication Fix</h1>
    
    <div class="warning">
        <h3>‚ö†Ô∏è Issue: Refresh Token 401 Error</h3>
        <p>The refresh token endpoint is returning 401 Unauthorized. This usually means:</p>
        <ul>
            <li>No refresh token cookie is set</li>
            <li>Refresh token cookie has expired</li>
            <li>Cookie is not being sent with the request</li>
            <li>Login didn't properly set the refresh token cookie</li>
        </ul>
    </div>
    
    <div class="info">
        <h3>üîß Fix Steps</h3>
        <p>Let's fix the authentication flow step by step:</p>
    </div>
    
    <button onclick="clearAllAuth()" class="warning">Clear All Auth Data</button>
    <button onclick="testLogin()" class="success">Test Login</button>
    <button onclick="testRefresh()">Test Refresh</button>
    <button onclick="checkCookies()">Check Cookies</button>
    <button onclick="testAPI()">Test API Call</button>
    
    <div id="results"></div>
    
    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        function clearAllAuth() {
            addResult('üßπ Clearing all authentication data...', 'info');
            
            // Clear localStorage
            localStorage.removeItem('abcotronics_token');
            localStorage.removeItem('abcotronics_user');
            
            // Clear all cookies
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            
            addResult('‚úÖ All auth data cleared', 'success');
            addResult('üí° Now try logging in again', 'info');
        }
        
        async function testLogin() {
            addResult('üîê Testing login process...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Important: include cookies
                    body: JSON.stringify({
                        email: 'admin@abcotronics.com',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                
                addResult(`üìä Login Response Status: ${response.status}`, response.status === 200 ? 'success' : 'error');
                addResult(`üìä Response: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (response.status === 200 && data.accessToken) {
                    addResult('‚úÖ Login successful!', 'success');
                    
                    // Store access token
                    localStorage.setItem('abcotronics_token', data.accessToken);
                    addResult('üíæ Access token stored', 'success');
                    
                    // Check if refresh token cookie was set
                    setTimeout(() => {
                        checkCookies();
                    }, 1000);
                    
                } else {
                    addResult(`‚ùå Login failed: ${data.error?.message || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Login error: ${error.message}`, 'error');
            }
        }
        
        function checkCookies() {
            addResult('üç™ Checking cookies...', 'info');
            
            const cookies = document.cookie;
            addResult(`üìä All cookies: ${cookies || 'None'}`, 'info');
            
            if (cookies.includes('refreshToken')) {
                addResult('‚úÖ Refresh token cookie found!', 'success');
            } else {
                addResult('‚ùå No refresh token cookie found', 'error');
                addResult('üí° This is likely the cause of the 401 error', 'warning');
            }
            
            // Check localStorage
            const token = localStorage.getItem('abcotronics_token');
            addResult(`üîë Access token in localStorage: ${token ? 'Present' : 'Missing'}`, token ? 'success' : 'error');
        }
        
        async function testRefresh() {
            addResult('üîÑ Testing refresh token...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/auth/refresh', {
                    method: 'POST',
                    credentials: 'include' // Important: include cookies
                });
                
                const data = await response.json();
                
                addResult(`üìä Refresh Response Status: ${response.status}`, response.status === 200 ? 'success' : 'error');
                addResult(`üìä Response: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (response.status === 200) {
                    addResult('‚úÖ Refresh successful!', 'success');
                } else {
                    addResult(`‚ùå Refresh failed: ${data.error?.message || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Refresh error: ${error.message}`, 'error');
            }
        }
        
        async function testAPI() {
            addResult('üåê Testing API call with authentication...', 'info');
            
            const token = localStorage.getItem('abcotronics_token');
            if (!token) {
                addResult('‚ùå No access token found. Please login first.', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/api/clients', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                addResult(`üìä API Response Status: ${response.status}`, response.status === 200 ? 'success' : 'error');
                addResult(`üìä Response: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (response.status === 200) {
                    addResult('‚úÖ API call successful!', 'success');
                } else {
                    addResult(`‚ùå API call failed: ${data.error?.message || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå API error: ${error.message}`, 'error');
            }
        }
        
        // Auto-run on page load
        window.addEventListener('load', () => {
            addResult('üîß Authentication Fix Tool Loaded', 'info');
            addResult('üí° Let\'s fix the refresh token issue', 'info');
            
            setTimeout(() => {
                checkCookies();
            }, 1000);
        });
    </script>
</body>
</html>
