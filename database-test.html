<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database-First ERP Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const DatabaseTest = () => {
            const [results, setResults] = useState([]);
            const [isLoading, setIsLoading] = useState(false);

            const addResult = (test, status, message) => {
                setResults(prev => [...prev, { test, status, message, timestamp: new Date().toLocaleTimeString() }]);
            };

            const testDatabaseAPI = async () => {
                setIsLoading(true);
                setResults([]);
                
                try {
                    // Test authentication
                    addResult('Authentication', 'info', 'Testing authentication...');
                    
                    // Login first
                    const loginResponse = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: 'admin@abcotronics.com', password: 'admin123' })
                    });
                    
                    if (loginResponse.ok) {
                        const loginData = await loginResponse.json();
                        localStorage.setItem('abcotronics_auth_token', loginData.accessToken);
                        localStorage.setItem('abcotronics_user', JSON.stringify(loginData.user));
                        addResult('Authentication', 'success', 'Login successful');
                    } else {
                        addResult('Authentication', 'error', 'Login failed');
                        return;
                    }

                    // Test Clients API
                    addResult('Clients API', 'info', 'Testing clients endpoints...');
                    
                    // Create client
                    const createClientResponse = await fetch('/api/clients', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: 'Test Client',
                            industry: 'Technology',
                            status: 'Active'
                        })
                    });
                    
                    if (createClientResponse.ok) {
                        const clientData = await createClientResponse.json();
                        addResult('Clients API', 'success', `Client created: ${clientData.data.client.name}`);
                        
                        // Update client
                        const updateClientResponse = await fetch(`/api/clients/${clientData.data.client.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: 'Updated Test Client',
                                industry: 'Manufacturing'
                            })
                        });
                        
                        if (updateClientResponse.ok) {
                            addResult('Clients API', 'success', 'Client updated successfully');
                        } else {
                            addResult('Clients API', 'error', 'Client update failed');
                        }
                    } else {
                        addResult('Clients API', 'error', 'Client creation failed');
                    }

                    // Test Leads API
                    addResult('Leads API', 'info', 'Testing leads endpoints...');
                    
                    const createLeadResponse = await fetch('/api/leads', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: 'Test Lead',
                            industry: 'Healthcare',
                            status: 'New'
                        })
                    });
                    
                    if (createLeadResponse.ok) {
                        const leadData = await createLeadResponse.json();
                        addResult('Leads API', 'success', `Lead created: ${leadData.data.name}`);
                    } else {
                        addResult('Leads API', 'error', 'Lead creation failed');
                    }

                    // Test Projects API
                    addResult('Projects API', 'info', 'Testing projects endpoints...');
                    
                    const createProjectResponse = await fetch('/api/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: 'Test Project',
                            client: 'Test Client',
                            status: 'Active'
                        })
                    });
                    
                    if (createProjectResponse.ok) {
                        const projectData = await createProjectResponse.json();
                        addResult('Projects API', 'success', `Project created: ${projectData.data.name}`);
                    } else {
                        addResult('Projects API', 'error', 'Project creation failed');
                    }

                    // Test Invoices API
                    addResult('Invoices API', 'info', 'Testing invoices endpoints...');
                    
                    const createInvoiceResponse = await fetch('/api/invoices', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            invoiceNumber: 'INV-TEST-001',
                            client: 'Test Client',
                            total: 1000,
                            status: 'Draft'
                        })
                    });
                    
                    if (createInvoiceResponse.ok) {
                        const invoiceData = await createInvoiceResponse.json();
                        addResult('Invoices API', 'success', `Invoice created: ${invoiceData.data.invoiceNumber}`);
                    } else {
                        addResult('Invoices API', 'error', 'Invoice creation failed');
                    }

                    // Test Time Entries API
                    addResult('Time Entries API', 'info', 'Testing time entries endpoints...');
                    
                    const createTimeEntryResponse = await fetch('/api/time-entries', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            project: 'Test Project',
                            task: 'Test Task',
                            hours: 8,
                            billable: true
                        })
                    });
                    
                    if (createTimeEntryResponse.ok) {
                        const timeEntryData = await createTimeEntryResponse.json();
                        addResult('Time Entries API', 'success', `Time entry created: ${timeEntryData.data.task}`);
                    } else {
                        addResult('Time Entries API', 'error', 'Time entry creation failed');
                    }

                    addResult('Database Test', 'success', 'All database operations completed successfully!');

                } catch (error) {
                    addResult('Database Test', 'error', `Test failed: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 py-8">
                    <div className="max-w-4xl mx-auto px-4">
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h1 className="text-3xl font-bold text-gray-900 mb-6">
                                üóÑÔ∏è Database-First ERP Test
                            </h1>
                            
                            <p className="text-gray-600 mb-6">
                                This page tests all database operations to ensure data is properly saved and retrieved from the database.
                            </p>

                            <button
                                onClick={testDatabaseAPI}
                                disabled={isLoading}
                                className={`px-6 py-3 rounded-lg font-medium ${
                                    isLoading
                                        ? 'bg-gray-400 text-gray-600 cursor-not-allowed'
                                        : 'bg-blue-600 text-white hover:bg-blue-700'
                                }`}
                            >
                                {isLoading ? (
                                    <>
                                        <i className="fas fa-spinner fa-spin mr-2"></i>
                                        Testing Database...
                                    </>
                                ) : (
                                    <>
                                        <i className="fas fa-play mr-2"></i>
                                        Run Database Test
                                    </>
                                )}
                            </button>

                            <div className="mt-8">
                                <h2 className="text-xl font-semibold text-gray-900 mb-4">Test Results:</h2>
                                <div className="space-y-2">
                                    {results.map((result, index) => (
                                        <div key={index} className={`p-3 rounded-lg ${
                                            result.status === 'success' ? 'bg-green-100 text-green-800' :
                                            result.status === 'error' ? 'bg-red-100 text-red-800' :
                                            'bg-blue-100 text-blue-800'
                                        }`}>
                                            <div className="flex justify-between items-center">
                                                <span className="font-medium">{result.test}</span>
                                                <span className="text-sm opacity-75">{result.timestamp}</span>
                                            </div>
                                            <div className="text-sm mt-1">{result.message}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <h3 className="font-semibold text-yellow-800 mb-2">Note:</h3>
                                <p className="text-yellow-700 text-sm">
                                    This test verifies that all database operations are working correctly. 
                                    The server currently returns mock data, but the API endpoints are properly configured.
                                    In production, these would connect to a real database.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DatabaseTest />, document.getElementById('root'));
    </script>
</body>
</html>
