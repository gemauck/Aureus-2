<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Status Debug Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .debug-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 2px solid #ddd;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        select {
            padding: 8px;
            margin: 10px 0;
            width: 100%;
            font-size: 16px;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .console-line {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4a90e2;
        }
        .console-error {
            border-left-color: #e74c3c;
            color: #ff6b6b;
        }
        .console-success {
            border-left-color: #2ecc71;
            color: #2ecc71;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .status-display {
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            background: white;
            border: 2px solid #333;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîç Lead Status Debug Test</h1>
    <p>This will help diagnose why Status isn't saving</p>

    <div class="debug-section">
        <h2>Step 1: Check localStorage</h2>
        <button onclick="checkLocalStorage()">Check localStorage</button>
        <div id="localStorage-result"></div>
    </div>

    <div class="debug-section">
        <h2>Step 2: Create Test Lead</h2>
        <button onclick="createTestLead()">Create Test Lead</button>
        <div id="create-result"></div>
    </div>

    <div class="debug-section">
        <h2>Step 3: Test Status Change</h2>
        <p>Current Status: <span id="current-status" class="status-display">Not loaded</span></p>
        
        <label><strong>Change Status:</strong></label>
        <select id="status-select" onchange="changeStatus()">
            <option value="">-- Select Status --</option>
            <option value="Potential">Potential</option>
            <option value="Active">Active</option>
            <option value="Disinterested">Disinterested</option>
        </select>
        
        <div id="status-change-result"></div>
    </div>

    <div class="debug-section">
        <h2>Step 4: Verify Save</h2>
        <button onclick="verifyStatus()">Verify Status Saved</button>
        <div id="verify-result"></div>
    </div>

    <div class="debug-section">
        <h2>Console Output</h2>
        <div id="console-output" class="console-output">
            <div class="console-line">Waiting for actions...</div>
        </div>
    </div>

    <div class="debug-section">
        <h2>Quick Fix Actions</h2>
        <button onclick="clearAllData()">Clear All Data</button>
        <button onclick="reloadPage()">Reload Page</button>
        <button onclick="exportData()">Export Data</button>
    </div>

    <script>
        let testLeadId = null;
        
        function log(message, type = 'info') {
            const output = document.getElementById('console-output');
            const line = document.createElement('div');
            line.className = 'console-line';
            
            if (type === 'error') {
                line.className += ' console-error';
            } else if (type === 'success') {
                line.className += ' console-success';
            }
            
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
            
            console.log(message);
        }

        function checkLocalStorage() {
            log('Checking localStorage...');
            const result = document.getElementById('localStorage-result');
            
            try {
                const leads = localStorage.getItem('leads');
                const clients = localStorage.getItem('clients');
                const projects = localStorage.getItem('projects');
                
                let html = '<h3>LocalStorage Contents:</h3>';
                
                if (leads) {
                    const leadsArray = JSON.parse(leads);
                    html += `<p><strong>Leads:</strong> ${leadsArray.length} found</p>`;
                    html += '<pre style="background: white; padding: 10px; overflow-x: auto;">' + 
                            JSON.stringify(leadsArray, null, 2) + '</pre>';
                    log(`‚úì Found ${leadsArray.length} leads in localStorage`, 'success');
                } else {
                    html += '<p><strong>Leads:</strong> None found</p>';
                    log('‚ö† No leads found in localStorage', 'error');
                }
                
                if (clients) {
                    const clientsArray = JSON.parse(clients);
                    html += `<p><strong>Clients:</strong> ${clientsArray.length} found</p>`;
                }
                
                if (projects) {
                    const projectsArray = JSON.parse(projects);
                    html += `<p><strong>Projects:</strong> ${projectsArray.length} found</p>`;
                }
                
                result.innerHTML = html;
                result.className = 'debug-section success';
            } catch (error) {
                result.innerHTML = `<p>Error: ${error.message}</p>`;
                result.className = 'debug-section error';
                log(`‚úó Error checking localStorage: ${error.message}`, 'error');
            }
        }

        function createTestLead() {
            log('Creating test lead...');
            const result = document.getElementById('create-result');
            
            try {
                let leads = localStorage.getItem('leads');
                leads = leads ? JSON.parse(leads) : [];
                
                testLeadId = 'test-' + Date.now();
                const testLead = {
                    id: testLeadId,
                    name: 'Test Lead - Status Debug',
                    status: 'Potential',
                    stage: 'Awareness',
                    industry: 'Testing',
                    source: 'Debug',
                    notes: 'Created for status testing',
                    contacts: [],
                    followUps: [],
                    projectIds: [],
                    comments: [],
                    activityLog: [],
                    createdAt: new Date().toISOString()
                };
                
                leads.push(testLead);
                localStorage.setItem('leads', JSON.stringify(leads));
                
                result.innerHTML = `
                    <p class="success">‚úì Test lead created!</p>
                    <p><strong>ID:</strong> ${testLeadId}</p>
                    <p><strong>Status:</strong> ${testLead.status}</p>
                `;
                result.className = 'debug-section success';
                
                document.getElementById('current-status').textContent = testLead.status;
                
                log(`‚úì Test lead created with ID: ${testLeadId}`, 'success');
                log(`  Initial status: ${testLead.status}`);
            } catch (error) {
                result.innerHTML = `<p class="error">‚úó Error: ${error.message}</p>`;
                result.className = 'debug-section error';
                log(`‚úó Error creating test lead: ${error.message}`, 'error');
            }
        }

        function changeStatus() {
            const select = document.getElementById('status-select');
            const newStatus = select.value;
            
            if (!newStatus) {
                log('‚ö† No status selected');
                return;
            }
            
            if (!testLeadId) {
                alert('Please create a test lead first!');
                log('‚úó No test lead ID found', 'error');
                return;
            }
            
            log(`Changing status to: ${newStatus}`);
            const result = document.getElementById('status-change-result');
            
            try {
                // Step 1: Load leads
                let leads = localStorage.getItem('leads');
                if (!leads) {
                    throw new Error('No leads found in localStorage');
                }
                
                leads = JSON.parse(leads);
                log(`  Loaded ${leads.length} leads from localStorage`);
                
                // Step 2: Find the test lead
                const leadIndex = leads.findIndex(l => l.id === testLeadId);
                if (leadIndex === -1) {
                    throw new Error('Test lead not found');
                }
                
                const oldStatus = leads[leadIndex].status;
                log(`  Found test lead at index ${leadIndex}, current status: ${oldStatus}`);
                
                // Step 3: Update the status
                leads[leadIndex].status = newStatus;
                leads[leadIndex].updatedAt = new Date().toISOString();
                log(`  Updated status from "${oldStatus}" to "${newStatus}"`);
                
                // Step 4: Save back to localStorage
                localStorage.setItem('leads', JSON.stringify(leads));
                log('  Saved to localStorage');
                
                // Step 5: Verify it saved
                const savedLeads = JSON.parse(localStorage.getItem('leads'));
                const savedLead = savedLeads.find(l => l.id === testLeadId);
                
                if (savedLead.status === newStatus) {
                    result.innerHTML = `
                        <p class="success">‚úì Status changed successfully!</p>
                        <p><strong>Old Status:</strong> ${oldStatus}</p>
                        <p><strong>New Status:</strong> ${newStatus}</p>
                        <p><strong>Verified:</strong> ‚úì Saved correctly</p>
                    `;
                    result.className = 'debug-section success';
                    document.getElementById('current-status').textContent = newStatus;
                    log(`‚úì Status change verified! Now: ${newStatus}`, 'success');
                } else {
                    throw new Error(`Verification failed! Expected ${newStatus}, got ${savedLead.status}`);
                }
                
            } catch (error) {
                result.innerHTML = `<p class="error">‚úó Error: ${error.message}</p>`;
                result.className = 'debug-section error';
                log(`‚úó Error changing status: ${error.message}`, 'error');
            }
        }

        function verifyStatus() {
            log('Verifying status...');
            const result = document.getElementById('verify-result');
            
            if (!testLeadId) {
                result.innerHTML = '<p class="error">No test lead ID. Create a test lead first!</p>';
                result.className = 'debug-section error';
                return;
            }
            
            try {
                const leads = JSON.parse(localStorage.getItem('leads'));
                const lead = leads.find(l => l.id === testLeadId);
                
                if (!lead) {
                    throw new Error('Test lead not found');
                }
                
                result.innerHTML = `
                    <p class="success">‚úì Lead found in localStorage</p>
                    <p><strong>Current Status:</strong> ${lead.status}</p>
                    <p><strong>Stage:</strong> ${lead.stage}</p>
                    <p><strong>Last Updated:</strong> ${lead.updatedAt || 'Not set'}</p>
                    <pre style="background: white; padding: 10px;">${JSON.stringify(lead, null, 2)}</pre>
                `;
                result.className = 'debug-section success';
                document.getElementById('current-status').textContent = lead.status;
                log(`‚úì Verified: Status is "${lead.status}"`, 'success');
            } catch (error) {
                result.innerHTML = `<p class="error">‚úó Error: ${error.message}</p>`;
                result.className = 'debug-section error';
                log(`‚úó Verification error: ${error.message}`, 'error');
            }
        }

        function clearAllData() {
            if (confirm('Clear all localStorage data? This will delete all leads, clients, and projects.')) {
                localStorage.clear();
                log('‚úì All localStorage data cleared', 'success');
                alert('All data cleared! Reload the page.');
            }
        }

        function reloadPage() {
            location.reload();
        }

        function exportData() {
            const data = {
                leads: JSON.parse(localStorage.getItem('leads') || '[]'),
                clients: JSON.parse(localStorage.getItem('clients') || '[]'),
                projects: JSON.parse(localStorage.getItem('projects') || '[]')
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'erp-backup-' + Date.now() + '.json';
            a.click();
            
            log('‚úì Data exported to JSON file', 'success');
        }

        // Auto-check localStorage on load
        window.onload = function() {
            log('Debug page loaded');
            log('Ready to test status changes');
            checkLocalStorage();
        };
    </script>
</body>
</html>
