<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Consistency Test Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Client Consistency Test Results</h1>
        
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-blue-900 mb-4 flex items-center">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                Test Execution Summary
            </h2>
            <div id="testSummary" class="text-blue-800">
                <div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Running tests...</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Test Results -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-clipboard-check text-green-600 mr-2"></i>
                    Test Results
                </h2>
                <div id="testResults" class="space-y-3">
                    <div class="text-gray-500 italic">Running tests...</div>
                </div>
            </div>

            <!-- Current Data Status -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-database text-purple-600 mr-2"></i>
                    Current Data Status
                </h2>
                <div id="dataStatus" class="space-y-3">
                    <div class="text-gray-500 italic">Checking data...</div>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis -->
        <div class="mt-8 bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-microscope text-orange-600 mr-2"></i>
                Detailed Analysis
            </h2>
            <div id="detailedAnalysis" class="space-y-4">
                <div class="text-gray-500 italic">Analyzing results...</div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="mt-8 bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>
                Recommendations
            </h2>
            <div id="recommendations" class="space-y-3">
                <div class="text-gray-500 italic">Generating recommendations...</div>
            </div>
        </div>
    </div>

    <script>
        // Test execution
        async function runTests() {
            console.log('üß™ Starting comprehensive client consistency tests...');
            
            const results = {
                rgnLeadTest: await testRGNLead(),
                exxaroClientTest: await testExxaroClient(),
                dataConsistencyTest: await testDataConsistency(),
                userConsistencyTest: await testUserConsistency(),
                dashboardTest: await testDashboardConsistency()
            };
            
            displayResults(results);
            return results;
        }
        
        async function testRGNLead() {
            try {
                console.log('üîç Testing RGN Lead...');
                
                // Check localStorage
                const leads = JSON.parse(localStorage.getItem('abcotronics_leads') || '[]');
                const rgnInLeads = leads.find(l => l.name === 'RGN');
                
                // Check if DatabaseAPI is available
                let rgnInDatabase = null;
                if (window.DatabaseAPI) {
                    try {
                        const response = await window.DatabaseAPI.getClients();
                        const allClients = response?.data?.clients || [];
                        rgnInDatabase = allClients.find(c => c.name === 'RGN' && c.type === 'lead');
                    } catch (error) {
                        console.warn('DatabaseAPI error:', error);
                    }
                }
                
                const success = rgnInLeads || rgnInDatabase;
                
                return {
                    test: 'RGN Lead Check',
                    success: success,
                    details: {
                        inLocalStorage: !!rgnInLeads,
                        inDatabase: !!rgnInDatabase,
                        localStorageData: rgnInLeads,
                        databaseData: rgnInDatabase
                    },
                    message: success ? 
                        '‚úÖ RGN found as lead' : 
                        '‚ùå RGN not found as lead'
                };
            } catch (error) {
                return {
                    test: 'RGN Lead Check',
                    success: false,
                    error: error.message,
                    message: '‚ùå Error testing RGN lead'
                };
            }
        }
        
        async function testExxaroClient() {
            try {
                console.log('üîç Testing Exxaro Client...');
                
                // Check localStorage
                const clients = JSON.parse(localStorage.getItem('abcotronics_clients') || '[]');
                const exxaroInClients = clients.find(c => c.name === 'Exxaro');
                
                // Check if DatabaseAPI is available
                let exxaroInDatabase = null;
                if (window.DatabaseAPI) {
                    try {
                        const response = await window.DatabaseAPI.getClients();
                        const allClients = response?.data?.clients || [];
                        exxaroInDatabase = allClients.find(c => c.name === 'Exxaro' && c.type === 'client');
                    } catch (error) {
                        console.warn('DatabaseAPI error:', error);
                    }
                }
                
                const success = exxaroInClients || exxaroInDatabase;
                
                return {
                    test: 'Exxaro Client Check',
                    success: success,
                    details: {
                        inLocalStorage: !!exxaroInClients,
                        inDatabase: !!exxaroInDatabase,
                        localStorageData: exxaroInClients,
                        databaseData: exxaroInDatabase
                    },
                    message: success ? 
                        '‚úÖ Exxaro found as client' : 
                        '‚ùå Exxaro not found as client'
                };
            } catch (error) {
                return {
                    test: 'Exxaro Client Check',
                    success: false,
                    error: error.message,
                    message: '‚ùå Error testing Exxaro client'
                };
            }
        }
        
        async function testDataConsistency() {
            try {
                console.log('üîç Testing Data Consistency...');
                
                const clients = JSON.parse(localStorage.getItem('abcotronics_clients') || '[]');
                const leads = JSON.parse(localStorage.getItem('abcotronics_leads') || '[]');
                
                // Check if we have both RGN and Exxaro
                const hasRGN = leads.some(l => l.name === 'RGN');
                const hasExxaro = clients.some(c => c.name === 'Exxaro');
                
                const success = hasRGN && hasExxaro;
                
                return {
                    test: 'Data Consistency',
                    success: success,
                    details: {
                        clientsCount: clients.length,
                        leadsCount: leads.length,
                        hasRGN: hasRGN,
                        hasExxaro: hasExxaro,
                        clientNames: clients.map(c => c.name),
                        leadNames: leads.map(l => l.name)
                    },
                    message: success ? 
                        '‚úÖ Data consistency verified' : 
                        '‚ùå Data inconsistency detected'
                };
            } catch (error) {
                return {
                    test: 'Data Consistency',
                    success: false,
                    error: error.message,
                    message: '‚ùå Error testing data consistency'
                };
            }
        }
        
        async function testUserConsistency() {
            try {
                console.log('üîç Testing User Consistency...');
                
                // Check if we have authentication
                const token = localStorage.getItem('abcotronics_token');
                const user = JSON.parse(localStorage.getItem('abcotronics_user') || 'null');
                
                // Check if DatabaseAPI is available (indicates proper setup)
                const hasDatabaseAPI = !!window.DatabaseAPI;
                
                const success = token && user && hasDatabaseAPI;
                
                return {
                    test: 'User Consistency',
                    success: success,
                    details: {
                        hasToken: !!token,
                        hasUser: !!user,
                        hasDatabaseAPI: hasDatabaseAPI,
                        userInfo: user
                    },
                    message: success ? 
                        '‚úÖ User authentication and API setup verified' : 
                        '‚ùå User authentication or API setup issues'
                };
            } catch (error) {
                return {
                    test: 'User Consistency',
                    success: false,
                    error: error.message,
                    message: '‚ùå Error testing user consistency'
                };
            }
        }
        
        async function testDashboardConsistency() {
            try {
                console.log('üîç Testing Dashboard Consistency...');
                
                // Check if dashboard components are available
                const hasDashboardLive = !!window.DashboardLive;
                const hasDashboardDatabaseFirst = !!window.DashboardDatabaseFirst;
                
                // Check if storage utilities are available
                const hasStorage = !!window.storage;
                
                const success = (hasDashboardLive || hasDashboardDatabaseFirst) && hasStorage;
                
                return {
                    test: 'Dashboard Consistency',
                    success: success,
                    details: {
                        hasDashboardLive: hasDashboardLive,
                        hasDashboardDatabaseFirst: hasDashboardDatabaseFirst,
                        hasStorage: hasStorage
                    },
                    message: success ? 
                        '‚úÖ Dashboard components available' : 
                        '‚ùå Dashboard components missing'
                };
            } catch (error) {
                return {
                    test: 'Dashboard Consistency',
                    success: false,
                    error: error.message,
                    message: '‚ùå Error testing dashboard consistency'
                };
            }
        }
        
        function displayResults(results) {
            // Update test summary
            const totalTests = Object.keys(results).length;
            const passedTests = Object.values(results).filter(r => r.success).length;
            const failedTests = totalTests - passedTests;
            
            document.getElementById('testSummary').innerHTML = `
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="bg-blue-100 rounded-lg p-3">
                        <div class="text-2xl font-bold text-blue-600">${totalTests}</div>
                        <div class="text-sm text-blue-800">Total Tests</div>
                    </div>
                    <div class="bg-green-100 rounded-lg p-3">
                        <div class="text-2xl font-bold text-green-600">${passedTests}</div>
                        <div class="text-sm text-green-800">Passed</div>
                    </div>
                    <div class="bg-red-100 rounded-lg p-3">
                        <div class="text-2xl font-bold text-red-600">${failedTests}</div>
                        <div class="text-sm text-red-800">Failed</div>
                    </div>
                </div>
            `;
            
            // Update test results
            let resultsHtml = '';
            Object.values(results).forEach(result => {
                const icon = result.success ? 'fa-check-circle text-green-600' : 'fa-times-circle text-red-600';
                const bgColor = result.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                
                resultsHtml += `
                    <div class="flex items-center space-x-3 p-3 rounded-lg border ${bgColor}">
                        <i class="fas ${icon}"></i>
                        <div class="flex-1">
                            <div class="font-medium">${result.test}</div>
                            <div class="text-sm text-gray-600">${result.message}</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('testResults').innerHTML = resultsHtml;
            
            // Update data status
            const rgnTest = results.rgnLeadTest;
            const exxaroTest = results.exxaroClientTest;
            const consistencyTest = results.dataConsistencyTest;
            
            document.getElementById('dataStatus').innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="text-sm font-medium">RGN Lead</span>
                        <span class="text-sm ${rgnTest.success ? 'text-green-600' : 'text-red-600'}">
                            ${rgnTest.success ? '‚úÖ Found' : '‚ùå Missing'}
                        </span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="text-sm font-medium">Exxaro Client</span>
                        <span class="text-sm ${exxaroTest.success ? 'text-green-600' : 'text-red-600'}">
                            ${exxaroTest.success ? '‚úÖ Found' : '‚ùå Missing'}
                        </span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="text-sm font-medium">Data Consistency</span>
                        <span class="text-sm ${consistencyTest.success ? 'text-green-600' : 'text-red-600'}">
                            ${consistencyTest.success ? '‚úÖ Consistent' : '‚ùå Inconsistent'}
                        </span>
                    </div>
                </div>
            `;
            
            // Update detailed analysis
            let analysisHtml = '';
            Object.values(results).forEach(result => {
                if (result.details) {
                    analysisHtml += `
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-2">${result.test}</h4>
                            <div class="text-sm text-gray-600">
                                <pre class="whitespace-pre-wrap">${JSON.stringify(result.details, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                }
            });
            document.getElementById('detailedAnalysis').innerHTML = analysisHtml;
            
            // Update recommendations
            let recommendationsHtml = '';
            if (failedTests > 0) {
                recommendationsHtml += `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="font-medium text-yellow-900 mb-2">‚ö†Ô∏è Issues Found</h4>
                        <ul class="text-sm text-yellow-800 space-y-1">
                `;
                
                Object.values(results).forEach(result => {
                    if (!result.success) {
                        recommendationsHtml += `<li>‚Ä¢ ${result.message}</li>`;
                    }
                });
                
                recommendationsHtml += `
                        </ul>
                    </div>
                `;
            }
            
            if (passedTests === totalTests) {
                recommendationsHtml += `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-medium text-green-900 mb-2">üéâ All Tests Passed!</h4>
                        <p class="text-sm text-green-800">
                            The client consistency fix is working correctly. All users should now see the same data with RGN as a lead and Exxaro as a client.
                        </p>
                    </div>
                `;
            }
            
            document.getElementById('recommendations').innerHTML = recommendationsHtml;
        }
        
        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', () => {
            runTests();
        });
    </script>
</body>
</html>
